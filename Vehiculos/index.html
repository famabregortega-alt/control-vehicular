<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Control Vehicular</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00E676" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Control Vehicular" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root{
      --bg-primary:#06110d;
      --bg-secondary:#0b1a14;
      --bg-card:#0f231b;

      --accent:#00E676;
      --accent-hover:#00C853;
      --accent-soft:#69F0AE;

      --text-primary:#ffffff;
      --text-secondary:#cfe7dc;

      --success:#00E676;
      --warning:#fbbf24;
      --danger:#ef4444;
      --border:rgba(255,255,255,0.14);
    }

    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,var(--bg-primary) 0%, #0f1629 100%);
      color:var(--text-primary);
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:'';
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0,230,118,0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0,230,118,0.03) 0%, transparent 50%);
      pointer-events:none;
      z-index:0;
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      padding:2rem;
      position:relative;
      z-index:1;
    }

    .header{
      text-align:center;
      margin-bottom:3rem;
      animation:fadeInDown .6s ease-out;
    }

    .header h1{
      font-family:'Space Mono',monospace;
      font-size:2.5rem;
      font-weight:700;
      background:linear-gradient(135deg,var(--accent) 0%, #00fff2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:.5rem;
      letter-spacing:-1px;
    }

    .header p{
      color:var(--text-secondary);
      font-size:1rem;
    }

    .main-nav{
      display:flex;
      gap:1rem;
      margin-bottom:2rem;
      flex-wrap:wrap;
      animation:fadeInUp .6s ease-out .1s backwards;
    }

    .nav-btn{
      flex:1;
      min-width:200px;
      padding:1rem 1.5rem;
      background:var(--bg-card);
      border:2px solid var(--border);
      color:var(--text-primary);
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      border-radius:12px;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }

    .nav-btn::before{
      content:'';
      position:absolute;
      top:0; left:-100%;
      width:100%; height:100%;
      background:linear-gradient(90deg, transparent, rgba(0,230,118,0.1), transparent);
      transition:left .5s ease;
    }

    .nav-btn:hover::before{ left:100%; }

    .nav-btn:hover{
      border-color:var(--accent);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,230,118,0.2);
    }

    .nav-btn.active{
      background:linear-gradient(135deg,var(--accent) 0%, #0099cc 100%);
      border-color:var(--accent);
      box-shadow:0 8px 25px rgba(0,230,118,0.3);
    }

    .section{ display:none; animation:fadeIn .4s ease-out; }
    .section.active{ display:block; }

    .card{
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:2rem;
      margin-bottom:2rem;
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      transition:transform .3s ease, box-shadow .3s ease;
    }

    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 30px rgba(0,230,118,0.15);
    }

    .card h2{
      font-family:'Space Mono',monospace;
      color:var(--accent);
      margin-bottom:1.5rem;
      font-size:1.5rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }

    .form-group{ margin-bottom:1.5rem; }

    .form-group label{
      display:block;
      margin-bottom:.5rem;
      color:var(--text-secondary);
      font-weight:500;
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select{
      width:100%;
      padding:.875rem 1rem;
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--text-primary);
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      transition:all .3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(0,230,118,0.1);
    }

    .form-group textarea{ resize:vertical; min-height:100px; }

    .btn{
      padding:.875rem 2rem;
      border:none;
      border-radius:8px;
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:all .3s ease;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--accent) 0%, #0099cc 100%);
      color:var(--text-primary);
      box-shadow:0 4px 15px rgba(0,230,118,0.3);
    }
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,230,118,0.4);
    }

    .btn-danger{
      background:linear-gradient(135deg,var(--danger) 0%, #dc2626 100%);
      color:var(--text-primary);
      box-shadow:0 4px 15px rgba(239,68,68,0.3);
    }
    .btn-danger:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(239,68,68,0.4);
    }

    .btn-soft{
      padding:.6rem 1rem;
      border-radius:999px;
      border:2px solid rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.08);
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
      white-space:nowrap;
    }
    .btn-soft:hover{
      transform:translateY(-1px);
      border-color:rgba(0,230,118,0.65);
      background:rgba(0,230,118,0.12);
    }

    .alert{
      padding:1rem 1.5rem;
      border-radius:8px;
      margin-bottom:1rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      font-weight:500;
      animation:slideInRight .4s ease-out;
    }
    .alert-warning{ background:rgba(245,158,11,0.1); border-left:4px solid var(--warning); color:var(--warning); }
    .alert-danger{ background:rgba(239,68,68,0.1); border-left:4px solid var(--danger); color:var(--danger); }
    .alert-success{ background:rgba(16,185,129,0.1); border-left:4px solid var(--success); color:var(--success); }

    .maintenance-list, .verification-list{
      display:flex;
      flex-direction:column;
      gap:1rem;
      margin-top:1rem;
    }

    .maintenance-item, .verification-item{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:8px;
      padding:1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:all .3s ease;
      gap:1rem;
    }

    .maintenance-item:hover, .verification-item:hover{
      border-color:var(--accent);
      transform:translateX(4px);
    }

    .item-info h4{ margin-bottom:.25rem; color:var(--text-primary); }
    .item-info p{ color:var(--text-secondary); font-size:.875rem; }

    .badge{
      padding:.25rem .75rem;
      border-radius:20px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
      display:inline-block;
    }
    .badge-success{ background:rgba(16,185,129,0.2); color:var(--success); }
    .badge-warning{ background:rgba(245,158,11,0.2); color:var(--warning); }
    .badge-danger{ background:rgba(239,68,68,0.2); color:var(--danger); }
    .badge-muted{ background:rgba(160,174,192,0.18); color:rgba(255,255,255,0.75); border:1px solid rgba(255,255,255,0.12); }

    .empty-state{
      text-align:center;
      padding:3rem 2rem;
      color:var(--text-secondary);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px,1fr));
      gap:1rem;
      margin-bottom:1.25rem;
    }

    .stat-card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.5rem;
      text-align:center;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }

    .stat-card::before{
      content:'';
      position:absolute;
      inset:-2px;
      background:radial-gradient(circle at 30% 30%, rgba(0,230,118,0.16), transparent 55%);
      opacity:.6;
      pointer-events:none;
    }

    .stat-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,230,118,0.15);
    }

    .stat-card .number{
      font-size:2rem;
      font-weight:700;
      font-family:'Space Mono', monospace;
      background:linear-gradient(135deg,var(--accent) 0%, #00fff2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      position:relative;
      z-index:1;
    }

    .stat-card .label{
      color:var(--text-secondary);
      font-size:.875rem;
      margin-top:.5rem;
      text-transform:uppercase;
      letter-spacing:.5px;
      position:relative;
      z-index:1;
    }

    /* ===== Dashboard visual ===== */
    .type-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-bottom:2rem;
    }
    .type-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1.25rem;
      display:flex;
      gap:1rem;
      align-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      transition:.2s ease;
      position:relative;
      overflow:hidden;
    }
    .type-card:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 14px 40px rgba(0,230,118,0.10), 0 14px 40px rgba(0,0,0,0.22);
    }
    .type-icon{
      width:56px; height:56px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.6rem;
      background:rgba(0,230,118,0.10);
      border:1px solid rgba(0,230,118,0.22);
      flex:0 0 56px;
    }
    .type-title{
      font-family:'Space Mono', monospace;
      font-weight:800;
      letter-spacing:.3px;
    }
    .type-metrics{
      margin-top:.35rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      color:rgba(255,255,255,0.85);
    }
    .pill{
      font-size:.75rem;
      font-weight:800;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
    }
    .pill.good{ border-color:rgba(16,185,129,0.35); background:rgba(16,185,129,0.10); color:var(--success); }
    .pill.warn{ border-color:rgba(245,158,11,0.35); background:rgba(245,158,11,0.10); color:var(--warning); }
    .pill.bad{ border-color:rgba(239,68,68,0.35); background:rgba(239,68,68,0.10); color:var(--danger); }

    .vehicle-progress-list{ display:flex; flex-direction:column; gap:1rem; }
    .vehicle-progress-item{
      background:var(--bg-secondary);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      transition:.2s ease;
    }
    .vehicle-progress-item:hover{
      border-color:rgba(0,230,118,0.45);
      transform:translateX(3px);
    }
    .vp-left{ display:flex; flex-direction:column; gap:.35rem; min-width:240px; }
    .vp-title{ font-weight:900; letter-spacing:.2px; }
    .vp-sub{ color:rgba(255,255,255,0.70); font-size:.9rem; }
    .vp-bar-wrap{ flex:1; min-width:220px; }
    .vp-bar{
      width:100%; height:10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .vp-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition:width .35s ease;
      background:linear-gradient(90deg, rgba(0,230,118,0.9), rgba(0,255,242,0.55));
    }
    .vp-fill.warn{ background:linear-gradient(90deg, rgba(245,158,11,0.95), rgba(245,158,11,0.40)); }
    .vp-fill.bad{ background:linear-gradient(90deg, rgba(239,68,68,0.95), rgba(239,68,68,0.35)); }
    .vp-fill.good{ background:linear-gradient(90deg, rgba(16,185,129,0.95), rgba(16,185,129,0.35)); }
    .vp-right{ text-align:right; min-width:160px; }
    .vp-days{ font-family:'Space Mono', monospace; font-weight:900; }
    .vp-date{ color:rgba(255,255,255,0.70); font-size:.9rem; margin-top:.25rem; }

    /* ===== Veh√≠culos (cards) ===== */
    .vehicles-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      margin-bottom:1rem;
    }

    .add-pill{
      padding:.65rem 1rem;
      border-radius:999px;
      border:2px solid rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.08);
      color:var(--accent);
      font-weight:800;
      cursor:pointer;
      transition:.2s ease;
      white-space:nowrap;
    }
    .add-pill:hover{
      transform:translateY(-1px);
      border-color:rgba(0,230,118,0.65);
      background:rgba(0,230,118,0.12);
    }

    .vehicle-list{ display:flex; flex-direction:column; gap:1rem; }
    .vehicle-row{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:22px;
      overflow:hidden;
      cursor:pointer;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .vehicle-row:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 14px 45px rgba(0,230,118,0.10), 0 14px 45px rgba(0,0,0,0.22);
    }
    .vehicle-row.selected{
      border-color:var(--accent);
      background:rgba(0,230,118,0.06);
    }
    .vehicle-row-top{
      display:grid;
      grid-template-columns:1fr 170px;
      gap:1rem;
      padding:1.25rem 1.25rem 1rem 1.25rem;
      align-items:center;
    }
    .vehicle-plate{
      font-size:1.9rem;
      font-weight:900;
      letter-spacing:1px;
    }

    /* Veh√≠culos: que resalte el nombre (solo en el m√≥dulo Veh√≠culos) */
    .vehicle-name-main{
      font-size:1.9rem;
      font-weight:900;
      letter-spacing:1px;
    }
    .vehicle-subtitle{
      margin-top:.35rem;
      color:rgba(255,255,255,0.72);
      font-size:.98rem;
      line-height:1.2rem;
    }
    .vehicle-subtitle .bullet{ opacity:.85; }
    .vehicle-carimg{
      width:170px; height:95px;
      border-radius:18px;
      background:
        radial-gradient(circle at 30% 30%, rgba(0,230,118,0.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .vehicle-carimg img{
      width:100%; height:100%;
      object-fit:contain;
      filter:drop-shadow(0 10px 14px rgba(0,0,0,0.25));
    }
    .vehicle-row-bottom{
      border-top:1px solid rgba(255,255,255,0.08);
      padding:.95rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }
    .status{ display:flex; align-items:flex-start; gap:.7rem; font-weight:900; }
    .status-text small{
      display:block;
      margin-top:.15rem;
      color:rgba(255,255,255,0.60);
      font-weight:700;
    }

    .dot{ width:10px; height:10px; border-radius:50%; margin-top:.35rem; }
    .dot.gray{ background:rgba(160,174,192,0.95); box-shadow:0 0 0 5px rgba(160,174,192,0.12); }
    .dot.success{ background:var(--success); box-shadow:0 0 0 5px rgba(16,185,129,0.12); }
    .dot.warning{ background:var(--warning); box-shadow:0 0 0 5px rgba(245,158,11,0.12); }
    .dot.danger{ background:var(--danger); box-shadow:0 0 0 5px rgba(239,68,68,0.12); }

    .row-actions{ display:flex; align-items:center; gap:.6rem; }
    .btn-mini{
      padding:.48rem .9rem;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.08);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
    }
    .btn-mini:hover{ transform:translateY(-1px); border-color:rgba(0,230,118,0.55); }
    .btn-mini.danger{ border-color:rgba(239,68,68,0.35); }
    .btn-mini.danger:hover{ border-color:rgba(239,68,68,0.70); }
    .chev{ font-size:1.6rem; font-weight:900; opacity:.55; margin-left:.2rem; }

    /* ===== Modal ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:620px;
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      padding:1.5rem;
      animation:fadeInUp .25s ease-out;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:1rem;
    }
    .modal-header h3{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      font-size:1.25rem;
    }
    .modal-close{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text-primary);
      cursor:pointer;
      border-radius:10px;
      padding:.4rem .7rem;
      transition:all .2s ease;
    }
    .modal-close:hover{
      border-color:var(--accent);
      transform:translateY(-1px);
    }

    /* ===== Autos de trabajo ===== */
    .subtabs{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin: .25rem 0 1.25rem 0;
    }
    .chip{
      padding:.55rem .95rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
    }
    .chip.active{
      border-color:rgba(0,230,118,0.55);
      background:rgba(0,230,118,0.12);
      color:var(--accent);
    }
    .chip:hover{ transform:translateY(-1px); border-color:rgba(0,230,118,0.45); }

    .work-panel{
      border:1px dashed rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.06);
      border-radius:16px;
      padding:1.25rem;
    }

    .work-cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .work-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .work-card h4{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      margin-bottom:.35rem;
      font-size:1.05rem;
    }
    .work-card p{ color:rgba(255,255,255,0.75); font-weight:800; }
    .work-card .cat{
      margin-top:.6rem;
      display:inline-block;
      padding:.25rem .6rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:900;
      border:1px solid rgba(16,185,129,0.35);
      background:rgba(16,185,129,0.10);
      color:var(--success);
      text-transform:uppercase;
      letter-spacing:.3px;
    }

    /* ===== Ganancias: semanas ===== */
    .weeks-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .week-tile{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
      cursor:pointer;
      transition:.2s ease;
    }
    .week-tile:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 12px 35px rgba(0,0,0,0.25);
    }
    .week-tile.active{
      border-color:rgba(0,230,118,0.75);
      background:rgba(0,230,118,0.08);
    }
    .week-tile .wk-title{
      font-family:'Space Mono', monospace;
      font-weight:900;
      color:#fff;
      margin-bottom:.25rem;
    }
    .week-tile .wk-range{
      color:rgba(255,255,255,0.75);
      font-weight:900;
    }

    .gain-top{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .kpi{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .kpi .k-title{
      color:rgba(255,255,255,0.70);
      font-weight:900;
      text-transform:uppercase;
      font-size:.8rem;
      letter-spacing:.4px;
    }
    .kpi .k-val{
      font-family:'Space Mono', monospace;
      font-size:1.6rem;
      font-weight:900;
      margin-top:.35rem;
    }

    .gain-cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:1rem;
      margin-top:1rem;
    }

    .gain-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .gain-card h4{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      margin-bottom:.25rem;
    }
    .gain-sub{
      color:rgba(255,255,255,0.70);
      font-weight:900;
      margin-bottom:.8rem;
    }
    .gain-label{
      color:rgba(255,255,255,0.65);
      font-weight:900;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:.4rem;
    }

    .pay-input{
      width:100%;
      padding:.85rem 1rem;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(10,14,39,0.55);
      color:#fff;
      font-weight:900;
      font-family:'Space Mono', monospace;
      font-size:1.1rem;
      outline:none;
      transition:.2s ease;
    }
    .pay-input:focus{
      border-color:rgba(0,230,118,0.65);
      box-shadow:0 0 0 3px rgba(0,230,118,0.12);
    }

    .row-kv{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      margin-top:.75rem;
      font-weight:900;
      color:rgba(255,255,255,0.85);
    }
    .row-kv small{
      display:inline-block;
      margin-left:.4rem;
      padding:.15rem .5rem;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(16,185,129,0.35);
      background:rgba(16,185,129,0.10);
      color:var(--success);
    }
    .details{
      margin-top:.8rem;
      color:rgba(255,255,255,0.70);
      font-weight:800;
      font-size:.9rem;
      line-height:1.25rem;
    }

    /* ===== Rentabilidad visual (ALL TIME) ===== */
    .profit-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .profit-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
      display:flex;
      gap:1rem;
      align-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
    }
    .pie-wrap{
      width:92px; height:92px;
      border-radius:16px;
      background:rgba(0,0,0,0.15);
      border:1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 92px;
      position:relative;
      overflow:hidden;
    }
    .pie-wrap canvas{ width:78px; height:78px; }
    .pie-label{
      position:absolute;
      bottom:6px; right:8px;
      font-size:.8rem;
      font-weight:900;
      font-family:'Space Mono', monospace;
      color:rgba(255,255,255,0.85);
      max-width:78px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .profit-meta{ flex:1; min-width:0; }
    .profit-title{
      font-family:'Space Mono', monospace;
      font-weight:900;
      color:var(--accent);
      margin-bottom:.35rem;
      font-size:1rem;
      line-height:1.2rem;
    }
    .profit-sub{
      color:rgba(255,255,255,0.70);
      font-size:.9rem;
      margin-bottom:.6rem;
      font-weight:900;
    }
    .kv{
      display:flex;
      flex-direction:column;
      gap:.2rem;
      font-weight:900;
    }
    .kv span{
      display:flex;
      align-items:center;
      gap:.4rem;
      color:rgba(255,255,255,0.85);
      font-size:.9rem;
    }
    .dot-mini{ width:8px; height:8px; border-radius:50%; display:inline-block; }
    .dot-in{ background:#3b82f6; }
    .dot-out{ background:#f59e0b; }
    .dot-net{ background:#10b981; }
    .net-neg{ color:var(--danger) !important; }

    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @keyframes fadeInDown{ from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    @keyframes slideInRight{ from{opacity:0; transform:translateX(20px);} to{opacity:1; transform:translateX(0);} }

    @media(max-width:768px){
      .container{ padding:1rem; }
      .header h1{ font-size:2rem; }
      .main-nav{ flex-direction:column; }
      .nav-btn{ min-width:auto; }
      .vehicle-row-top{ grid-template-columns:1fr 140px; }
      .vehicle-carimg{ width:140px; height:85px; }
      .vp-right{ min-width:120px; }
      .vp-left{ min-width:180px; }
      .gain-top{ grid-template-columns:1fr; }
    }
  

    /* =========================
       MOBILE PRO (app-like)
       Mantiene funcionalidades, solo ajusta UI
       ========================= */
    @media (max-width: 640px){
      /* espacio para barra inferior y safe-area iPhone */
      .container{
        padding: 1rem !important;
        padding-bottom: calc(104px + env(safe-area-inset-bottom)) !important;
      }

      .header{ margin-bottom: 1.25rem !important; }
      .header h1{
        font-size: 1.55rem !important;
        line-height: 1.15 !important;
      }
      .header p{ font-size: .95rem !important; }

      /* NAV como barra inferior tipo app */
      .main-nav{
        position: fixed !important;
        left: 12px !important;
        right: 12px !important;
        bottom: calc(12px + env(safe-area-inset-bottom)) !important;
        margin: 0 !important;
        gap: 10px !important;
        padding: 10px !important;
        border-radius: 18px !important;
        background: rgba(11, 26, 20, 0.85) !important;
        border: 1px solid rgba(255,255,255,0.14) !important;
        box-shadow: 0 18px 55px rgba(0,0,0,0.55) !important;
        backdrop-filter: blur(10px) !important;
        z-index: 9998 !important;

        display: grid !important;
        grid-template-columns: repeat(5, 1fr) !important;
        animation: none !important;
      }
      .nav-btn{
        min-width: 0 !important;
        width: 100% !important;
        padding: .75rem .5rem !important;
        font-size: .78rem !important;
        border-radius: 14px !important;
        line-height: 1.05 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
        white-space: normal !important;
      }

      /* tarjetas un poco m√°s compactas */
      .card{
        padding: 1.15rem !important;
        border-radius: 16px !important;
      }

      /* grids a 1 columna */
      .stats-grid{ grid-template-columns: 1fr !important; }
      .type-grid{ grid-template-columns: 1fr !important; }
      .profit-grid{ grid-template-columns: 1fr !important; }

      /* headers apilados */
      .vehicles-header{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
      }
      .add-pill{
        width: 100% !important;
        text-align: center !important;
        justify-content: center !important;
      }

      /* VEH√çCULOS: apilar para que no quede apretado */
      .vehicle-row-top{
        grid-template-columns: 1fr !important;
        gap: .85rem !important;
      }
      .vehicle-carimg{
        width: 100% !important;
        height: 160px !important;
        border-radius: 18px !important;
      }
      .vehicle-row-bottom{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
      }
      .row-actions{
        justify-content: space-between !important;
        width: 100% !important;
      }
      .btn-mini{
        flex: 1 !important;
        text-align: center !important;
        padding: .65rem .9rem !important;
      }

      /* LISTAS: apiladas */
      .maintenance-item, .verification-item{
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: .6rem !important;
      }

      /* PROGRESO POR VEH√çCULO: evitar que se salga a la derecha */
      .vehicle-progress-item{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
        max-width: 100% !important;
        overflow: hidden !important;
      }
      .vp-left{ min-width: 0 !important; width: 100% !important; }
      .vp-bar-wrap{ min-width: 0 !important; width: 100% !important; }
      .vp-right{
        min-width: 0 !important;
        width: 100% !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        gap: .75rem !important;
        flex-wrap: wrap !important;
      }
      .vp-right *{ min-width: 0 !important; }
      .vp-right .vp-meta{
        text-align: right !important;
      }
    }

    @media (max-width: 420px){
      .main-nav{
        left: 10px !important;
        right: 10px !important;
        gap: 8px !important;
        padding: 8px !important;
      }
      .nav-btn{
        font-size: .72rem !important;
        padding: .70rem .45rem !important;
      }
    }


    /* Verificaciones: panel en cascada por veh√≠culo */
    .veri-panel{
      margin-top:.75rem;
      background:rgba(10,14,39,0.35);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1rem;
    }
    .veri-panel .panel-actions{
      display:flex;
      gap:.5rem;
      justify-content:flex-end;
      margin-bottom:.75rem;
    }
    .veri-panel .mini-btn{
      padding:.5rem .75rem;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.06);
      color:var(--text-primary);
      cursor:pointer;
      font-weight:600;
    }
    .veri-panel .mini-btn:hover{ background:rgba(255,255,255,0.09); }

</style>
<link href="/favicon-32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/icon-192.png" rel="icon" sizes="192x192" type="image/png"/><link href="/icon-512.png" rel="icon" sizes="512x512" type="image/png"/></head>
<body>
<div class="container">
<div class="header">
<h1>üöó Control Vehicular</h1>
<p>Sistema integral de gesti√≥n y mantenimiento de veh√≠culos</p>
</div>
<nav class="main-nav">
<button class="nav-btn active" onclick="showSection('dashboard', event)">Dashboard</button>
<button class="nav-btn" onclick="showSection('vehicles', event)">Veh√≠culos</button>
<button class="nav-btn" onclick="showSection('verification', event)">Verificaciones &amp; Multas</button>
<button class="nav-btn" onclick="showSection('maintenance', event)">Mantenimientos</button>
<button class="nav-btn" onclick="showSection('workcars', event)">Autos de trabajo</button>
</nav>
<!-- DASHBOARD -->
<section class="section active" id="dashboard">
<div class="stats-grid">
<div class="stat-card">
<div class="number" id="totalVehicles">0</div>
<div class="label">Veh√≠culos Registrados</div>
</div>
<div class="stat-card">
<div class="number" id="alertsCount">0</div>
<div class="label">Alertas Activas</div>
</div>
<div class="stat-card">
<div class="number" id="overdueCount">0</div>
<div class="label">Verificaciones Vencidas</div>
</div>
<div class="stat-card">
<div class="number" id="upcomingCount">0</div>
<div class="label">Pr√≥ximas (30 d√≠as)</div>
</div>
</div>
<div id="dashboardAlerts"></div>
<div class="card">
<h2>üßæ Resumen por Tipo</h2>
<div class="type-grid" id="typeSummary"></div>
</div>
<div class="card">
<h2>üìå Progreso por Veh√≠culo</h2>
<div class="vehicle-progress-list" id="vehicleProgress"></div>
</div>
<div class="card">
<h2>üìä Resumen por Veh√≠culo</h2>
<div class="verification-list" id="vehicleSummary"></div>
</div>
<div class="card">
<h2>‚è∞ Pr√≥ximas Verificaciones</h2>
<div class="verification-list" id="upcomingVerifications"></div>
</div>
</section>
<!-- VEH√çCULOS -->
<section class="section" id="vehicles">
<div class="card" id="addVehicleCard">
<h2>‚ûï Agregar Nuevo Veh√≠culo</h2>
<form id="vehicleForm">
<div class="form-group">
<label for="carName">Nombre del Veh√≠culo</label>
<input id="carName" placeholder="Ej: Chevrolet Aveo" required="" type="text"/>
</div>
<div class="form-group">
<label for="carYear">A√±o</label>
<input id="carYear" max="2030" min="1900" placeholder="2020" required="" type="number"/>
</div>
<div class="form-group">
<label for="carCategory">Categor√≠a</label>
<select id="carCategory" required="">
<option value="Particular">Particular</option>
<option value="Trabajo">Trabajo</option>
</select>
</div>
<div class="form-group">
<label for="carColor">Color</label>
<select id="carColor" onchange="toggleCustomColor('carColor','carColorOther')" required="">
<option value="">Seleccionar...</option>
<option>Negro</option>
<option>Blanco</option>
<option>Gris</option>
<option>Plata</option>
<option>Rojo</option>
<option>Azul</option>
<option>Verde</option>
<option>Amarillo</option>
<option>Naranja</option>
<option>Caf√©</option>
<option>Vino</option>
<option>Morado</option>
<option value="__otro__">Otro‚Ä¶</option>
</select>
<input id="carColorOther" placeholder="Escribe el color..." style="display:none; margin-top:0.75rem;" type="text"/>
</div>
<div class="form-group">
<label for="carPlates">Placas</label>
<input id="carPlates" placeholder="ABC-123-D" type="text"/>
</div>
<!-- FOTO DEL VEH√çCULO (opcional) -->
<div class="form-group">
<label for="carPhoto">Fotograf√≠a del veh√≠culo (opcional)</label>
<input accept="image/*" id="carPhoto" type="file"/>
<div id="carPhotoPreviewWrap" style="display:none; margin-top:0.75rem;">
<img alt="Vista previa" id="carPhotoPreview" style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.15);"/>
<button class="btn btn-secondary" onclick="clearCarPhoto()" style="margin-top:.6rem;" type="button">Quitar foto</button>
</div>
<small style="display:block; margin-top:.6rem; color:rgba(255,255,255,0.65); font-weight:700;">
              Tip: usa una foto ligera para que cargue r√°pido (ideal &lt; 1MB).
            </small>
</div>
<button class="btn btn-primary" type="submit">Agregar Veh√≠culo</button>
</form>
</div>
<div class="card">
<div class="vehicles-header">
<h2 style="margin:0;">üöô Mis Veh√≠culos</h2>
<button class="add-pill" onclick="scrollToAddVehicle()">+ Agregar</button>
</div>
<div class="vehicle-list" id="vehiclesList"></div>
</div>
</section>
<!-- VERIFICACIONES -->
<section class="section" id="verification">
<div class="card">
<h2>üìã Gesti√≥n de Verificaciones, Tenencia y Multas</h2>
<div id="vehicleSelector">
<p class="empty-state">Por favor, selecciona un veh√≠culo para gestionar sus verificaciones</p>
</div>
</div>
<div id="verificationForm" style="display:none;">
<div class="card">
<h2>‚ûï Agregar Registro</h2>
<form id="addVerificationForm">
<div class="form-group">
<label for="verificationType">Tipo</label>
<select id="verificationType" required="">
<option value="">Seleccionar...</option>
<option value="verificacion">Verificaci√≥n</option>
<option value="tenencia">Tenencia</option>
<option value="multa">Multa</option>
</select>
</div>
<div class="form-group">
<label for="verificationDate">Fecha</label>
<input id="verificationDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="verificationNext">Pr√≥xima Fecha (para verificaci√≥n/tenencia)</label>
<input id="verificationNext" type="date"/>
</div>
<div class="form-group">
<label for="verificationAmount">Monto (opcional)</label>
<input id="verificationAmount" placeholder="$0.00" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="verificationNotes">Notas</label>
<textarea id="verificationNotes" placeholder="Detalles adicionales..."></textarea>
</div>
<button class="btn btn-primary" type="submit">Agregar Registro</button>
</form>
</div>
</div>
</section>
<!-- MANTENIMIENTOS -->
<section class="section" id="maintenance">
<div class="card">
<h2>üîß Gesti√≥n de Mantenimientos</h2>
<div id="maintenanceVehicleSelector">
<p class="empty-state">Por favor, selecciona un veh√≠culo para gestionar sus mantenimientos</p>
</div>
</div>
<div id="maintenanceForm" style="display:none;">
<div class="card">
<h2>‚ûï Agregar Mantenimiento</h2>
<form id="addMaintenanceForm">
<div class="form-group">
<label for="maintenanceType">Tipo de Trabajo</label>
<select id="maintenanceType" required="">
<option value="">Seleccionar...</option>
<option value="cambio_aceite">Cambio de Aceite</option>
<option value="afinacion">Afinaci√≥n</option>
<option value="frenos">Frenos</option>
<option value="llantas">Llantas</option>
<option value="suspension">Suspensi√≥n</option>
<option value="bateria">Bater√≠a</option>
<option value="transmision">Transmisi√≥n</option>
<option value="aire_acondicionado">Aire Acondicionado</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group">
<label for="maintenanceDescription">Descripci√≥n del Trabajo</label>
<textarea id="maintenanceDescription" placeholder="Detalles del mantenimiento realizado..." required=""></textarea>
</div>
<div class="form-group">
<label for="maintenanceDate">Fecha</label>
<input id="maintenanceDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="maintenanceCost">Costo</label>
<input id="maintenanceCost" placeholder="$0.00" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="maintenanceKm">Kilometraje</label>
<input id="maintenanceKm" placeholder="50000" type="number"/>
</div>
<button class="btn btn-primary" type="submit">Agregar Mantenimiento</button>
</form>
</div>
<div class="card">
<h2>üìú Historial de Mantenimientos</h2>
<div class="maintenance-list" id="maintenanceList"></div>
</div>
</div>
</section>
<!-- AUTOS DE TRABAJO -->
<section class="section" id="workcars">
<div class="card">
<h2>üè¢ Autos de trabajo</h2>
<p style="color: var(--text-secondary); font-weight:700; margin-top:-0.75rem;">
          Aqu√≠ aparecen autom√°ticamente los veh√≠culos marcados como <b>Trabajo</b>.
        </p>
<div class="subtabs">
<button class="chip active" id="workTabHome" onclick="showWorkTab('home')">Inicio</button>
<button class="chip" id="workTabGains" onclick="showWorkTab('gains')">Ganancias</button>
<button class="chip" id="workTabDrivers" onclick="showWorkTab('drivers')">Choferes</button>
</div>
<!-- HOME -->
<div id="workHome">
<div class="work-panel">
<div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; color:#fff;">üìå Panel de Autos de Trabajo</div>
<div style="color:rgba(255,255,255,0.75); font-weight:800;">Listado r√°pido de autos de trabajo.</div>
</div>
<button class="btn btn-primary" onclick="showWorkTab('gains')" style="padding:.85rem 1.2rem;">IR A GANANCIAS</button>
</div>
<div class="work-cards" id="workVehiclesGrid"></div>
</div>
<!-- Rentabilidad ALL TIME -->
<div class="card" style="margin-top:1.25rem;">
<h2>üìä Rentabilidad (visual)</h2>
<p style="color: var(--text-secondary); margin-top:-0.75rem; margin-bottom:1rem; font-weight:800;">
              Entrada = Pagos del chofer (hist√≥rico) ‚Ä¢ Salida = Mantenimientos (hist√≥rico)
            </p>
<div class="profit-grid" id="profitAllTimeGrid"></div>
</div>
</div>
<!-- GAINS -->
<div id="workGains" style="display:none;">
<div class="work-panel">
<div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; color:#fff;">üí∞ Ganancias</div>
<div style="color:rgba(255,255,255,0.78); font-weight:800;">
                  La semana es <b>Lunes ‚Üí Domingo</b>. Los pagos se capturan <b>manual</b> por veh√≠culo.
                  Los mantenimientos dentro del rango se descuentan autom√°ticamente.
                </div>
</div>
<button class="btn btn-danger" onclick="showWorkTab('home')" style="padding:.85rem 1.2rem;">SALIR</button>
</div>
<div style="margin-top:1rem;">
<div class="form-group">
<label for="gainsMonth">Selecciona mes</label>
<input id="gainsMonth" type="month"/>
</div>
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; margin-bottom:.35rem;">Semanas (Lunes ‚Üí Domingo)</div>
<div class="weeks-grid" id="weeksGrid"></div>
</div>
<div id="weekDetail" style="margin-top:1rem;">
<div class="gain-top">
<div class="kpi">
<div class="k-title">Pagos chofer (total)</div>
<div class="k-val" id="kpiIn">$0.00</div>
</div>
<div class="kpi">
<div class="k-title">Mantenimientos (total)</div>
<div class="k-val" id="kpiOut">$0.00</div>
</div>
<div class="kpi">
<div class="k-title">Ganancia real (total)</div>
<div class="k-val" id="kpiNet">$0.00</div>
</div>
</div>
<div class="gain-cards" id="gainCards"></div>
<!-- rentabilidad VISUAL por SEMANA -->
<div class="card" style="margin-top:1.25rem; margin-bottom:0;">
<h2>üìà Rentabilidad (visual) ‚Äî Semana seleccionada</h2>
<p style="color: var(--text-secondary); margin-top:-0.75rem; margin-bottom:1rem; font-weight:800;">
                    Entrada = Pagos del chofer (esta semana) ‚Ä¢ Salida = Mantenimientos (esta semana)
                  </p>
<div class="profit-grid" id="profitWeekGrid"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- DRIVERS -->
<div id="workDrivers" style="display:none;">
  <div class="card" style="margin-top:1rem;">
    <h2>‚ûï Agregar / Editar Chofer</h2>
    <p style="color: var(--text-secondary); font-weight:800; margin-top:-0.75rem;">
      Registra choferes y as√≠gnalos a un <b>veh√≠culo de Trabajo</b>.
    </p>

    <form id="driverForm" class="form-grid" autocomplete="off">
      <div class="form-group" style="grid-column:1/-1;">
        <label>CHOFER (NOMBRE COMPLETO)</label>
        <input id="drvName" type="text" placeholder="Ej: Juan P√©rez L√≥pez" required />
      </div>

      <div class="form-group">
        <label>CELULAR</label>
        <input id="drvPhone" type="tel" placeholder="Ej: 55 1234 5678" />
      </div>

      <div class="form-group">
        <label>CORREO</label>
        <input id="drvEmail" type="email" placeholder="Ej: correo@dominio.com" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>DIRECCI√ìN</label>
        <input id="drvAddress" type="text" placeholder="Calle, n√∫mero, colonia, alcald√≠a/municipio, estado" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>VEH√çCULO ASIGNADO (TRABAJO)</label>
        <select id="drvVehicle">
          <option value="">Sin asignar</option>
        </select>
        <small style="color:rgba(255,255,255,0.65); font-weight:800;">
          Nota: si tiene veh√≠culo asignado, se mantendr√° como activo.
        </small>
      </div>

      <div class="form-group">
        <label>FECHA DE INICIO</label>
        <input id="drvStart" type="date" />
      </div>

      <div class="form-group">
        <label>FECHA FINAL (SI DEJ√ì DE TRABAJAR)</label>
        <input id="drvEnd" type="date" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>OBSERVACIONES</label>
        <textarea id="drvNotes" rows="3" placeholder="Notas, incidencias, comentarios..."></textarea>
      </div>

      <div class="card" style="grid-column:1/-1; margin-top:.25rem;">
        <h2>üìå Referencia</h2>
        <div class="form-grid">
          <div class="form-group" style="grid-column:1/-1;">
            <label>NOMBRE</label>
            <input id="refName" type="text" placeholder="Ej: Mar√≠a Gonz√°lez" />
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>CELULAR</label>
            <input id="refPhone" type="tel" placeholder="Ej: 55 0000 0000" />
          </div>
        </div>
      </div>

      <input type="hidden" id="drvId" value="" />

      <div style="display:flex; gap:0.75rem; margin-top:1rem; grid-column:1/-1;">
        <button class="btn btn-primary" type="submit" style="flex:1;">GUARDAR CHOFER</button>
        <button class="btn btn-secondary" type="button" onclick="resetDriverForm()" style="flex:1;">LIMPIAR</button>
      </div>
    </form>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h2>üë• Choferes registrados</h2>
    <div id="driversList" class="maintenance-list"></div>
  </div>
</div>
</section>
</div>
<!-- MODAL EDITAR -->
<div class="modal-overlay" id="editModal" style="display:none;">
<div class="modal">
<div class="modal-header">
<h3>‚úèÔ∏è Editar Veh√≠culo</h3>
<button class="modal-close" onclick="closeEditModal()">‚úï</button>
</div>
<form id="editVehicleForm">
<input id="editCarId" type="hidden">
<div class="form-group">
<label for="editCarName">Nombre del Veh√≠culo</label>
<input id="editCarName" required="" type="text"/>
</div>
<div class="form-group">
<label for="editCarYear">A√±o</label>
<input id="editCarYear" max="2030" min="1900" required="" type="number"/>
</div>
<div class="form-group">
<label for="editCarCategory">Categor√≠a</label>
<select id="editCarCategory" required="">
<option value="Particular">Particular</option>
<option value="Trabajo">Trabajo</option>
</select>
</div>
<div class="form-group">
<label for="editCarColor">Color</label>
<select id="editCarColor" onchange="toggleCustomColor('editCarColor','editCarColorOther')" required="">
<option value="">Seleccionar...</option>
<option>Negro</option>
<option>Blanco</option>
<option>Gris</option>
<option>Plata</option>
<option>Rojo</option>
<option>Azul</option>
<option>Verde</option>
<option>Amarillo</option>
<option>Naranja</option>
<option>Caf√©</option>
<option>Vino</option>
<option>Morado</option>
<option value="__otro__">Otro‚Ä¶</option>
</select>
<input id="editCarColorOther" placeholder="Escribe el color..." style="display:none; margin-top:0.75rem;" type="text"/>
</div>
<div class="form-group">
<label for="editCarPlates">Placas</label>
<input id="editCarPlates" type="text"/>
</div>
<!-- FOTO DEL VEH√çCULO (opcional) -->
<div class="form-group">
<label for="editCarPhoto">Fotograf√≠a del veh√≠culo (opcional)</label>
<input accept="image/*" id="editCarPhoto" type="file"/>
<div id="editCarPhotoPreviewWrap" style="display:none; margin-top:0.75rem;">
<img alt="Vista previa" id="editCarPhotoPreview" style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.15);"/>
<button class="btn btn-secondary" onclick="clearEditCarPhoto()" style="margin-top:.6rem;" type="button">Quitar foto</button>
</div>
<small style="display:block; margin-top:.6rem; color:rgba(255,255,255,0.65); font-weight:700;">
            Tip: usa una foto ligera para que cargue r√°pido (ideal &lt; 1MB).
          </small>
</div>
<div style="display:flex; gap:0.75rem; margin-top:1rem;">
<button class="btn btn-danger" onclick="closeEditModal()" style="flex:1;" type="button">Cancelar</button>
<button class="btn btn-primary" style="flex:1;" type="submit">Guardar cambios</button>
</div>
</input></form>
</div>
</div>
<script>
    // =========================
    // Storage base
    // =========================
    let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
    let selectedVehicle = null;
    let verifications = JSON.parse(localStorage.getItem('verifications')) || {};
    let maintenances = JSON.parse(localStorage.getItem('maintenances')) || {};

    // Estado de edici√≥n de Verificaciones/Tenencias/Multas
    let editingVerification = { vehicleId: null, recordId: null };

    // workPayments = { [vehicleId]: { [weekKeyStartISO]: number, ... }, ... }
    let workPayments = JSON.parse(localStorage.getItem('workPayments')) || {};

    
    // drivers = [{id, name, phone, email, address, vehicleId, startDate, endDate, notes, refName, refPhone}]
    let drivers = JSON.parse(localStorage.getItem('drivers')) || [];
let workTab = 'home';
    let selectedMonthISO = '';
    let selectedWeekStartISO = '';

    // =========================
    // Helpers
    // =========================
    const MS_DAY = 24 * 60 * 60 * 1000;

    // Parsea "YYYY-MM-DD" como fecha LOCAL (sin corrimiento UTC)
    function parseISODateLocal(iso){
      if(!iso || typeof iso !== 'string') return null;
      const [y, m, d] = iso.split('-').map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m - 1, d); // LOCAL
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

function setVerificationFormMode(isEdit){
      const h2 = document.querySelector('#verificationForm h2');
      const btn = document.querySelector('#addVerificationForm button[type="submit"]');
      if(h2) h2.textContent = isEdit ? '‚úèÔ∏è Editar Registro' : '‚ûï Agregar Registro';
      if(btn) btn.textContent = isEdit ? 'Guardar cambios' : 'Agregar Registro';
    }

    function scrollToAddVehicle() {
      const el = document.getElementById('addVehicleCard');
      if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function toggleCustomColor(selectId, otherId) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel || !other) return;
      const isOther = sel.value === "__otro__";
      other.style.display = isOther ? "block" : "none";
      if (!isOther) other.value = "";
    }

    function getColorValue(selectId, otherId) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel) return "";
      if (sel.value === "__otro__") return (other?.value || "").trim() || "Otro";
      return sel.value.trim();
    }

    function setColorSelect(selectId, otherId, value) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel) return;

      const options = Array.from(sel.options).map(o => o.value || o.text);
      const found = options.includes(value);

      if (found) {
        sel.value = value;
        if (other) { other.style.display = "none"; other.value = ""; }
      } else {
        sel.value = "__otro__";
        if (other) { other.style.display = "block"; other.value = value || ""; }
      }
    }

    function colorToHex(colorName) {
      const map = {
        "Negro":"#111827","Blanco":"#e5e7eb","Gris":"#9ca3af","Plata":"#cbd5e1",
        "Rojo":"#ef4444","Azul":"#3b82f6","Verde":"#22c55e","Amarillo":"#eab308",
        "Naranja":"#f97316","Caf√©":"#a16207","Vino":"#991b1b","Morado":"#7c3aed"
      };
      return map[colorName] || "#00E676";
    }

    function getCarSvgDataUri(hex="#e11d48") {
      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="360" height="200" viewBox="0 0 360 200">
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="${hex}" stop-opacity="0.95"/>
            <stop offset="1" stop-color="${hex}" stop-opacity="0.55"/>
          </linearGradient>
          <linearGradient id="glass" x1="0" x2="1">
            <stop offset="0" stop-color="#bfefff" stop-opacity="0.55"/>
            <stop offset="1" stop-color="#00E676" stop-opacity="0.12"/>
          </linearGradient>
        </defs>

        <g>
          <path d="M55 120c10-35 35-60 85-60h85c40 0 65 16 82 45l22 6c14 4 21 14 21 28v18H40v-18c0-10 6-18 15-20l0 0z"
                fill="url(#g)"/>
          <path d="M130 66h70c28 0 48 10 64 30l-80 0-54-30z" fill="url(#glass)"/>
          <circle cx="120" cy="154" r="20" fill="#0b1220"/>
          <circle cx="120" cy="154" r="10" fill="#111827"/>
          <circle cx="260" cy="154" r="20" fill="#0b1220"/>
          <circle cx="260" cy="154" r="10" fill="#111827"/>
          <rect x="66" y="118" width="40" height="10" rx="5" fill="#ffffff" opacity="0.65"/>
          <rect x="286" y="118" width="35" height="10" rx="5" fill="#ffffff" opacity="0.65"/>
        </g>
      </svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }

    // ‚úÖ FIX: formateo basado en parse local (evita -1 d√≠a)
    function formatDateMX(dateStr) {
      const d = parseISODateLocal(dateStr);
      return d ? d.toLocaleDateString('es-MX') : (dateStr || '');
    }

    function ymd(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function safeNumber(n){
      const x = parseFloat(n);
      return Number.isFinite(x) ? x : 0;
    }

    function money(n){
      const x = safeNumber(n);
      return x.toLocaleString('es-MX', { style:'currency', currency:'MXN' });
    }

    // =========================
    // Estatus vehicular
    // =========================
    // ‚úÖ FIX: c√°lculo de d√≠as con fechas locales (sin UTC)
    function calcDaysUntil(dateStr){
      if(!dateStr) return null;

      const t0 = new Date();
      const today = new Date(t0.getFullYear(), t0.getMonth(), t0.getDate()); // 00:00 local

      const d = parseISODateLocal(dateStr);
      if(!d) return null;

      const target = new Date(d.getFullYear(), d.getMonth(), d.getDate()); // 00:00 local
      return Math.floor((target - today)/MS_DAY);
    }

    function getVehicleStatusWithDays(vehicleId) {
      const records = (verifications && verifications[vehicleId]) ? verifications[vehicleId] : [];
      // ‚úÖ NUEVO: ignorar registros "terminados" para alertas/estatus
      const withNext = records.filter(r => r && r.nextDate && !r.completed);

      if (withNext.length === 0) return { label:'Sin informaci√≥n', detail:'No hay fechas pendientes', dotClass:'gray' };

      let minDaysUntil = Infinity;
      let minDate = null;

      for (const r of withNext) {
        const daysUntil = calcDaysUntil(r.nextDate);
        if (daysUntil === null) continue;
        if (daysUntil < minDaysUntil) {
          minDaysUntil = daysUntil;
          minDate = r.nextDate;
        }
      }

      if (minDate === null) return { label:'Sin informaci√≥n', detail:'No hay fechas v√°lidas', dotClass:'gray' };

      if (minDaysUntil < 0) return { label:'Vencido', detail:`Hace ${Math.abs(minDaysUntil)} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'danger' };
      if (minDaysUntil <= 30) return { label:'Pr√≥ximo', detail:`En ${minDaysUntil} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'warning' };
      return { label:'Al d√≠a', detail:`Pr√≥xima en ${minDaysUntil} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'success' };
    }

    function getSoonestRecord(vehicleId){
      const records = (verifications && verifications[vehicleId]) ? verifications[vehicleId] : [];
      // ‚úÖ NUEVO: ignorar terminados
      const withNext = records.filter(r => r && r.nextDate && !r.completed);
      if(withNext.length === 0) return null;

      let best = null;
      let bestDays = Infinity;
      for(const r of withNext){
        const days = calcDaysUntil(r.nextDate);
        if(days === null) continue;
        if(days < bestDays){
          bestDays = days;
          best = { ...r, daysUntil: days };
        }
      }
      return best;
    }

    function getProgressInfo(daysUntil){
      const horizon = 180;
      if(daysUntil === null || daysUntil === undefined) return { pct:0, cls:'good', text:'Sin fecha' };
      if(daysUntil < 0) return { pct:100, cls:'bad', text:'Vencido' };
      if(daysUntil <= 30){
        const pct = Math.min(100, Math.max(0, Math.round((1 - (daysUntil/30))*100)));
        return { pct, cls:'warn', text:'Pr√≥ximo' };
      }
      const pct = Math.min(100, Math.max(0, Math.round((1 - (Math.min(daysUntil,horizon)/horizon))*100)));
      return { pct, cls:'good', text:'Al d√≠a' };
    }

    function typeLabel(type){
      const map = { verificacion:'Verificaci√≥n', tenencia:'Tenencia', multa:'Multa' };
      return map[type] || type;
    }

    function typeIcon(type){
      const map = { verificacion:'‚úÖ', tenencia:'üí∞', multa:'‚ö†Ô∏è' };
      return map[type] || 'üìå';
    }

    // =========================
    // Navegaci√≥n
    // =========================
    function showSection(sectionName, event){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

      document.getElementById(sectionName).classList.add('active');
      if(event && event.target) event.target.classList.add('active');

      if(sectionName === 'dashboard'){
        renderDashboard();
      }else if(sectionName === 'vehicles'){
        renderVehicles();
      }else if(sectionName === 'verification'){
        renderVehicleSelector();
        checkVerificationAlerts();
      }else if(sectionName === 'maintenance'){
        renderMaintenanceVehicleSelector();
      }else if(sectionName === 'workcars'){
        renderWorkCarsModule();
      }
    }

    // =========================
    // Dashboard
    // =========================
    function renderDashboard(){
      let alertsCount = 0;
      let overdueCount = 0;
      let upcomingCount = 0;
      const allAlerts = [];
      const vehicleSummaryData = [];

      const typeStats = {
        verificacion:{ total:0, overdue:0, upcoming:0 },
        tenencia:{ total:0, overdue:0, upcoming:0 },
        multa:{ total:0, overdue:0, upcoming:0 }
      };

      vehicles.forEach(vehicle => {
        const vehicleAlerts = { vehicle, verifications:[], overdue:0, upcoming:0 };

        if(verifications[vehicle.id]){
          verifications[vehicle.id].forEach(record => {
            // ‚úÖ NUEVO: ignorar terminados en alertas
            if(record && record.nextDate && !record.completed){
              const daysUntil = calcDaysUntil(record.nextDate);
              if(daysUntil === null) return;

              if(typeStats[record.type]) typeStats[record.type].total++;

              if(daysUntil < 0){
                overdueCount++; alertsCount++;
                vehicleAlerts.overdue++;
                vehicleAlerts.verifications.push({ ...record, daysUntil, status:'overdue' });
                if(typeStats[record.type]) typeStats[record.type].overdue++;

                allAlerts.push({
                  vehicle: vehicle.name,
                  type: record.type,
                  daysUntil,
                  nextDate: record.nextDate,
                  status:'danger'
                });
              }else if(daysUntil <= 30){
                upcomingCount++; alertsCount++;
                vehicleAlerts.upcoming++;
                vehicleAlerts.verifications.push({ ...record, daysUntil, status:'upcoming' });
                if(typeStats[record.type]) typeStats[record.type].upcoming++;

                allAlerts.push({
                  vehicle: vehicle.name,
                  type: record.type,
                  daysUntil,
                  nextDate: record.nextDate,
                  status:'warning'
                });
              }
            }
          });
        }

        if(vehicleAlerts.verifications.length > 0) vehicleSummaryData.push(vehicleAlerts);
      });

      document.getElementById('totalVehicles').textContent = vehicles.length;
      document.getElementById('alertsCount').textContent = alertsCount;
      document.getElementById('overdueCount').textContent = overdueCount;
      document.getElementById('upcomingCount').textContent = upcomingCount;

      const alertsContainer = document.getElementById('dashboardAlerts');
      if(allAlerts.length === 0){
        alertsContainer.innerHTML = '<div class="card"><div class="empty-state"><p>‚úÖ No hay alertas pendientes. Todos tus veh√≠culos est√°n al d√≠a.</p></div></div>';
      }else{
        allAlerts.sort((a,b)=>a.daysUntil-b.daysUntil);
        alertsContainer.innerHTML = allAlerts.map(alert => {
          const message = alert.daysUntil < 0 ? `VENCIDA hace ${Math.abs(alert.daysUntil)} d√≠as` : `Vence en ${alert.daysUntil} d√≠as`;
          return `
            <div class="alert alert-${alert.status}">
              <div>
                <strong>${escapeHtml(alert.vehicle)}</strong> - ${escapeHtml(typeLabel(alert.type))}
                <br>
                <span style="font-size:0.9rem;">${message} (${formatDateMX(alert.nextDate)})</span>
              </div>
            </div>
          `;
        }).join('');
      }

      const typeSummary = document.getElementById('typeSummary');
      const types = [
        { key:'verificacion', name:'Verificaci√≥n', icon:'‚úÖ' },
        { key:'tenencia', name:'Tenencia', icon:'üí∞' },
        { key:'multa', name:'Multas', icon:'‚ö†Ô∏è' }
      ];
      typeSummary.innerHTML = types.map(t => {
        const s = typeStats[t.key] || { total:0, overdue:0, upcoming:0 };
        return `
          <div class="type-card">
            <div class="type-icon">${t.icon}</div>
            <div>
              <div class="type-title">${t.name}</div>
              <div class="type-metrics">
                <span class="pill good">Total: ${s.total}</span>
                <span class="pill warn">Pr√≥x: ${s.upcoming}</span>
                <span class="pill bad">Venc: ${s.overdue}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      const progressContainer = document.getElementById('vehicleProgress');
      if(!vehicles || vehicles.length === 0){
        progressContainer.innerHTML = '<div class="empty-state"><p>No hay veh√≠culos registrados.</p></div>';
      }else{
        const items = vehicles.map(v => {
          const soon = getSoonestRecord(v.id);
          const title = (v.plates && v.plates.trim()) ? v.plates.trim() : (v.name || 'Veh√≠culo');
          if(!soon){
            return { v, title, daysUntil:null, date:null, type:null, info:{ pct:0, cls:'good', text:'Sin fechas' } };
          }
          const info = getProgressInfo(soon.daysUntil);
          return { v, title, daysUntil:soon.daysUntil, date:soon.nextDate, type:soon.type, info };
        }).sort((a,b)=>{
          const ad = (a.daysUntil === null) ? 999999 : a.daysUntil;
          const bd = (b.daysUntil === null) ? 999999 : b.daysUntil;
          return ad - bd;
        });

        progressContainer.innerHTML = items.map(item => {
          const dText = item.daysUntil === null ? '‚Äî' : (item.daysUntil < 0 ? `-${Math.abs(item.daysUntil)}d` : `${item.daysUntil}d`);
          const rightLabel = item.daysUntil === null ? 'Sin fecha' : `${typeIcon(item.type)} ${typeLabel(item.type)}`;
          const dateText = item.date ? formatDateMX(item.date) : '‚Äî';
          const fillClass = item.info.cls === 'bad' ? 'bad' : (item.info.cls === 'warn' ? 'warn' : 'good');

          return `
            <div class="vehicle-progress-item">
              <div class="vp-left">
                <div class="vp-title">${escapeHtml(item.title)}</div>
                <div class="vp-sub">${escapeHtml(item.v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(item.v.color || '‚Äî')}${item.v.plates ? ` ‚Ä¢ ${escapeHtml(item.v.plates)}` : ''}</div>
              </div>

              <div class="vp-bar-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                  <div style="font-weight:900; color:rgba(255,255,255,0.85);">${rightLabel}</div>
                  <span class="pill ${fillClass === 'bad' ? 'bad' : (fillClass === 'warn' ? 'warn' : 'good')}">${item.info.text}</span>
                </div>
                <div class="vp-bar">
                  <div class="vp-fill ${fillClass}" style="width:${item.info.pct}%;"></div>
                </div>
              </div>

              <div class="vp-right">
                <div class="vp-days">${dText}</div>
                <div class="vp-date">${dateText}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      const summaryContainer = document.getElementById('vehicleSummary');
      if(vehicleSummaryData.length === 0){
        summaryContainer.innerHTML = '<div class="empty-state"><p>No hay alertas por veh√≠culo</p></div>';
      }else{
        summaryContainer.innerHTML = vehicleSummaryData.map(data => {
          const verificationsList = data.verifications.map(v => {
            const daysText = v.daysUntil < 0 ? `Vencida hace ${Math.abs(v.daysUntil)} d√≠as` : `${v.daysUntil} d√≠as restantes`;
            const badgeClass = v.status === 'overdue' ? 'badge-danger' : 'badge-warning';
            return `
              <div style="margin-top:0.5rem; padding-left:1rem; border-left:2px solid var(--border);">
                <span class="badge ${badgeClass}">${escapeHtml(typeLabel(v.type))}</span>
                <span style="margin-left:0.5rem; color:var(--text-secondary); font-size:0.875rem;">${daysText}</span>
              </div>
            `;
          }).join('');

          return `
            <div class="maintenance-item">
              <div class="item-info">
                <h4>üöó ${escapeHtml(data.vehicle.name)}</h4>
                <p style="color: var(--text-secondary); margin-bottom:0.5rem;">
                  ${escapeHtml(data.vehicle.year)} ‚Ä¢ ${escapeHtml(data.vehicle.color)}
                  ${data.vehicle.plates ? ` ‚Ä¢ ${escapeHtml(data.vehicle.plates)}` : ''}
                </p>
                ${verificationsList}
              </div>
              <div style="text-align:right;">
                ${data.overdue > 0 ? `<div class="badge badge-danger" style="display:block; margin-bottom:0.5rem;">${data.overdue} vencida(s)</div>` : ''}
                ${data.upcoming > 0 ? `<div class="badge badge-warning" style="display:block;">${data.upcoming} pr√≥xima(s)</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      const upcomingContainer = document.getElementById('upcomingVerifications');
      const upcomingVerifications = allAlerts.filter(a => a.daysUntil >= 0).slice(0,10);

      if(upcomingVerifications.length === 0){
        upcomingContainer.innerHTML = '<div class="empty-state"><p>No hay verificaciones pr√≥ximas programadas</p></div>';
      }else{
        upcomingContainer.innerHTML = upcomingVerifications.map(alert => `
          <div class="verification-item">
            <div class="item-info">
              <h4>${escapeHtml(alert.vehicle)}</h4>
              <p>${escapeHtml(typeLabel(alert.type))}</p>
              <p>üìÖ ${formatDateMX(alert.nextDate)}</p>
            </div>
            <div>
              <div class="badge badge-warning">${alert.daysUntil} d√≠as</div>
            </div>
          </div>
        `).join('');
      }
    }

    
    // =========================
    // Foto de veh√≠culo (opcional) - se guarda en vehicles[].image (DataURL)
    // =========================
    let pendingVehicleImageDataUrl = null;

    function setupCarPhotoUploader(){
      const input = document.getElementById('carPhoto');
      if(!input) return;

      input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file){
          clearCarPhoto();
          return;
        }
        if(!file.type || !file.type.startsWith('image/')){
          alert('Selecciona una imagen v√°lida.');
          clearCarPhoto();
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          pendingVehicleImageDataUrl = String(reader.result || '');
          const wrap = document.getElementById('carPhotoPreviewWrap');
          const img = document.getElementById('carPhotoPreview');
          if(img) img.src = pendingVehicleImageDataUrl;
          if(wrap) wrap.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
    }

    function clearCarPhoto(){
      pendingVehicleImageDataUrl = null;
      const input = document.getElementById('carPhoto');
      const wrap = document.getElementById('carPhotoPreviewWrap');
      const img = document.getElementById('carPhotoPreview');
      if(input) input.value = '';
      if(img) img.src = '';
      if(wrap) wrap.style.display = 'none';
    }

    // =========================
    // Foto (editar veh√≠culo) - si no seleccionas nada, conserva la foto actual
    // pendingEditVehicleImageDataUrl:
    //   undefined => sin cambios
    //   null      => quitar foto
    //   "data:..."=> nueva foto
    // =========================
    let pendingEditVehicleImageDataUrl = undefined;

    function setupEditCarPhotoUploader(){
      const input = document.getElementById('editCarPhoto');
      if(!input) return;

      input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file){
          // si el usuario cancela el selector, no cambiamos nada
          return;
        }
        if(!file.type || !file.type.startsWith('image/')){
          alert('Selecciona una imagen v√°lida.');
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          pendingEditVehicleImageDataUrl = String(reader.result || '');
          const wrap = document.getElementById('editCarPhotoPreviewWrap');
          const img = document.getElementById('editCarPhotoPreview');
          if(img) img.src = pendingEditVehicleImageDataUrl;
          if(wrap) wrap.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
    }

    function clearEditCarPhoto(){
      // marcar como "quitar foto"
      pendingEditVehicleImageDataUrl = null;
      const input = document.getElementById('editCarPhoto');
      const wrap = document.getElementById('editCarPhotoPreviewWrap');
      const img = document.getElementById('editCarPhotoPreview');
      if(input) input.value = '';
      if(img) img.src = '';
      if(wrap) wrap.style.display = 'none';
    }
// =========================
    // Veh√≠culos
    // =========================
    document.getElementById('vehicleForm').addEventListener('submit', function(e){
      e.preventDefault();

      const vehicle = {
        id: Date.now(),
        name: document.getElementById('carName').value.trim(),
        year: document.getElementById('carYear').value,
        category: document.getElementById('carCategory').value || 'Particular',
        color: getColorValue('carColor','carColorOther'),
        plates: document.getElementById('carPlates').value.trim(),
        image: pendingVehicleImageDataUrl || null
      };

      vehicles.push(vehicle);
      localStorage.setItem('vehicles', JSON.stringify(vehicles));
      this.reset();
      clearCarPhoto();
      document.getElementById('carColorOther').style.display = 'none';
      document.getElementById('carCategory').value = 'Particular';

      renderVehicles();
      renderDashboard();
      renderWorkCarsModule();
      showAlert('success', '¬°Veh√≠culo agregado exitosamente!');
    });

    function renderVehicles(){
      const container = document.getElementById('vehiclesList');

      if(!vehicles || vehicles.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay veh√≠culos registrados. Agrega tu primer veh√≠culo arriba.</p></div>';
        return;
      }

      container.innerHTML = vehicles.map(v => {
        const isSelected = selectedVehicle && selectedVehicle.id === v.id;
        const plateTitle = (v.plates && v.plates.trim()) ? v.plates.trim() : '‚Äî';
        const mainTitle = (v.name && String(v.name).trim()) ? String(v.name).trim() : plateTitle;
        const status = getVehicleStatusWithDays(v.id);
        const hex = colorToHex(v.color || "Rojo");
        const imgSrc = v.image || getCarSvgDataUri(hex);

        const cat = (v.category === 'Trabajo') ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>` : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

        const sub = `${escapeHtml(plateTitle)} <span class="bullet">¬∑</span> ${escapeHtml(v.year || '‚Äî')} <span class="bullet">¬∑</span> ${escapeHtml(v.color || '‚Äî')}`;
        const driverName = getDriverNameForVehicle(v.id);
        const driverLine = (v.category === 'Trabajo' && driverName) ? `<div class="vehicle-subtitle" style="margin-top:.25rem;">üë§ ${escapeHtml(driverName)}</div>` : '';

        return `
          <div class="vehicle-row ${isSelected ? 'selected' : ''}" onclick="selectVehicle(${v.id})">
            <div class="vehicle-row-top">
              <div>
                <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                <div class="vehicle-subtitle">${sub}</div>
                ${driverLine}
              </div>

              <div class="vehicle-carimg">
                <img src="${imgSrc}" alt="auto">
              </div>
            </div>

            <div class="vehicle-row-bottom">
              <div class="status">
                <span class="dot ${status.dotClass}"></span>
                <div class="status-text">
                  <div>${status.label}</div>
                  <small>${status.detail}</small>
                </div>
              </div>

              <div class="row-actions">
                <button class="btn-mini" onclick="openEditModal(${v.id}, event)">Editar</button>
                <button class="btn-mini danger" onclick="deleteVehicle(${v.id}, event)">Eliminar</button>
                <span class="chev">‚Ä∫</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectVehicle(id){
      selectedVehicle = vehicles.find(v => v.id === id);
      renderVehicles();

      if(document.getElementById('verification').classList.contains('active')){
        document.getElementById('verificationForm').style.display = 'block';
        renderVehicleSelector();
        renderVerifications();
        checkVerificationAlerts();
      }

      if(document.getElementById('maintenance').classList.contains('active')){
        document.getElementById('maintenanceForm').style.display = 'block';
        renderMaintenanceVehicleSelector();
        renderMaintenances();
      }
    }

    function deleteVehicle(id, event){
      event.stopPropagation();
      if(confirm('¬øEst√°s seguro de que deseas eliminar este veh√≠culo?')){
        vehicles = vehicles.filter(v => v.id !== id);
        delete verifications[id];
        delete maintenances[id];
        delete workPayments[id];

        localStorage.setItem('vehicles', JSON.stringify(vehicles));
        localStorage.setItem('verifications', JSON.stringify(verifications));
        localStorage.setItem('maintenances', JSON.stringify(maintenances));
        localStorage.setItem('workPayments', JSON.stringify(workPayments));

        if(selectedVehicle && selectedVehicle.id === id) selectedVehicle = null;

        renderVehicles();
        renderDashboard();
        renderWorkCarsModule();
        showAlert('success', 'Veh√≠culo eliminado correctamente');
      }
    }

    // =========================
    // Editar Veh√≠culo (modal)
    // =========================
    function openEditModal(id, event){
      event.stopPropagation();
      const v = vehicles.find(x => x.id === id);
      if(!v) return;

      document.getElementById('editCarId').value = v.id;
      document.getElementById('editCarName').value = v.name || '';
      document.getElementById('editCarYear').value = v.year || '';
      document.getElementById('editCarPlates').value = v.plates || '';
      document.getElementById('editCarCategory').value = v.category || 'Particular';
      setColorSelect('editCarColor','editCarColorOther', v.color || '');

      // reset estado de foto en edici√≥n
      pendingEditVehicleImageDataUrl = undefined;
      const eWrap = document.getElementById('editCarPhotoPreviewWrap');
      const eImg = document.getElementById('editCarPhotoPreview');
      const eInput = document.getElementById('editCarPhoto');
      if(eInput) eInput.value = '';

      if(v.image){
        if(eImg) eImg.src = v.image;
        if(eWrap) eWrap.style.display = 'block';
      }else{
        if(eImg) eImg.src = '';
        if(eWrap) eWrap.style.display = 'none';
      }

      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal(){
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editModal').addEventListener('click', (e) => {
      if(e.target && e.target.id === 'editModal') closeEditModal();
    });

    document.getElementById('editVehicleForm').addEventListener('submit', function(e){
      e.preventDefault();
      const id = Number(document.getElementById('editCarId').value);
      const idx = vehicles.findIndex(v => v.id === id);
      if(idx === -1) return;

      vehicles[idx] = {
        ...vehicles[idx],
        name: document.getElementById('editCarName').value.trim(),
        year: document.getElementById('editCarYear').value,
        category: document.getElementById('editCarCategory').value || 'Particular',
        color: getColorValue('editCarColor','editCarColorOther'),
        plates: document.getElementById('editCarPlates').value.trim(),
        // foto: solo cambia si el usuario seleccion√≥ / quit√≥ una
        image: (pendingEditVehicleImageDataUrl !== undefined) ? pendingEditVehicleImageDataUrl : vehicles[idx].image
      };

      localStorage.setItem('vehicles', JSON.stringify(vehicles));
      if(selectedVehicle && selectedVehicle.id === id) selectedVehicle = vehicles[idx];

      pendingEditVehicleImageDataUrl = undefined;
      closeEditModal();
      renderVehicles();
      renderDashboard();
      renderWorkCarsModule();

      showAlert('success', 'Veh√≠culo actualizado correctamente');
    });

    // =========================
    // Verificaciones
    // =========================
    function renderVehicleSelector(){
      const container = document.getElementById('vehicleSelector');
      if(vehicles.length === 0){
        container.innerHTML = '<p class="empty-state">No hay veh√≠culos registrados. Agrega un veh√≠culo primero.</p>';
        document.getElementById('verificationForm').style.display = 'none';
        return;
      }

      const openId = window.__openVeriVehicleId || null;

      container.innerHTML = `
        <div class="vehicle-list">
          ${vehicles.map(vehicle => {
            const isOpen = openId === vehicle.id;

            // ‚úÖ En Verificaciones debe resaltar el NOMBRE (no la placa)
            const mainTitle = (vehicle.name && vehicle.name.trim()) ? vehicle.name.trim() : ((vehicle.plates && vehicle.plates.trim()) ? vehicle.plates.trim() : 'Veh√≠culo');

            const subParts = [];
            if(vehicle.plates && vehicle.plates.trim()) subParts.push(escapeHtml(vehicle.plates.trim()));
            if(vehicle.year) subParts.push(escapeHtml(vehicle.year));
            if(vehicle.color) subParts.push(escapeHtml(vehicle.color));
            const sub = subParts.join(' <span class="bullet">¬∑</span> ');

            const status = getVehicleStatusWithDays(vehicle.id);
            const imgSrc = vehicle.image || getCarSvgDataUri(colorToHex(vehicle.color || "Rojo"));

            const dn = getDriverNameForVehicle(vehicle.id);
            const driverLine = dn ? `<div class="vehicle-subtitle">üë§ ${escapeHtml(dn)}</div>` : '';

            const cat = (vehicle.category === 'Trabajo')
              ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>`
              : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

            return `
              <div class="vehicle-row ${isOpen ? 'selected' : ''}" onclick="toggleVerificationPanel(${vehicle.id})">
                <div class="vehicle-row-top">
                  <div>
                    <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                    ${sub ? `<div class="vehicle-subtitle">${sub}</div>` : ''}
                    ${driverLine}
                  </div>
                  <div class="vehicle-carimg">
                    <img src="${imgSrc}" alt="auto">
                  </div>
                </div>
                <div class="vehicle-row-bottom">
                  <div class="status">
                    <span class="dot ${status.dotClass}"></span>
                    <div class="status-text">
                      <div>${status.label}</div>
                      <small>${status.detail}</small>
                    </div>
                  </div>
                  <div class="row-actions">
                    <span class="chev">${isOpen ? '‚åÑ' : '‚Ä∫'}</span>
                  </div>
                </div>
              </div>

              <div class="veri-panel" id="veriPanel-${vehicle.id}" style="display:${isOpen ? 'block' : 'none'};">
                <div class="panel-actions">
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); openAddVerificationFor(${vehicle.id});">+ Agregar</button>
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); toggleVerificationPanel(${vehicle.id}, true);">Cerrar</button>
                </div>
                <div class="verification-list" id="veriList-${vehicle.id}"></div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // Renderiza el panel abierto (si existe)
      if(openId) renderVerificationsFor(openId);
    }

    function selectVehicleForVerification(id){
      selectedVehicle = vehicles.find(v => v.id === id);
      document.getElementById('verificationForm').style.display = 'block';
      renderVehicleSelector();
      renderVerifications();
    }

    document.getElementById('addVerificationForm').addEventListener('submit', function(e){
      e.preventDefault();
      if(!selectedVehicle) return;

      const data = {
        type: document.getElementById('verificationType').value,
        date: document.getElementById('verificationDate').value,
        nextDate: document.getElementById('verificationNext').value,
        amount: document.getElementById('verificationAmount').value,
        notes: document.getElementById('verificationNotes').value
      };

      // ‚úÖ Modo edici√≥n
      if(editingVerification && editingVerification.recordId && editingVerification.vehicleId === selectedVehicle.id){
        const vid = editingVerification.vehicleId;
        const rid = editingVerification.recordId;
        const list = verifications[vid] || [];
        const idx = list.findIndex(r => r.id === rid);
        if(idx !== -1){
          const prev = list[idx];
          list[idx] = { ...prev, ...data }; // conserva completed/completedDate
          verifications[vid] = list;
          localStorage.setItem('verifications', JSON.stringify(verifications));

          editingVerification = { vehicleId: null, recordId: null };
          setVerificationFormMode(false);
          this.reset();

          renderVerificationsFor(vid);
          checkVerificationAlerts();
          renderDashboard();
          renderVehicles();
          showAlert('success', 'Registro actualizado correctamente');
        }
        return;
      }

      // ‚úÖ Alta normal
      const verification = {
        id: Date.now(),
        ...data,
        completed: false,
        completedDate: ''
      };

      if(!verifications[selectedVehicle.id]) verifications[selectedVehicle.id] = [];
      verifications[selectedVehicle.id].push(verification);
      localStorage.setItem('verifications', JSON.stringify(verifications));

      this.reset();
      renderVerificationsFor(selectedVehicle.id);
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('success', 'Registro agregado correctamente');
    });


    function renderVerificationsFor(vehicleId){
      // Contenedor en cascada (por veh√≠culo). Si no existe, cae a legacy (si alg√∫n d√≠a se usa).
      const container = document.getElementById(`veriList-${vehicleId}`) || document.getElementById('verificationList');
      if(!container) return;

      const list = (verifications[vehicleId] || []);
      if(list.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay registros para este veh√≠culo</p></div>';
        return;
      }

      // ‚úÖ FIX sort: usar parse local
      const records = list.slice().sort((a,b) =>
        (parseISODateLocal(b.nextDate || b.date) - parseISODateLocal(a.nextDate || a.date))
      );

      container.innerHTML = records.map(record => {
        const typeNames = { verificacion:'‚úÖ Verificaci√≥n', tenencia:'üí∞ Tenencia', multa:'‚ö†Ô∏è Multa' };

        let statusBadge = '';
        if(record.completed){
          statusBadge = '<span class="badge badge-success">TERMINADO</span>';
        }else if(record.nextDate){
          const daysUntil = calcDaysUntil(record.nextDate);
          if(daysUntil < 0) statusBadge = '<span class="badge badge-danger">Vencido</span>';
          else if(daysUntil <= 30) statusBadge = '<span class="badge badge-warning">Pr√≥ximo</span>';
          else statusBadge = '<span class="badge badge-success">Al d√≠a</span>';
        }

        return `
          <div class="verification-item">
            <div class="item-info">
              <h4>${typeNames[record.type] || record.type} ${statusBadge}</h4>
              <p>Fecha: ${formatDateMX(record.date)}</p>
              ${record.nextDate ? `<p>Pr√≥xima: ${formatDateMX(record.nextDate)} (${calcDaysUntil(record.nextDate)} d√≠as)</p>` : ''}
              ${record.amount ? `<p>Monto: $${Number(record.amount).toFixed(2)}</p>` : ''}
              ${record.notes ? `<p><em>${escapeHtml(record.notes)}</em></p>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-small btn-secondary" onclick="editVerification(${vehicleId}, ${record.id})">Editar</button>
              <button class="btn btn-small btn-success" onclick="toggleVerificationComplete(${vehicleId}, ${record.id})">${record.completed ? 'Reabrir' : 'Completar'}</button>
              <button class="btn btn-small btn-danger" onclick="deleteVerification(${vehicleId}, ${record.id})">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderVerifications(){
      if(!selectedVehicle) return;
      renderVerificationsFor(selectedVehicle.id);
    }

    function closeAllVerificationPanels(){
      document.querySelectorAll('[id^="veriPanel-"]').forEach(p => { p.style.display = 'none'; });
    }

    function toggleVerificationPanel(vehicleId, forceClose=false){
      const panel = document.getElementById(`veriPanel-${vehicleId}`);
      if(!panel) return;

      const wasOpen = panel.style.display !== 'none';

      // Accordion: cierra todos antes de abrir uno
      closeAllVerificationPanels();

      if(forceClose || wasOpen){
        window.__openVeriVehicleId = null;
        selectedVehicle = null;
        editingVerification = { vehicleId: null, recordId: null };
        setVerificationFormMode(false);
        document.getElementById('verificationForm').style.display = 'none';
        return;
      }

      panel.style.display = 'block';
      window.__openVeriVehicleId = vehicleId;

      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;
      document.getElementById('verificationForm').style.display = 'block';

      renderVerificationsFor(vehicleId);
    }

    function openAddVerificationFor(vehicleId){
      // Asegura panel abierto y veh√≠culo seleccionado
      if(window.__openVeriVehicleId !== vehicleId){
        toggleVerificationPanel(vehicleId);
      }
      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;

      // reset modo edici√≥n
      editingVerification = { vehicleId: null, recordId: null };
      setVerificationFormMode(false);
      const formEl = document.getElementById('addVerificationForm');
      if(formEl) formEl.reset();

      const formWrap = document.getElementById('verificationForm');
      formWrap.style.display = 'block';
      formWrap.scrollIntoView({behavior:'smooth', block:'start'});
    }
      

    function toggleVerificationComplete(vehicleId, recordId){
      const list = verifications[vehicleId] || [];
      const idx = list.findIndex(r => r.id === recordId);
      if(idx === -1) return;

      if(list[idx].completed){
        list[idx].completed = false;
        list[idx].completedDate = '';
        showAlert('info', 'Registro reabierto');
      }else{
        list[idx].completed = true;
        list[idx].completedDate = ymd(new Date());
        showAlert('success', 'Registro marcado como TERMINADO');
      }

      verifications[vehicleId] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerificationsFor(vehicleId);
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
    }

function editVerification(vehicleId, recordId){
      const list = verifications[vehicleId] || [];
      const rec = list.find(r => r.id === recordId);
      if(!rec) return;

      // Abre panel y form
      if(window.__openVeriVehicleId !== vehicleId){
        toggleVerificationPanel(vehicleId);
      }
      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;

      document.getElementById('verificationForm').style.display = 'block';
      setVerificationFormMode(true);
      editingVerification = { vehicleId, recordId };

      // Poblar campos
      document.getElementById('verificationType').value = rec.type || '';
      document.getElementById('verificationDate').value = rec.date || '';
      document.getElementById('verificationNext').value = rec.nextDate || '';
      document.getElementById('verificationAmount').value = rec.amount || '';
      document.getElementById('verificationNotes').value = rec.notes || '';

      const formWrap = document.getElementById('verificationForm');
      formWrap.scrollIntoView({behavior:'smooth', block:'start'});
    }

function deleteVerification(vehicleId, id){
      // Soporta: deleteVerification(id) (legacy con selectedVehicle) y deleteVerification(vehicleId, id)
      const vid = (typeof id === 'undefined') ? (selectedVehicle ? selectedVehicle.id : null) : vehicleId;
      const rid = (typeof id === 'undefined') ? vehicleId : id;
      if(!vid) return;

      if(confirm('¬øEliminar este registro?')){
        verifications[vid] = (verifications[vid] || []).filter(v => v.id !== rid);
        localStorage.setItem('verifications', JSON.stringify(verifications));
        renderVerificationsFor(vid);
        checkVerificationAlerts();
        renderDashboard();
        renderVehicles();
      }
}

    // ‚úÖ NUEVO: terminar / reabrir registro
    function terminateVerification(id){
      if(!selectedVehicle) return;

      const list = verifications[selectedVehicle.id] || [];
      const idx = list.findIndex(r => r.id === id);
      if(idx === -1) return;

      const today = ymd(new Date());
      list[idx].completed = true;
      list[idx].completedDate = today;

      verifications[selectedVehicle.id] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerifications();
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('success', 'Registro marcado como TERMINADO');
    }

    function reopenVerification(id){
      if(!selectedVehicle) return;

      const list = verifications[selectedVehicle.id] || [];
      const idx = list.findIndex(r => r.id === id);
      if(idx === -1) return;

      list[idx].completed = false;
      list[idx].completedDate = '';

      verifications[selectedVehicle.id] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerifications();
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('warning', 'Registro reabierto');
    }

    function checkVerificationAlerts(){
      const container = document.getElementById('verificationAlerts');
      if(!container) return;
      const alerts = [];

      vehicles.forEach(vehicle => {
        if(verifications[vehicle.id]){
          verifications[vehicle.id].forEach(record => {
            // ‚úÖ NUEVO: ignorar terminados en alertas
            if(record && record.nextDate && !record.completed){
              const daysUntil = calcDaysUntil(record.nextDate);
              if(daysUntil === null) return;

              if(daysUntil < 0) alerts.push({ type:'danger', message:`${vehicle.name}: ${typeLabel(record.type)} VENCIDA desde ${Math.abs(daysUntil)} d√≠as` });
              else if(daysUntil <= 30) alerts.push({ type:'warning', message:`${vehicle.name}: ${typeLabel(record.type)} pr√≥xima en ${daysUntil} d√≠as` });
            }
          });
        }
      });

      if(alerts.length > 0){
        container.innerHTML = alerts.map(a => `<div class="alert alert-${a.type}">‚ö†Ô∏è ${escapeHtml(a.message)}</div>`).join('');
      }else{
        container.innerHTML = '';
      }
    }

    // =========================
    // Mantenimientos
    // =========================
    function renderMaintenanceVehicleSelector(){
      const container = document.getElementById('maintenanceVehicleSelector');
      if(vehicles.length === 0){
        container.innerHTML = '<p class="empty-state">No hay veh√≠culos registrados. Agrega un veh√≠culo primero.</p>';
        document.getElementById('maintenanceForm').style.display = 'none';
        return;
      }

      container.innerHTML = `
        <div class="vehicle-list">
          ${vehicles.map(vehicle => {
            const isSel = selectedVehicle && selectedVehicle.id === vehicle.id;
            const title = (vehicle.plates && vehicle.plates.trim()) ? vehicle.plates.trim() : vehicle.name;
            const mainTitle = title;
            const status = getVehicleStatusWithDays(vehicle.id);
            const imgSrc = vehicle.image || getCarSvgDataUri(colorToHex(vehicle.color || "Rojo"));

            
            const dn = getDriverNameForVehicle(vehicle.id);
            const driverLine = dn ? `<div class="vehicle-subtitle">üë§ ${escapeHtml(dn)}</div>` : '';
const cat = (vehicle.category === 'Trabajo')
              ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>`
              : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

            const sub = `${escapeHtml(vehicle.name)} <span class="bullet">¬∑</span> ${escapeHtml(vehicle.year)} <span class="bullet">¬∑</span> ${escapeHtml(vehicle.color)}`;

            return `
              <div class="vehicle-row ${isSel ? 'selected' : ''}" onclick="selectVehicleForMaintenance(${vehicle.id})">
                <div class="vehicle-row-top">
                  <div>
                    <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                    <div class="vehicle-subtitle">${sub}</div>
                ${driverLine}
                  </div>
                  <div class="vehicle-carimg">
                    <img src="${imgSrc}" alt="auto">
                  </div>
                </div>
                <div class="vehicle-row-bottom">
                  <div class="status">
                    <span class="dot ${status.dotClass}"></span>
                    <div class="status-text">
                      <div>${status.label}</div>
                      <small>${status.detail}</small>
                    </div>
                  </div>
                  <div class="row-actions">
                    <span class="chev">‚Ä∫</span>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      if(selectedVehicle) renderMaintenances();
    }

    function selectVehicleForMaintenance(id){
      selectedVehicle = vehicles.find(v => v.id === id);
      document.getElementById('maintenanceForm').style.display = 'block';
      renderMaintenanceVehicleSelector();
      renderMaintenances();
    }

    document.getElementById('addMaintenanceForm').addEventListener('submit', function(e){
      e.preventDefault();
      if(!selectedVehicle) return;

      const maintenance = {
        id: Date.now(),
        type: document.getElementById('maintenanceType').value,
        description: document.getElementById('maintenanceDescription').value,
        date: document.getElementById('maintenanceDate').value,
        cost: document.getElementById('maintenanceCost').value,
        km: document.getElementById('maintenanceKm').value
      };

      if(!maintenances[selectedVehicle.id]) maintenances[selectedVehicle.id] = [];
      maintenances[selectedVehicle.id].push(maintenance);
      localStorage.setItem('maintenances', JSON.stringify(maintenances));

      this.reset();
      renderMaintenances();
      renderDashboard();
      renderVehicles();
      renderWorkCarsModule();
      recalcWeekTotalsSoft();
      showAlert('success', 'Mantenimiento registrado correctamente');
    });


    // =========================
    // Form Choferes (Autos de trabajo)
    // =========================
    (function(){
      const drvForm = document.getElementById('driverForm');
      if(!drvForm) return;

      // poblar select al iniciar
      populateDriverVehicleSelect();
      renderDriversList();

      drvForm.addEventListener('submit', function(e){
        e.preventDefault();

        const idField = document.getElementById('drvId');
        const editingId = (idField && idField.value) ? String(idField.value) : '';

        const data = {
          id: editingId ? Number(editingId) : Date.now(),
          name: (document.getElementById('drvName').value || '').trim(),
          phone: (document.getElementById('drvPhone').value || '').trim(),
          email: (document.getElementById('drvEmail').value || '').trim(),
          address: (document.getElementById('drvAddress').value || '').trim(),
          vehicleId: (document.getElementById('drvVehicle').value || '').trim(),
          startDate: (document.getElementById('drvStart').value || '').trim(),
          endDate: (document.getElementById('drvEnd').value || '').trim(),
          notes: (document.getElementById('drvNotes').value || '').trim(),
          refName: (document.getElementById('refName').value || '').trim(),
          refPhone: (document.getElementById('refPhone').value || '').trim(),
        };

        if(!data.name){
          alert('Ingresa el nombre del chofer.');
          return;
        }

        // Guardar/actualizar chofer
        const idx = (drivers || []).findIndex(d => String(d.id) === String(data.id));
        if(idx === -1){
          drivers.push(data);
        }else{
          // si cambi√≥ de veh√≠culo, limpiar v√≠nculos previos
          const prevVehicleId = (drivers[idx].vehicleId || '').toString();
          drivers[idx] = {...drivers[idx], ...data};
          if(prevVehicleId && prevVehicleId !== data.vehicleId){
            const oldV = (vehicles || []).find(x => String(x.id) === String(prevVehicleId));
            if(oldV && String(oldV.driverId) === String(data.id)) delete oldV.driverId;
          }
        }

        // Sincronizar v√≠nculo bidireccional
        if(data.vehicleId){
          linkDriverToVehicle(data.id, data.vehicleId);
        }else{
          // quitar driverId de cualquier veh√≠culo que lo tenga
          (vehicles || []).forEach(v => {
            if(String(v.driverId || '') === String(data.id)) delete v.driverId;
          });
          const d = getDriverById(data.id);
          if(d) d.vehicleId = '';
        }

        saveDrivers();
        localStorage.setItem('vehicles', JSON.stringify(vehicles || []));

        resetDriverForm();
        renderDriversList();
        renderWorkCarsHome();
        renderWeekDetailCards();
        alert('Chofer guardado.');
      });
    })();

    function renderMaintenances(){
      const container = document.getElementById('maintenanceList');
      if(!container) return;

      if(!selectedVehicle || !maintenances[selectedVehicle.id] || maintenances[selectedVehicle.id].length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay mantenimientos registrados para este veh√≠culo</p></div>';
        return;
      }

      // ‚úÖ FIX sort: usar parse local
      const records = maintenances[selectedVehicle.id].sort((a,b) =>
        (parseISODateLocal(b.date) - parseISODateLocal(a.date))
      );

      const typeNames = {
        cambio_aceite:'üõ¢Ô∏è Cambio de Aceite', afinacion:'‚öôÔ∏è Afinaci√≥n', frenos:'üõë Frenos', llantas:'üöó Llantas',
        suspension:'üîß Suspensi√≥n', bateria:'üîã Bater√≠a', transmision:'‚ö° Transmisi√≥n', aire_acondicionado:'‚ùÑÔ∏è Aire Acondicionado', otro:'üî® Otro'
      };

      container.innerHTML = records.map(record => `
        <div class="maintenance-item">
          <div class="item-info">
            <h4>${typeNames[record.type] || record.type}</h4>
            <p>${escapeHtml(record.description)}</p>
            <p>üìÖ ${formatDateMX(record.date)}
              ${record.cost ? ` ‚Ä¢ üí∞ $${parseFloat(record.cost).toFixed(2)}` : ''}
              ${record.km ? ` ‚Ä¢ üõ£Ô∏è ${escapeHtml(record.km)} km` : ''}</p>
          </div>
          <button class="btn btn-danger" onclick="deleteMaintenance(${record.id})" style="padding:.55rem 1rem;">Eliminar</button>
        </div>
      `).join('');
    }

    function deleteMaintenance(id){
      if(!selectedVehicle) return;
      if(confirm('¬øEliminar este registro de mantenimiento?')){
        maintenances[selectedVehicle.id] = maintenances[selectedVehicle.id].filter(m => m.id !== id);
        localStorage.setItem('maintenances', JSON.stringify(maintenances));
        renderMaintenances();
        renderDashboard();
        renderVehicles();
        renderWorkCarsModule();
        recalcWeekTotalsSoft();
      }
    }

    // =========================
    // Autos de trabajo
    // =========================
    function showWorkTab(tab){
      workTab = tab;
            const bHome = document.getElementById('workTabHome');
      const bGains = document.getElementById('workTabGains');
      const bDrivers = document.getElementById('workTabDrivers');

      if(bHome) bHome.classList.toggle('active', tab === 'home');
      if(bGains) bGains.classList.toggle('active', tab === 'gains');
      if(bDrivers) bDrivers.classList.toggle('active', tab === 'drivers');

      const pHome = document.getElementById('workHome');
      const pGains = document.getElementById('workGains');
      const pDrivers = document.getElementById('workDrivers');

      if(pHome) pHome.style.display = (tab === 'home') ? 'block' : 'none';
      if(pGains) pGains.style.display = (tab === 'gains') ? 'block' : 'none';
      if(pDrivers) pDrivers.style.display = (tab === 'drivers') ? 'block' : 'none';

      if(tab === 'home'){
        renderWorkCarsHome();
      }else if(tab === 'gains'){
        renderWorkGains();
      }else{
        renderWorkDrivers();
      }
    }

    function getWorkVehicles(){
      return (vehicles || []).filter(v => (v.category || 'Particular') === 'Trabajo');
    }

    
    // =========================
    // Choferes (Drivers)
    // =========================
    function saveDrivers(){
      localStorage.setItem('drivers', JSON.stringify(drivers || []));
    }

    function getDriverById(id){
      return (drivers || []).find(d => String(d.id) === String(id)) || null;
    }

    function getDriverByVehicleId(vehicleId){
      const vId = String(vehicleId);
      return (drivers || []).find(d => String(d.vehicleId || '') === vId) || null;
    }

    function getDriverNameForVehicle(vehicleId){
      const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
      const d = v && v.driverId ? getDriverById(v.driverId) : getDriverByVehicleId(vehicleId);
      return d ? (d.name || '') : '';
    }

    function populateDriverVehicleSelect(){
      const sel = document.getElementById('drvVehicle');
      if(!sel) return;
      const current = sel.value;
      const workCars = getWorkVehicles();
      sel.innerHTML = '<option value="">Sin asignar</option>' + workCars.map(v => {
        const title = (v.name || 'Veh√≠culo') + (v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : '');
        return `<option value="${v.id}">${title}</option>`;
      }).join('');
      if([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function unlinkDriverFromVehicle(vehicleId){
      const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
      if(v && v.driverId){
        const d = getDriverById(v.driverId);
        if(d) d.vehicleId = '';
      }
      if(v) delete v.driverId;
    }

    function linkDriverToVehicle(driverId, vehicleId){
      const d = getDriverById(driverId);
      if(!d) return;

      // Si el veh√≠culo ya ten√≠a chofer, lo desvinculamos
      if(vehicleId){
        const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
        if(v && v.driverId && String(v.driverId) !== String(driverId)){
          const prev = getDriverById(v.driverId);
          if(prev) prev.vehicleId = '';
        }
        if(v) v.driverId = driverId;
      }

      // Si el chofer estaba ligado a otro veh√≠culo, lo limpiamos
      if(d.vehicleId && vehicleId && String(d.vehicleId) !== String(vehicleId)){
        const oldV = (vehicles || []).find(x => String(x.id) === String(d.vehicleId));
        if(oldV && String(oldV.driverId) === String(driverId)) delete oldV.driverId;
      }

      d.vehicleId = vehicleId || '';
    }

    function resetDriverForm(){
      const form = document.getElementById('driverForm');
      if(form) form.reset();
      const id = document.getElementById('drvId');
      if(id) id.value = '';
      populateDriverVehicleSelect();
    }

    function fillDriverForm(d){
      document.getElementById('drvId').value = d ? String(d.id) : '';
      document.getElementById('drvName').value = d?.name || '';
      document.getElementById('drvPhone').value = d?.phone || '';
      document.getElementById('drvEmail').value = d?.email || '';
      document.getElementById('drvAddress').value = d?.address || '';
      document.getElementById('drvVehicle').value = d?.vehicleId ? String(d.vehicleId) : '';
      document.getElementById('drvStart').value = d?.startDate || '';
      document.getElementById('drvEnd').value = d?.endDate || '';
      document.getElementById('drvNotes').value = d?.notes || '';
      document.getElementById('refName').value = d?.refName || '';
      document.getElementById('refPhone').value = d?.refPhone || '';
    }

    function renderDriversList(){
      const list = document.getElementById('driversList');
      if(!list) return;
      if(!drivers || drivers.length === 0){
        list.innerHTML = '<div class="empty-state"><p>No hay choferes registrados.</p></div>';
        return;
      }

      list.innerHTML = drivers
        .slice()
        .sort((a,b) => (a.endDate ? 1 : 0) - (b.endDate ? 1 : 0))
        .map(d => {
          const v = d.vehicleId ? (vehicles || []).find(x => String(x.id) === String(d.vehicleId)) : null;
          const vLabel = v ? `${escapeHtml(v.name || 'Veh√≠culo')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}` : 'Sin asignar';
          const active = d.endDate ? 'Inactivo' : 'Activo';
          return `
            <div class="maintenance-item" style="gap:.75rem;">
              <div style="flex:1;">
                <div style="font-weight:900; color:#fff;">${escapeHtml(d.name || 'Chofer')}</div>
                <div style="color:rgba(255,255,255,0.75); font-weight:800; margin-top:.1rem;">
                  ${escapeHtml(active)} ‚Ä¢ Veh√≠culo: <b>${vLabel}</b>
                </div>
                ${d.phone ? `<div style="color:rgba(255,255,255,0.65); font-weight:800;">üì± ${escapeHtml(d.phone)}</div>` : ''}
                ${d.address ? `<div style="color:rgba(255,255,255,0.65); font-weight:800;">üìç ${escapeHtml(d.address)}</div>` : ''}
              </div>
              <div style="display:flex; flex-direction:column; gap:.5rem; min-width:170px;">
                <button class="btn btn-secondary" type="button" onclick="editDriver('${d.id}')">Editar</button>
                <button class="btn btn-danger" type="button" onclick="deleteDriver('${d.id}')">Eliminar</button>
              </div>
            </div>
          `;
        }).join('');
    }

    function editDriver(id){
      const d = getDriverById(id);
      if(!d) return;
      showWorkTab('drivers');
      populateDriverVehicleSelect();
      fillDriverForm(d);
      window.scrollTo({top: 0, behavior:'smooth'});
    }

    function deleteDriver(id){
      const d = getDriverById(id);
      if(!d) return;
      if(!confirm('¬øEliminar chofer?')) return;

      // Desvincular del veh√≠culo
      if(d.vehicleId){
        const v = (vehicles || []).find(x => String(x.id) === String(d.vehicleId));
        if(v && String(v.driverId) === String(d.id)) delete v.driverId;
      }

      drivers = (drivers || []).filter(x => String(x.id) !== String(id));
      saveDrivers();
      localStorage.setItem('vehicles', JSON.stringify(vehicles || []));
      resetDriverForm();
      renderDriversList();
      renderWorkCarsHome();
      renderWeekDetailCards();
    }

    function renderWorkDrivers(){
      populateDriverVehicleSelect();
      renderDriversList();
    }function renderWorkCarsModule(){
      if(!document.getElementById('workcars').classList.contains('active')) return;

      const monthInput = document.getElementById('gainsMonth');
      if(!monthInput.value){
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }
      selectedMonthISO = monthInput.value;

      const weeks = computeWeeksForMonth(selectedMonthISO);
      if(!selectedWeekStartISO && weeks.length) selectedWeekStartISO = weeks[0].startISO;

      if(workTab === 'home') renderWorkCarsHome();
      else if(workTab === 'gains') renderWorkGains();
      else renderWorkDrivers();
    }

    function renderWorkCarsHome(){
      const grid = document.getElementById('workVehiclesGrid');
      const workCars = getWorkVehicles();

      if(workCars.length === 0){
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <b>Trabajo</b>.</p></div>';
      }else{
        grid.innerHTML = workCars.map(v => {
          const title = v.name || 'Veh√≠culo';
          const dname = getDriverNameForVehicle(v.id);
          const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}${dname ? ` ‚Ä¢ Chofer: ${escapeHtml(dname)}` : ''}`;
          return `
            <div class="work-card">
              <h4>${escapeHtml(title)}</h4>
              <p>${sub}</p>
              <span class="cat">Categor√≠a: Trabajo</span>
            </div>
          `;
        }).join('');
      }

      renderProfitabilityAllTime();
    }

    // ===== Semanas (Lunes‚ÜíDomingo) por mes =====
    function computeWeeksForMonth(monthISO){
      const [yy, mm] = monthISO.split('-').map(x => parseInt(x,10));
      const firstDay = new Date(yy, mm-1, 1);

      // primer lunes dentro del mes
      let d = new Date(firstDay);
      while(d.getDay() !== 1){
        d.setDate(d.getDate()+1);
      }

      const weeks = [];
      let idx = 1;

      while(d.getMonth() === (mm-1)){
        const start = new Date(d);
        const end = new Date(d);
        end.setDate(end.getDate() + 6);

        weeks.push({
          idx,
          startISO: ymd(start),
          endISO: ymd(end),
          start,
          end
        });

        idx++;
        d.setDate(d.getDate()+7);
      }

      return weeks;
    }

    // ‚úÖ FIX: prettyRange basado en parse local
    function prettyRange(startISO, endISO){
      const s = parseISODateLocal(startISO);
      const e = parseISODateLocal(endISO);
      return `${s.toLocaleDateString('es-MX')} ‚Üí ${e.toLocaleDateString('es-MX')}`;
    }

    function renderWorkGains(){
      const monthInput = document.getElementById('gainsMonth');
      monthInput.onchange = () => {
        selectedMonthISO = monthInput.value;
        const weeks = computeWeeksForMonth(selectedMonthISO);
        selectedWeekStartISO = weeks.length ? weeks[0].startISO : '';
        renderWorkGains();
      };

      selectedMonthISO = monthInput.value;
      const weeks = computeWeeksForMonth(selectedMonthISO);

      const weeksGrid = document.getElementById('weeksGrid');
      if(weeks.length === 0){
        weeksGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay semanas para este mes.</p></div>';
      }else{
        if(!selectedWeekStartISO) selectedWeekStartISO = weeks[0].startISO;

        weeksGrid.innerHTML = weeks.map(w => {
          const active = (w.startISO === selectedWeekStartISO);
          return `
            <div class="week-tile ${active ? 'active' : ''}" onclick="selectWeek('${w.startISO}')">
              <div class="wk-title">Semana ${w.idx}</div>
              <div class="wk-range">${prettyRange(w.startISO, w.endISO)}</div>
            </div>
          `;
        }).join('');
      }

      renderWeekDetailCards();
      scheduleWeekRefresh();
    }

    function selectWeek(weekStartISO){
      selectedWeekStartISO = weekStartISO;
      renderWorkGains();
    }

    // ‚úÖ FIX: rango de semana con parse local
    function getWeekRangeFromStartISO(weekStartISO){
      const s = parseISODateLocal(weekStartISO);
      const e = parseISODateLocal(weekStartISO);
      e.setDate(e.getDate() + 6);
      return { start:s, end:e, startISO: ymd(s), endISO: ymd(e) };
    }

    // ‚úÖ FIX: evaluaci√≥n por rango con parse local
    function isDateInRange(dateISO, start, end){
      if(!dateISO) return false;

      const d = parseISODateLocal(dateISO);
      if(!d) return false;

      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const ss = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const ee = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      return dd >= ss && dd <= ee;
    }

    function getMaintenanceInWeek(vehicleId, weekStartISO){
      const { start, end } = getWeekRangeFromStartISO(weekStartISO);
      const list = (maintenances && maintenances[vehicleId]) ? maintenances[vehicleId] : [];
      const filtered = list.filter(m => m && m.date && isDateInRange(m.date, start, end));
      const total = filtered.reduce((acc, m) => acc + safeNumber(m.cost), 0);
      return { items: filtered, total };
    }

    function getPayment(vehicleId, weekStartISO){
      const byWeek = workPayments[vehicleId] || {};
      const v = byWeek[weekStartISO];
      return (v === undefined || v === null) ? '' : String(v);
    }

    function setPayment(vehicleId, weekStartISO, valueStr){
      if(!workPayments[vehicleId]) workPayments[vehicleId] = {};
      const trimmed = String(valueStr ?? '').trim();

      if(trimmed === ''){
        delete workPayments[vehicleId][weekStartISO];
      }else{
        const num = safeNumber(trimmed);
        workPayments[vehicleId][weekStartISO] = num;
      }
      localStorage.setItem('workPayments', JSON.stringify(workPayments));
    }

    function renderWeekDetailCards(){
      const workCars = getWorkVehicles();
      const cards = document.getElementById('gainCards');

      if(!selectedWeekStartISO){
        cards.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>Selecciona una semana.</p></div>';
        updateKPIs(0,0,0);
        renderProfitabilityWeek();
        return;
      }

      if(workCars.length === 0){
        cards.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos de <b>Trabajo</b>.</p></div>';
        updateKPIs(0,0,0);
        renderProfitabilityWeek();
        return;
      }

      const weekKey = selectedWeekStartISO;

      cards.innerHTML = workCars.map(v => {
        const title = v.name || 'Veh√≠culo';
        const dname = getDriverNameForVehicle(v.id);
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}${dname ? ` ‚Ä¢ Chofer: ${escapeHtml(dname)}` : ''}`;

        const m = getMaintenanceInWeek(v.id, weekKey);
        const payVal = getPayment(v.id, weekKey);

        const maintText = m.items.length
          ? ('<br>' + m.items.map(it => `‚Ä¢ ${(it.type || 'otro')} ‚Äî ${money(it.cost)} (${formatDateMX(it.date)})`).join('<br>'))
          : 'Sin mantenimientos en esta semana.';

        return `
          <div class="gain-card" data-vid="${v.id}">
            <h4>${escapeHtml(title)}</h4>
            <div class="gain-sub">${sub}</div>

            <div class="gain-label">Pago del chofer (esta semana)</div>
            <input
              class="pay-input"
              inputmode="numeric"
              autocomplete="off"
              placeholder="0"
              value="${escapeHtml(payVal)}"
              data-week="${weekKey}"
              data-vid="${v.id}"
              oninput="onPayInput(this)"
            />

            <div class="row-kv">
              <div>Mantenimientos (semana)</div>
              <div>${money(m.total)}</div>
            </div>

            <div class="row-kv" style="margin-top:.5rem;">
              <div>Ganancia real <small>Neto</small></div>
              <div class="net-val" id="net_${v.id}">${money(safeNumber(payVal) - m.total)}</div>
            </div>

            <div class="details">
              <div style="opacity:.9; font-weight:900; margin-top:.65rem;">Detalle mantenimientos:</div>
              ${maintText}
            </div>
          </div>
        `;
      }).join('');

      recalcWeekTotalsSoft();
      renderProfitabilityWeek();
    }

    function onPayInput(el){
      const vid = Number(el.dataset.vid);
      const wk = el.dataset.week;

      setPayment(vid, wk, el.value);

      recalcWeekTotalsSoft();
      scheduleAllTimeRefresh();
      scheduleWeekRefresh();
    }

    function updateKPIs(inTotal, outTotal, netTotal){
      document.getElementById('kpiIn').textContent = money(inTotal);
      document.getElementById('kpiOut').textContent = money(outTotal);
      document.getElementById('kpiNet').textContent = money(netTotal);
    }

    function recalcWeekTotalsSoft(){
      if(!document.getElementById('workcars').classList.contains('active')) return;
      if(workTab !== 'gains') return;
      if(!selectedWeekStartISO) return;

      const weekKey = selectedWeekStartISO;
      const workCars = getWorkVehicles();

      let totalIn = 0;
      let totalOut = 0;

      workCars.forEach(v => {
        const input = document.querySelector(`.pay-input[data-vid="${v.id}"][data-week="${weekKey}"]`);
        const pay = input ? safeNumber(input.value) : safeNumber(getPayment(v.id, weekKey));
        const m = getMaintenanceInWeek(v.id, weekKey);
        const net = pay - m.total;

        totalIn += pay;
        totalOut += m.total;

        const netEl = document.getElementById(`net_${v.id}`);
        if(netEl) netEl.textContent = money(net);
      });

      updateKPIs(totalIn, totalOut, totalIn - totalOut);
    }

    // =========================
    // Rentabilidad (pies) - dibujado
    // =========================
    function drawPie(canvas, entrada, salida){
      const ctx = canvas.getContext('2d');
      const w = canvas.width = 160;
      const h = canvas.height = 160;

      ctx.clearRect(0,0,w,h);

      const inVal = Math.max(0, safeNumber(entrada));
      const outVal = Math.max(0, safeNumber(salida));
      const total = inVal + outVal;

      const cx = w/2, cy = h/2, r = 62;

      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fill();

      if(total <= 0){
        ctx.fillStyle = 'rgba(255,255,255,0.75)';
        ctx.font = '900 22px "Space Mono", monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('0%', cx, cy);
        return;
      }

      const start = -Math.PI/2;
      const inAng = (inVal/total) * Math.PI*2;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+inAng);
      ctx.closePath();
      ctx.fillStyle = '#3b82f6';
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start+inAng,start+Math.PI*2);
      ctx.closePath();
      ctx.fillStyle = '#f59e0b';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx,cy,40,0,Math.PI*2);
      ctx.fillStyle = 'rgba(10,14,39,0.85)';
      ctx.fill();

      const inPct = Math.round((inVal/total)*100);
      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.font = '900 26px "Space Mono", monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(inPct + '%', cx, cy);
    }

    // =========================
    // Rentabilidad ALL TIME (hist√≥rico)
    // =========================
    let allTimeRAF = null;
    function scheduleAllTimeRefresh(){
      if(allTimeRAF) cancelAnimationFrame(allTimeRAF);
      allTimeRAF = requestAnimationFrame(() => {
        allTimeRAF = null;
        if(document.getElementById('workcars').classList.contains('active')){
          renderProfitabilityAllTime();
        }
      });
    }

    function sumAllPaymentsForVehicle(vehicleId){
      const byWeek = workPayments[vehicleId] || {};
      return Object.values(byWeek).reduce((acc, val) => acc + safeNumber(val), 0);
    }

    function sumAllMaintForVehicle(vehicleId){
      const list = (maintenances && maintenances[vehicleId]) ? maintenances[vehicleId] : [];
      return list.reduce((acc, m) => acc + safeNumber(m.cost), 0);
    }

    function renderProfitabilityAllTime(){
      const grid = document.getElementById('profitAllTimeGrid');
      if(!grid) return;

      const workCars = getWorkVehicles();
      if(workCars.length === 0){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <strong>Trabajo</strong>.</p></div>`;
        return;
      }

      let totalIn = 0;
      let totalOut = 0;

      const perCar = workCars.map(v => {
        const entrada = sumAllPaymentsForVehicle(v.id);
        const salida = sumAllMaintForVehicle(v.id);
        const neto = entrada - salida;
        totalIn += entrada;
        totalOut += salida;
        return { v, entrada, salida, neto };
      });

      const totalNet = totalIn - totalOut;

      const cards = [];

      cards.push(`
        <div class="profit-card">
          <div class="pie-wrap">
            <canvas id="pie_total"></canvas>
            <div class="pie-label">Total</div>
          </div>
          <div class="profit-meta">
            <div class="profit-title">Total (todos)</div>
            <div class="kv">
              <span><i class="dot-mini dot-in"></i>Entrada: ${money(totalIn)}</span>
              <span><i class="dot-mini dot-out"></i>Salida: ${money(totalOut)}</span>
              <span class="${totalNet < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(totalNet)}</span>
            </div>
          </div>
        </div>
      `);

      perCar.forEach(({v, entrada, salida, neto}, idx) => {
        const title = v.name || 'Veh√≠culo';
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}`;

        cards.push(`
          <div class="profit-card">
            <div class="pie-wrap">
              <canvas id="pie_${idx}"></canvas>
              <div class="pie-label">${escapeHtml(title)}</div>
            </div>
            <div class="profit-meta">
              <div class="profit-title">${escapeHtml(title)}</div>
              <div class="profit-sub">${sub}</div>
              <div class="kv">
                <span><i class="dot-mini dot-in"></i>Entrada: ${money(entrada)}</span>
                <span><i class="dot-mini dot-out"></i>Salida: ${money(salida)}</span>
                <span class="${neto < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(neto)}</span>
              </div>
            </div>
          </div>
        `);
      });

      grid.innerHTML = cards.join('');

      const cTotal = document.getElementById('pie_total');
      if(cTotal) drawPie(cTotal, totalIn, totalOut);

      perCar.forEach(({entrada, salida}, idx) => {
        const c = document.getElementById(`pie_${idx}`);
        if(c) drawPie(c, entrada, salida);
      });
    }

    // =========================
    // Rentabilidad por SEMANA
    // =========================
    let weekRAF = null;
    function scheduleWeekRefresh(){
      if(weekRAF) cancelAnimationFrame(weekRAF);
      weekRAF = requestAnimationFrame(() => {
        weekRAF = null;
        if(document.getElementById('workcars').classList.contains('active') && workTab === 'gains'){
          renderProfitabilityWeek();
        }
      });
    }

    function getWeekPaymentLive(vehicleId, weekStartISO){
      const input = document.querySelector(`.pay-input[data-vid="${vehicleId}"][data-week="${weekStartISO}"]`);
      if(input) return safeNumber(input.value);
      return safeNumber(getPayment(vehicleId, weekStartISO));
    }

    function renderProfitabilityWeek(){
      const grid = document.getElementById('profitWeekGrid');
      if(!grid) return;

      const workCars = getWorkVehicles();
      const weekKey = selectedWeekStartISO;

      if(!weekKey){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>Selecciona una semana para ver la rentabilidad visual.</p></div>`;
        return;
      }

      if(workCars.length === 0){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <strong>Trabajo</strong>.</p></div>`;
        return;
      }

      let totalIn = 0;
      let totalOut = 0;

      const perCar = workCars.map(v => {
        const entrada = getWeekPaymentLive(v.id, weekKey);
        const m = getMaintenanceInWeek(v.id, weekKey);
        const salida = m.total;
        const neto = entrada - salida;
        totalIn += entrada;
        totalOut += salida;
        return { v, entrada, salida, neto };
      });

      const totalNet = totalIn - totalOut;

      const cards = [];

      cards.push(`
        <div class="profit-card">
          <div class="pie-wrap">
            <canvas id="week_pie_total"></canvas>
            <div class="pie-label">Total</div>
          </div>
          <div class="profit-meta">
            <div class="profit-title">Total (semana)</div>
            <div class="kv">
              <span><i class="dot-mini dot-in"></i>Entrada: ${money(totalIn)}</span>
              <span><i class="dot-mini dot-out"></i>Salida: ${money(totalOut)}</span>
              <span class="${totalNet < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(totalNet)}</span>
            </div>
          </div>
        </div>
      `);

      perCar.forEach(({v, entrada, salida, neto}, idx) => {
        const title = v.name || 'Veh√≠culo';
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}`;

        cards.push(`
          <div class="profit-card">
            <div class="pie-wrap">
              <canvas id="week_pie_${idx}"></canvas>
              <div class="pie-label">${escapeHtml(title)}</div>
            </div>
            <div class="profit-meta">
              <div class="profit-title">${escapeHtml(title)}</div>
              <div class="profit-sub">${sub}</div>
              <div class="kv">
                <span><i class="dot-mini dot-in"></i>Entrada: ${money(entrada)}</span>
                <span><i class="dot-mini dot-out"></i>Salida: ${money(salida)}</span>
                <span class="${neto < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(neto)}</span>
              </div>
            </div>
          </div>
        `);
      });

      grid.innerHTML = cards.join('');

      const cTotal = document.getElementById('week_pie_total');
      if(cTotal) drawPie(cTotal, totalIn, totalOut);

      perCar.forEach(({entrada, salida}, idx) => {
        const c = document.getElementById(`week_pie_${idx}`);
        if(c) drawPie(c, entrada, salida);
      });
    }

    // =========================
    // Alertas
    // =========================
    function showAlert(type, message){
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      const section = document.querySelector('.section.active');
      if(section) section.insertBefore(alertDiv, section.firstChild);

      setTimeout(()=> alertDiv.remove(), 3000);
    }

    // =========================
    // Init / Migraciones
    // =========================
    function migrateVehiclesCategoryIfMissing(){
      let changed = false;
      vehicles = (vehicles || []).map(v => {
        if(!v.category){
          changed = true;
          return { ...v, category:'Particular' };
        }
        return v;
      });
      if(changed) localStorage.setItem('vehicles', JSON.stringify(vehicles));
    }

    // ‚úÖ NUEVO: migraci√≥n para registros viejos (completed / completedDate)
    function migrateVerificationCompletedFields(){
      let changed = false;

      Object.keys(verifications || {}).forEach(vid => {
        const arr = verifications[vid];
        if(!Array.isArray(arr)) return;

        arr.forEach(r => {
          if(!r) return;
          if(typeof r.completed !== 'boolean'){ r.completed = false; changed = true; }
          if(typeof r.completedDate !== 'string'){ r.completedDate = ''; changed = true; }
        });
      });

      if(changed){
        localStorage.setItem('verifications', JSON.stringify(verifications));
      }
    }

    // ‚úÖ NUEVO: limpieza de workPayments hu√©rfanos (evita "ganancias fantasmas" por ids antiguos)
    function cleanupWorkPaymentsOrphans(){
      const validIds = new Set((vehicles || []).map(v => String(v.id)));
      let changed = false;

      Object.keys(workPayments || {}).forEach(vid => {
        if(!validIds.has(String(vid))){
          delete workPayments[vid];
          changed = true;
        }
      });

      if(changed){
        localStorage.setItem('workPayments', JSON.stringify(workPayments));
      }
    }

    migrateVehiclesCategoryIfMissing();
    migrateVerificationCompletedFields();
    cleanupWorkPaymentsOrphans();
    setupCarPhotoUploader();
    setupEditCarPhotoUploader();

    renderVehicles();
    renderDashboard();
    checkVerificationAlerts();

    // ‚úÖ FIX: "hoy" en local, sin toISOString (evita -1 d√≠a)
    const today = ymd(new Date());
    const vDate = document.getElementById('verificationDate');
    const mDate = document.getElementById('maintenanceDate');
    if(vDate) vDate.value = today;
    if(mDate) mDate.value = today;

    const monthInput = document.getElementById('gainsMonth');
    if(monthInput){
      const now = new Date();
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      selectedMonthISO = monthInput.value;
      const weeks = computeWeeksForMonth(selectedMonthISO);
      selectedWeekStartISO = weeks.length ? weeks[0].startISO : '';
    }
  </script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>

