<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Control Vehicular</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00E676" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Control Vehicular" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
<style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root{
      --bg-primary:#06110d;
      --bg-secondary:#0b1a14;
      --bg-card:#0f231b;

      --accent:#00E676;
      --accent-hover:#00C853;
      --accent-soft:#69F0AE;

      --text-primary:#ffffff;
      --text-secondary:#cfe7dc;

      --success:#00E676;
      --warning:#fbbf24;
      --danger:#ef4444;
      --border:rgba(255,255,255,0.14);
    }

    body{
      font-family:'DM Sans',sans-serif;
      background:linear-gradient(135deg,var(--bg-primary) 0%, #0f1629 100%);
      color:var(--text-primary);
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:'';
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(0,230,118,0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0,230,118,0.03) 0%, transparent 50%);
      pointer-events:none;
      z-index:0;
    }

    .container{
      max-width:1400px;
      margin:0 auto;
      padding:2rem;
      position:relative;
      z-index:1;
    }

    .header{
      text-align:center;
      margin-bottom:3rem;
      animation:fadeInDown .6s ease-out;
    }

    .header h1{
      font-family:'Space Mono',monospace;
      font-size:2.5rem;
      font-weight:700;
      background:linear-gradient(135deg,var(--accent) 0%, #00fff2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:.5rem;
      letter-spacing:-1px;
    }

    .header p{
      color:var(--text-secondary);
      font-size:1rem;
    }

    .main-nav{
      display:flex;
      gap:1rem;
      margin-bottom:2rem;
      flex-wrap:wrap;
      animation:fadeInUp .6s ease-out .1s backwards;
    }

    .nav-btn{
      flex:1;
      min-width:200px;
      padding:1rem 1.5rem;
      background:var(--bg-card);
      border:2px solid var(--border);
      color:var(--text-primary);
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      border-radius:12px;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }

    .nav-btn::before{
      content:'';
      position:absolute;
      top:0; left:-100%;
      width:100%; height:100%;
      background:linear-gradient(90deg, transparent, rgba(0,230,118,0.1), transparent);
      transition:left .5s ease;
    }

    .nav-btn:hover::before{ left:100%; }

    .nav-btn:hover{
      border-color:var(--accent);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,230,118,0.2);
    }

    .nav-btn.active{
      background:linear-gradient(135deg,var(--accent) 0%, #0099cc 100%);
      border-color:var(--accent);
      box-shadow:0 8px 25px rgba(0,230,118,0.3);
    }

    .section{ display:none; animation:fadeIn .4s ease-out; }
    .section.active{ display:block; }

    .card{
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:2rem;
      margin-bottom:2rem;
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      transition:transform .3s ease, box-shadow .3s ease;
    }

    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 30px rgba(0,230,118,0.15);
    }

    .card h2{
      font-family:'Space Mono',monospace;
      color:var(--accent);
      margin-bottom:1.5rem;
      font-size:1.5rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }

    .form-group{ margin-bottom:1.5rem; }

    .form-group label{
      display:block;
      margin-bottom:.5rem;
      color:var(--text-secondary);
      font-weight:500;
      font-size:.9rem;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select{
      width:100%;
      padding:.875rem 1rem;
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--text-primary);
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      transition:all .3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(0,230,118,0.1);
    }

    .form-group textarea{ resize:vertical; min-height:100px; }

    .btn{
      padding:.875rem 2rem;
      border:none;
      border-radius:8px;
      font-family:'DM Sans',sans-serif;
      font-size:1rem;
      font-weight:600;
      cursor:pointer;
      transition:all .3s ease;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--accent) 0%, #0099cc 100%);
      color:var(--text-primary);
      box-shadow:0 4px 15px rgba(0,230,118,0.3);
    }
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(0,230,118,0.4);
    }

    .btn-danger{
      background:linear-gradient(135deg,var(--danger) 0%, #dc2626 100%);
      color:var(--text-primary);
      box-shadow:0 4px 15px rgba(239,68,68,0.3);
    }
    .btn-danger:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(239,68,68,0.4);
    }

    .btn-soft{
      padding:.6rem 1rem;
      border-radius:999px;
      border:2px solid rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.08);
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
      white-space:nowrap;
    }
    .btn-soft:hover{
      transform:translateY(-1px);
      border-color:rgba(0,230,118,0.65);
      background:rgba(0,230,118,0.12);
    }

    
    /* Bot√≥n tipo "ghost" (usado en Billetera: Nueva/Quitar categor√≠a, Limpiar, etc.) */
    .btn-ghost{
      padding:.6rem 1rem;
      border-radius:999px;
      border:2px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      color:rgba(255,255,255,0.92);
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
      white-space:nowrap;
    }
    .btn-ghost:hover{
      transform:translateY(-1px);
      border-color:rgba(0,230,118,0.55);
      background:rgba(0,230,118,0.10);
      color:var(--accent);
    }
    .btn-ghost.danger{
      border-color:rgba(239,68,68,0.40);
      background:rgba(239,68,68,0.10);
      color:#ffd7d7;
    }
    .btn-ghost.danger:hover{
      border-color:rgba(239,68,68,0.80);
      background:rgba(239,68,68,0.16);
      color:#fff;
    }

.alert{
      padding:1rem 1.5rem;
      border-radius:8px;
      margin-bottom:1rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      font-weight:500;
      animation:slideInRight .4s ease-out;
    }
    .alert-warning{ background:rgba(245,158,11,0.1); border-left:4px solid var(--warning); color:var(--warning); }
    .alert-danger{ background:rgba(239,68,68,0.1); border-left:4px solid var(--danger); color:var(--danger); }
    .alert-success{ background:rgba(16,185,129,0.1); border-left:4px solid var(--success); color:var(--success); }

    .maintenance-list, .verification-list{
      display:flex;
      flex-direction:column;
      gap:1rem;
      margin-top:1rem;
    }

    .maintenance-item, .verification-item{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:8px;
      padding:1rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition:all .3s ease;
      gap:1rem;
    }

    .maintenance-item:hover, .verification-item:hover{
      border-color:var(--accent);
      transform:translateX(4px);
    }

    .item-info h4{ margin-bottom:.25rem; color:var(--text-primary); }
    .item-info p{ color:var(--text-secondary); font-size:.875rem; }

    .badge{
      padding:.25rem .75rem;
      border-radius:20px;
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
      display:inline-block;
    }
    .badge-success{ background:rgba(16,185,129,0.2); color:var(--success); }
    .badge-warning{ background:rgba(245,158,11,0.2); color:var(--warning); }
    .badge-danger{ background:rgba(239,68,68,0.2); color:var(--danger); }
    .badge-muted{ background:rgba(160,174,192,0.18); color:rgba(255,255,255,0.75); border:1px solid rgba(255,255,255,0.12); }

    .empty-state{
      text-align:center;
      padding:3rem 2rem;
      color:var(--text-secondary);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px,1fr));
      gap:1rem;
      margin-bottom:1.25rem;
    }

    .stat-card{
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.5rem;
      text-align:center;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }

    .stat-card::before{
      content:'';
      position:absolute;
      inset:-2px;
      background:radial-gradient(circle at 30% 30%, rgba(0,230,118,0.16), transparent 55%);
      opacity:.6;
      pointer-events:none;
    }

    .stat-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,230,118,0.15);
    }

    .stat-card .number{
      font-size:2rem;
      font-weight:700;
      font-family:'Space Mono', monospace;
      background:linear-gradient(135deg,var(--accent) 0%, #00fff2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      position:relative;
      z-index:1;
    }

    .stat-card .label{
      color:var(--text-secondary);
      font-size:.875rem;
      margin-top:.5rem;
      text-transform:uppercase;
      letter-spacing:.5px;
      position:relative;
      z-index:1;
    }

    /* ===== Dashboard visual ===== */
    .type-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-bottom:2rem;
    }
    .type-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1.25rem;
      display:flex;
      gap:1rem;
      align-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
      transition:.2s ease;
      position:relative;
      overflow:hidden;
    }
    .type-card:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 14px 40px rgba(0,230,118,0.10), 0 14px 40px rgba(0,0,0,0.22);
    }
    .type-icon{
      width:56px; height:56px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.6rem;
      background:rgba(0,230,118,0.10);
      border:1px solid rgba(0,230,118,0.22);
      flex:0 0 56px;
    }
    .type-title{
      font-family:'Space Mono', monospace;
      font-weight:800;
      letter-spacing:.3px;
    }
    .type-metrics{
      margin-top:.35rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      color:rgba(255,255,255,0.85);
    }
    .pill{
      font-size:.75rem;
      font-weight:800;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
    }
    .pill.good{ border-color:rgba(16,185,129,0.35); background:rgba(16,185,129,0.10); color:var(--success); }
    .pill.warn{ border-color:rgba(245,158,11,0.35); background:rgba(245,158,11,0.10); color:var(--warning); }
    .pill.bad{ border-color:rgba(239,68,68,0.35); background:rgba(239,68,68,0.10); color:var(--danger); }

    .vehicle-progress-list{ display:flex; flex-direction:column; gap:1rem; }
    .vehicle-progress-item{
      background:var(--bg-secondary);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      padding:1rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      transition:.2s ease;
    }
    .vehicle-progress-item:hover{
      border-color:rgba(0,230,118,0.45);
      transform:translateX(3px);
    }
    .vp-left{ display:flex; flex-direction:column; gap:.35rem; min-width:240px; }
    .vp-title{ font-weight:900; letter-spacing:.2px; }
    .vp-sub{ color:rgba(255,255,255,0.70); font-size:.9rem; }
    .vp-bar-wrap{ flex:1; min-width:220px; }
    .vp-bar{
      width:100%; height:10px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .vp-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      transition:width .35s ease;
      background:linear-gradient(90deg, rgba(0,230,118,0.9), rgba(0,255,242,0.55));
    }
    .vp-fill.warn{ background:linear-gradient(90deg, rgba(245,158,11,0.95), rgba(245,158,11,0.40)); }
    .vp-fill.bad{ background:linear-gradient(90deg, rgba(239,68,68,0.95), rgba(239,68,68,0.35)); }
    .vp-fill.good{ background:linear-gradient(90deg, rgba(16,185,129,0.95), rgba(16,185,129,0.35)); }
    .vp-right{ text-align:right; min-width:160px; }
    .vp-days{ font-family:'Space Mono', monospace; font-weight:900; }
    .vp-date{ color:rgba(255,255,255,0.70); font-size:.9rem; margin-top:.25rem; }

    /* ===== Veh√≠culos (cards) ===== */
    .vehicles-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      margin-bottom:1rem;
    }

    .add-pill{
      padding:.65rem 1rem;
      border-radius:999px;
      border:2px solid rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.08);
      color:var(--accent);
      font-weight:800;
      cursor:pointer;
      transition:.2s ease;
      white-space:nowrap;
    }
    .add-pill:hover{
      transform:translateY(-1px);
      border-color:rgba(0,230,118,0.65);
      background:rgba(0,230,118,0.12);
    }

    .vehicle-list{ display:flex; flex-direction:column; gap:1rem; }
    .vehicle-row{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:22px;
      overflow:hidden;
      cursor:pointer;
      box-shadow:0 10px 35px rgba(0,0,0,0.25);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .vehicle-row:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 14px 45px rgba(0,230,118,0.10), 0 14px 45px rgba(0,0,0,0.22);
    }
    .vehicle-row.selected{
      border-color:var(--accent);
      background:rgba(0,230,118,0.06);
    }
    .vehicle-row-top{
      display:grid;
      grid-template-columns:1fr 170px;
      gap:1rem;
      padding:1.25rem 1.25rem 1rem 1.25rem;
      align-items:center;
    }
    .vehicle-plate{
      font-size:1.9rem;
      font-weight:900;
      letter-spacing:1px;
    }

    /* Veh√≠culos: que resalte el nombre (solo en el m√≥dulo Veh√≠culos) */
    .vehicle-name-main{
      font-size:1.9rem;
      font-weight:900;
      letter-spacing:1px;
    }
    .vehicle-subtitle{
      margin-top:.35rem;
      color:rgba(255,255,255,0.72);
      font-size:.98rem;
      line-height:1.2rem;
    }
    .vehicle-subtitle .bullet{ opacity:.85; }

    .vehicle-value{
      margin-top:.35rem;
      font-weight:900;
      color:var(--accent);
      font-family:'Space Mono', monospace;
      font-size:1.02rem;
      letter-spacing:.2px;
    }
    .vehicle-carimg{
      width:170px; height:95px;
      border-radius:18px;
      background:
        radial-gradient(circle at 30% 30%, rgba(0,230,118,0.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .vehicle-carimg img{
      width:100%; height:100%;
      object-fit:contain;
      filter:drop-shadow(0 10px 14px rgba(0,0,0,0.25));
    }
    .vehicle-row-bottom{
      border-top:1px solid rgba(255,255,255,0.08);
      padding:.95rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }
    .status{ display:flex; align-items:flex-start; gap:.7rem; font-weight:900; }
    .status-text small{
      display:block;
      margin-top:.15rem;
      color:rgba(255,255,255,0.60);
      font-weight:700;
    }

    .dot{ width:10px; height:10px; border-radius:50%; margin-top:.35rem; }
    .dot.gray{ background:rgba(160,174,192,0.95); box-shadow:0 0 0 5px rgba(160,174,192,0.12); }
    .dot.success{ background:var(--success); box-shadow:0 0 0 5px rgba(16,185,129,0.12); }
    .dot.warning{ background:var(--warning); box-shadow:0 0 0 5px rgba(245,158,11,0.12); }
    .dot.danger{ background:var(--danger); box-shadow:0 0 0 5px rgba(239,68,68,0.12); }

    .row-actions{ display:flex; align-items:center; gap:.6rem; }
    .btn-mini{
      padding:.48rem .9rem;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.08);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
    }
    .btn-mini:hover{ transform:translateY(-1px); border-color:rgba(0,230,118,0.55); }
    .btn-mini.danger{ border-color:rgba(239,68,68,0.35); }
    .btn-mini.danger:hover{ border-color:rgba(239,68,68,0.70); }
    .chev{ font-size:1.6rem; font-weight:900; opacity:.55; margin-left:.2rem; }

    /* ===== Modal ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:620px;
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      padding:1.5rem;
      animation:fadeInUp .25s ease-out;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:1rem;
    }
    .modal-header h3{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      font-size:1.25rem;
    }
    .modal-close{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text-primary);
      cursor:pointer;
      border-radius:10px;
      padding:.4rem .7rem;
      transition:all .2s ease;
    }
    .modal-close:hover{
      border-color:var(--accent);
      transform:translateY(-1px);
    }

    /* ===== Autos de trabajo ===== */
    .subtabs{
      display:flex;
      gap:.6rem;
      flex-wrap:wrap;
      margin: .25rem 0 1.25rem 0;
    }
    .chip{
      padding:.55rem .95rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      transition:.2s ease;
    }
    .chip.active{
      border-color:rgba(0,230,118,0.55);
      background:rgba(0,230,118,0.12);
      color:var(--accent);
    }
    .chip:hover{ transform:translateY(-1px); border-color:rgba(0,230,118,0.45); }

    .work-panel{
      border:1px dashed rgba(0,230,118,0.35);
      background:rgba(0,230,118,0.06);
      border-radius:16px;
      padding:1.25rem;
    }

    .work-cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .work-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .work-card h4{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      margin-bottom:.35rem;
      font-size:1.05rem;
    }
    .work-card p{ color:rgba(255,255,255,0.75); font-weight:800; }
    .work-card .cat{
      margin-top:.6rem;
      display:inline-block;
      padding:.25rem .6rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:900;
      border:1px solid rgba(16,185,129,0.35);
      background:rgba(16,185,129,0.10);
      color:var(--success);
      text-transform:uppercase;
      letter-spacing:.3px;
    }

    /* ===== Ganancias: semanas ===== */
    .weeks-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .week-tile{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
      cursor:pointer;
      transition:.2s ease;
    }
    .week-tile:hover{
      transform:translateY(-2px);
      border-color:rgba(0,230,118,0.45);
      box-shadow:0 12px 35px rgba(0,0,0,0.25);
    }
    .week-tile.active{
      border-color:rgba(0,230,118,0.75);
      background:rgba(0,230,118,0.08);
    }
    .week-tile .wk-title{
      font-family:'Space Mono', monospace;
      font-weight:900;
      color:#fff;
      margin-bottom:.25rem;
    }
    .week-tile .wk-range{
      color:rgba(255,255,255,0.75);
      font-weight:900;
    }

    .gain-top{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:1rem;
      margin-top:1rem;
    }
    .kpi{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .kpi .k-title{
      color:rgba(255,255,255,0.70);
      font-weight:900;
      text-transform:uppercase;
      font-size:.8rem;
      letter-spacing:.4px;
    }
    .kpi .k-val{
      font-family:'Space Mono', monospace;
      font-size:1.6rem;
      font-weight:900;
      margin-top:.35rem;
    }

    .gain-cards{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:1rem;
      margin-top:1rem;
    }

    .gain-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
    }
    .gain-card h4{
      font-family:'Space Mono', monospace;
      color:var(--accent);
      margin-bottom:.25rem;
    }
    .gain-sub{
      color:rgba(255,255,255,0.70);
      font-weight:900;
      margin-bottom:.8rem;
    }
    .gain-label{
      color:rgba(255,255,255,0.65);
      font-weight:900;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.4px;
      margin-bottom:.4rem;
    }

    .pay-input{
      width:100%;
      padding:.85rem 1rem;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(10,14,39,0.55);
      color:#fff;
      font-weight:900;
      font-family:'Space Mono', monospace;
      font-size:1.1rem;
      outline:none;
      transition:.2s ease;
    }
    .pay-input:focus{
      border-color:rgba(0,230,118,0.65);
      box-shadow:0 0 0 3px rgba(0,230,118,0.12);
    }

    .row-kv{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      margin-top:.75rem;
      font-weight:900;
      color:rgba(255,255,255,0.85);
    }
    .row-kv small{
      display:inline-block;
      margin-left:.4rem;
      padding:.15rem .5rem;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(16,185,129,0.35);
      background:rgba(16,185,129,0.10);
      color:var(--success);
    }
    .details{
      margin-top:.8rem;
      color:rgba(255,255,255,0.70);
      font-weight:800;
      font-size:.9rem;
      line-height:1.25rem;
    }

    /* ===== Rentabilidad visual (ALL TIME) ===== */
    .profit-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .profit-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      padding:1rem;
      display:flex;
      gap:1rem;
      align-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
    }
    .pie-wrap{
      width:92px; height:92px;
      border-radius:16px;
      background:rgba(0,0,0,0.15);
      border:1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 92px;
      position:relative;
      overflow:hidden;
    }
    .pie-wrap canvas{ width:78px; height:78px; }
    .pie-label{
      position:absolute;
      bottom:6px; right:8px;
      font-size:.8rem;
      font-weight:900;
      font-family:'Space Mono', monospace;
      color:rgba(255,255,255,0.85);
      max-width:78px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .profit-meta{ flex:1; min-width:0; }
    .profit-title{
      font-family:'Space Mono', monospace;
      font-weight:900;
      color:var(--accent);
      margin-bottom:.35rem;
      font-size:1rem;
      line-height:1.2rem;
    }
    .profit-sub{
      color:rgba(255,255,255,0.70);
      font-size:.9rem;
      margin-bottom:.6rem;
      font-weight:900;
    }
    .kv{
      display:flex;
      flex-direction:column;
      gap:.2rem;
      font-weight:900;
    }
    .kv span{
      display:flex;
      align-items:center;
      gap:.4rem;
      color:rgba(255,255,255,0.85);
      font-size:.9rem;
    }
    .dot-mini{ width:8px; height:8px; border-radius:50%; display:inline-block; }
    .dot-in{ background:#3b82f6; }
    .dot-out{ background:#f59e0b; }
    .dot-net{ background:#10b981; }
    .net-neg{ color:var(--danger) !important; }

    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @keyframes fadeInDown{ from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
    @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
    @keyframes slideInRight{ from{opacity:0; transform:translateX(20px);} to{opacity:1; transform:translateX(0);} }

    @media(max-width:768px){
      .container{ padding:1rem; }
      .header h1{ font-size:2rem; }
      .main-nav{ flex-direction:column; }
      .nav-btn{ min-width:auto; }
      .vehicle-row-top{ grid-template-columns:1fr 140px; }
      .vehicle-carimg{ width:140px; height:85px; }
      .vp-right{ min-width:120px; }
      .vp-left{ min-width:180px; }
      .gain-top{ grid-template-columns:1fr; }
    }
  

    /* =========================
       MOBILE PRO (app-like)
       Mantiene funcionalidades, solo ajusta UI
       ========================= */
    @media (max-width: 640px){
      /* espacio para barra inferior y safe-area iPhone */
      .container{
        padding: 1rem !important;
        padding-bottom: calc(104px + env(safe-area-inset-bottom)) !important;
      }

      .header{ margin-bottom: 1.25rem !important; }
      .header h1{
        font-size: 1.55rem !important;
        line-height: 1.15 !important;
      }
      .header p{ font-size: .95rem !important; }

      /* NAV como barra inferior tipo app */
      .main-nav{
        position: fixed !important;
        left: 12px !important;
        right: 12px !important;
        bottom: calc(12px + env(safe-area-inset-bottom)) !important;
        margin: 0 !important;
        gap: 10px !important;
        padding: 10px !important;
        border-radius: 18px !important;
        background: rgba(11, 26, 20, 0.85) !important;
        border: 1px solid rgba(255,255,255,0.14) !important;
        box-shadow: 0 18px 55px rgba(0,0,0,0.55) !important;
        backdrop-filter: blur(10px) !important;
        z-index: 9998 !important;

        display: grid !important;
        grid-template-columns: repeat(6, 1fr) !important;
        animation: none !important;
      }
      .nav-btn{
        min-width: 0 !important;
        width: 100% !important;
        padding: .75rem .5rem !important;
        font-size: .78rem !important;
        border-radius: 14px !important;
        line-height: 1.05 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
        white-space: normal !important;
      }

      /* tarjetas un poco m√°s compactas */
      .card{
        padding: 1.15rem !important;
        border-radius: 16px !important;
      }

      /* grids a 1 columna */
      .stats-grid{ grid-template-columns: 1fr !important; }
      .type-grid{ grid-template-columns: 1fr !important; }
      .profit-grid{ grid-template-columns: 1fr !important; }

      /* headers apilados */
      .vehicles-header{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
      }
      .add-pill{
        width: 100% !important;
        text-align: center !important;
        justify-content: center !important;
      }

      /* VEH√çCULOS: apilar para que no quede apretado */
      .vehicle-row-top{
        grid-template-columns: 1fr !important;
        gap: .85rem !important;
      }
      .vehicle-carimg{
        width: 100% !important;
        height: 160px !important;
        border-radius: 18px !important;
      }
      .vehicle-row-bottom{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
      }
      .row-actions{
        justify-content: space-between !important;
        width: 100% !important;
      }
      .btn-mini{
        flex: 1 !important;
        text-align: center !important;
        padding: .65rem .9rem !important;
      }

      /* LISTAS: apiladas */
      .maintenance-item, .verification-item{
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: .6rem !important;
      }

      /* PROGRESO POR VEH√çCULO: evitar que se salga a la derecha */
      .vehicle-progress-item{
        flex-direction: column !important;
        align-items: stretch !important;
        gap: .75rem !important;
        max-width: 100% !important;
        overflow: hidden !important;
      }
      .vp-left{ min-width: 0 !important; width: 100% !important; }
      .vp-bar-wrap{ min-width: 0 !important; width: 100% !important; }
      .vp-right{
        min-width: 0 !important;
        width: 100% !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        gap: .75rem !important;
        flex-wrap: wrap !important;
      }
      .vp-right *{ min-width: 0 !important; }
      .vp-right .vp-meta{
        text-align: right !important;
      }
    }

    @media (max-width: 420px){
      .main-nav{
        left: 10px !important;
        right: 10px !important;
        gap: 8px !important;
        padding: 8px !important;
      }
      .nav-btn{
        font-size: .72rem !important;
        padding: .70rem .45rem !important;
      }
    }


    /* Verificaciones: panel en cascada por veh√≠culo */
    .veri-panel{
      margin-top:.75rem;
      background:rgba(10,14,39,0.35);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1rem;
    }
    .veri-panel .panel-actions{
      display:flex;
      gap:.5rem;
      justify-content:flex-end;
      margin-bottom:.75rem;
    }
    .veri-panel .mini-btn{
      padding:.5rem .75rem;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.06);
      color:var(--text-primary);
      cursor:pointer;
      font-weight:600;
    }
    .veri-panel .mini-btn:hover{ background:rgba(255,255,255,0.09); }

/* ===== BILLETERA: Movimientos en 2 columnas + desplegable con scroll ===== */
.wallet-columns{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}
.wallet-col{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:1rem;
}

/* Desplegable */
.wallet-drop{
  border:1px solid rgba(255,255,255,0.10);
  border-radius:14px;
  background:rgba(0,0,0,0.12);
  overflow:hidden;
}
.wallet-drop > summary{
  list-style:none;
  cursor:pointer;
  padding:.8rem 1rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
  user-select:none;
}
.wallet-drop > summary::-webkit-details-marker{ display:none; }

.wallet-col-title{
  display:flex;
  align-items:center;
  gap:.6rem;
  font-family:'Space Mono', monospace;
  font-weight:900;
}
.wallet-col-title .hint{
  opacity:.85;
  font-weight:900;
  font-family:'DM Sans', sans-serif;
  font-size:.9rem;
}

.wallet-caret{
  opacity:.75;
  font-weight:900;
  font-size:1.05rem;
  transition:transform .15s ease;
}
.wallet-drop[open] .wallet-caret{ transform:rotate(180deg); }

/* Ventana con scroll (3-5 movimientos visibles aprox) */
.wallet-scroll{
  border-top:1px solid rgba(255,255,255,0.08);
  padding:.85rem 1rem 1rem 1rem;
  max-height:320px;
  overflow:auto;
}

/* Compactar tarjetas SOLO dentro de billetera */
.wallet-scroll .maintenance-list{ display:flex; flex-direction:column; gap:.75rem; }
.wallet-scroll .maintenance-item{ padding:.85rem; border-radius:14px; }
.wallet-scroll .item-info h4{ font-size:.95rem; }
.wallet-scroll .item-info p{ font-size:.9rem; }
.wallet-scroll .btn-mini{ padding:.42rem .8rem; border-radius:12px; font-size:.9rem; }

@media(max-width:900px){
  .wallet-columns{ grid-template-columns:1fr; }
}

/* ===== BILLETERA: Gr√°ficas (mes / a√±o) ===== */
.wallet-charts-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:1rem;
}
.wallet-chart-card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:1rem;
  min-width:0;
  overflow:hidden;
}
.wallet-chart-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  margin-bottom:.6rem;
}
.wallet-chart-title{
  font-family:'Space Mono', monospace;
  font-weight:900;
  color:#fff;
}
.wallet-chart-controls select{
  padding:.55rem .75rem;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(255,255,255,0.06);
  color:#fff;
  font-weight:900;
  outline:none;
}
.wallet-chart-controls select:focus{
  border-color:rgba(0,230,118,0.65);
  box-shadow:0 0 0 3px rgba(0,230,118,0.12);
}
.wallet-chart-card canvas{
  width:100%;
  border-radius:12px;
  background:rgba(0,0,0,0.12);
  border:1px solid rgba(255,255,255,0.08);
}

.wallet-vehicles-total{
  margin-top:.55rem;
  font-weight:1000;
  color:rgba(255,255,255,0.92);
  display:flex;
  justify-content:flex-end;
  gap:.5rem;
  font-family:'Space Mono', monospace;
}
.wallet-vehicles-total .sub{
  font-family:'DM Sans', sans-serif;
  font-weight:900;
  color:rgba(255,255,255,0.70);
}
@media(max-width: 900px){
  .wallet-charts-grid{ grid-template-columns: 1fr; }
}

/* ===== BILLETERA: Gr√°ficas del Mes (3) + A√±o ===== */
.wallet-month-charts{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:1rem;
}
.wallet-month-charts > *{ min-width:0; }
.wallet-chart-slot-empty{ min-height:1px; }

.wallet-year-wrap{
  display:block;
}
.wallet-chart-card{
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:1rem;
}
.wallet-chart-title{
  font-family:'Space Mono', monospace;
  font-weight:900;
  color:#fff;
  margin-bottom:.6rem;
}
.wallet-chart-card canvas{
  width:100%;
  border-radius:12px;
  background:rgba(0,0,0,0.12);
  border:1px solid rgba(255,255,255,0.08);
}
@media(max-width: 900px){
  .wallet-month-charts{ grid-template-columns: 1fr; }
}


/* ===== BILLETERA: Selector de rango de meses ===== */
.wallet-month-range{
  display:flex;
  align-items:flex-end;
  gap:1rem;
  flex-wrap:wrap;
}

/* ===== BILLETERA: Pr√≥ximos pagos ===== */
.hint{
  margin-top:.35rem;
  color: rgba(255,255,255,0.72);
  font-size: 0.95rem;
  line-height: 1.35;
}
.wallet-pay-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,0.08);
  border-radius:14px;
  background: rgba(0,0,0,0.18);
  margin-bottom:10px;
}
.wallet-pay-meta{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width: 0;
}
.wallet-pay-title{
  font-weight:800;
  color:#fff;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.wallet-pay-sub{
  color: rgba(255,255,255,0.72);
  font-size: 0.92rem;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.wallet-pay-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.btn-mini{
  padding:8px 10px;
  border-radius:12px;
  font-weight:800;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color:#fff;
  cursor:pointer;
}
.btn-mini:hover{ background: rgba(255,255,255,0.10); }
.btn-mini.danger{ border-color: rgba(239,68,68,0.35); }
.btn-mini.ok{ border-color: rgba(59,130,246,0.45); }
.wallet-month-charts canvas{ width:100% !important; height:220px !important; display:block; }

/* ===== BILLETERA: Ajuste proporcional (3 gr√°ficas arriba) ===== */
.wallet-month-charts{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 16px;
  align-items: stretch;
}
.wallet-month-charts .wallet-chart-card{ min-width:0; }
.wallet-month-charts canvas{ width:100% !important; height:220px !important; display:block; }

/* ===== BILLETERA: Secci√≥n aparte (2 gr√°ficas abajo centradas) ===== */
.wallet-subtitle{
  color: var(--text-primary);
  font-weight: 800;
  letter-spacing: .2px;
  opacity: .95;
}
.wallet-month-charts-two{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 360px));
  justify-content: center;   /* centra las 2 tarjetas */
  gap: 16px;
  margin-top: 10px;
}
.wallet-month-charts-two .wallet-chart-card{ min-width:0; }
.wallet-month-charts-two canvas{ width:100% !important; height:220px !important; display:block; }
@media(max-width: 900px){
  .wallet-month-charts{ grid-template-columns: 1fr; }
  .wallet-month-charts-two{ grid-template-columns: 1fr; }
}

/* ===== Paleta de colores (Veh√≠culos) ===== */
.color-palette{
  display:grid;
  grid-template-columns: repeat(10, minmax(26px, 1fr));
  gap:10px;
  margin-top:0.75rem;
}
@media (max-width: 720px){
  .color-palette{ grid-template-columns: repeat(8, minmax(26px, 1fr)); }
}
.color-swatch{
  width:100%;
  aspect-ratio: 1 / 1;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.18);
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
  cursor:pointer;
  position:relative;
  transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
}
.color-swatch:hover{ transform: translateY(-1px); border-color: rgba(0,230,118,0.65); }
.color-swatch.is-selected{
  border-color: rgba(0,230,118,0.95);
  box-shadow: 0 0 0 3px rgba(0,230,118,0.18), 0 10px 18px rgba(0,0,0,0.35);
}
.color-swatch::after{
  content: attr(data-name);
  position:absolute;
  left:50%;
  bottom:-30px;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 11px;
  font-weight: 800;
  color: rgba(255,255,255,0.78);
  opacity:0;
  pointer-events:none;
  transition: opacity .12s ease;
}
.color-swatch:hover::after{ opacity:1; }
.color-palette-hint{
  display:block;
  margin-top:.4rem;
  color:rgba(255,255,255,0.55);
  font-weight:700;
  font-size:12px;
}

/* ===== FIX: Scroll interno en modal (Editar Veh√≠culo y cualquier modal largo) ===== */
.modal-overlay{
  /* permite que el contenedor tenga scroll si el modal es muy alto */
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  align-items:flex-start; /* evita que quede centrado y recortado en pantallas chicas */
}

.modal{
  /* scroll interno del contenido del modal */
  max-height: calc(100svh - 2rem);
  max-height: calc(100vh - 2rem); /* fallback */
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior: contain;
}

</style>

<link href="/favicon-32.png" rel="icon" sizes="32x32" type="image/png"/><link href="/icon-192.png" rel="icon" sizes="192x192" type="image/png"/><link href="/icon-512.png" rel="icon" sizes="512x512" type="image/png"/>  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
<div class="container">
<div class="header">
<h1>üöó Control Vehicular</h1>
<p>Sistema integral de gesti√≥n y mantenimiento de veh√≠culos</p>
</div>
<nav class="main-nav">
<button class="nav-btn active" onclick="showSection('dashboard', event)">Inicio</button>
<button class="nav-btn" onclick="showSection('vehicles', event)">Autos</button>
<button class="nav-btn" onclick="showSection('verification', event)">Ver. &amp; Multas</button>
<button class="nav-btn" onclick="showSection('maintenance', event)">Mant.</button>
<button class="nav-btn" onclick="showSection('workcars', event)">Autos de trabajo</button>
<button class="nav-btn" onclick="showSection('wallet', event)">Billetera</button>
</nav>
<!-- DASHBOARD -->
<section class="section active" id="dashboard">
<div class="stats-grid">
<div class="stat-card">
<div class="number" id="totalVehicles">0</div>
<div class="label">Veh√≠culos Registrados</div>
</div>
<div class="stat-card">
<div class="number" id="alertsCount">0</div>
<div class="label">Alertas Activas</div>
</div>
<div class="stat-card">
<div class="number" id="overdueCount">0</div>
<div class="label">Verificaciones Vencidas</div>
</div>
<div class="stat-card">  <div class="number" id="dashboardSaldo2026">$0.00</div>  <div id="upcomingCount" style="display:none">0</div>  <div class="label">SALDO DESDE 2026</div></div>
</div>
<div id="dashboardAlerts"></div>
<div class="card">
<h2>üßæ Resumen por Tipo</h2>
<div class="type-grid" id="typeSummary"></div>
</div>
<div class="card">
<h2>üìå Progreso por Veh√≠culo</h2>
<div class="vehicle-progress-list" id="vehicleProgress"></div>
</div>
<div class="card">
<h2>üìä Resumen por Veh√≠culo</h2>
<div class="verification-list" id="vehicleSummary"></div>
</div>
<div class="card">
<h2>‚è∞ Pr√≥ximas Verificaciones</h2>
<div class="verification-list" id="upcomingVerifications"></div>
</div>

<div class="card">
<h2>üîß Mantenimientos Programados</h2>
<div class="verification-list" id="upcomingMaintenances"></div>
</div>
</section>

<!-- BILLETERA -->
<section class="section" id="wallet"><div class="card">
    <h2>üìú Movimientos</h2>
    <div class="wallet-month-range" style="margin-top:1rem;">
  <div class="form-group" style="max-width:220px;">
    <label for="walletMonthFrom">Desde</label>
    <input id="walletMonthFrom" type="month" />
  </div>
  <div class="form-group" style="max-width:220px;">
    <label for="walletMonthTo">Hasta</label>
    <input id="walletMonthTo" type="month" />
  </div>
</div>
    <div id="walletTxList" class="maintenance-list"></div>
  </div>

<div class="card">
  <h2>üìä Gr√°ficas del Mes</h2>
  <p style="color: var(--text-secondary); font-weight:800; margin-top:-0.75rem;">
    Mes seleccionado (por defecto: mes actual) ‚Ä¢ Barras (Ingresos vs Egresos) ‚Ä¢ Circular (Ingresos vs Egresos) ‚Ä¢ Tendencia (Mes)
  </p>

  <!-- Fila 1: 3 gr√°ficas (3 columnas) -->
  <div class="wallet-month-charts wallet-month-charts--top" style="margin-top:1rem;">
    <div class="wallet-chart-card">
      <div class="wallet-chart-title">üìà Ingresos vs Egresos (Mes)</div>
      <canvas id="walletChartMonthBars" height="220"></canvas>
    </div>

    <div class="wallet-chart-card">
      <div class="wallet-chart-title">üç© Ingresos vs Egresos (Mes)</div>
      <canvas id="walletChartMonthDonut" height="220"></canvas>
    </div>

    <div class="wallet-chart-card">
      <div class="wallet-chart-title">üìâ Tendencia (Mes)</div>
      <canvas id="walletChartTrend30" height="220"></canvas>
    </div>
  </div>

  <!-- Fila 2: 2 gr√°ficas ocupando 2 espacios (el 3er espacio queda vac√≠o) -->
  <div class="wallet-month-charts wallet-month-charts--bottom" style="margin-top:1rem;">
    <div class="wallet-chart-card">
      <div class="wallet-chart-title">üç© Ingresos por Categor√≠a (Mes)</div>
      <canvas id="walletChartInCatsDonut" height="240" style="width:100%;height:240px;"></canvas>
    </div>

    <div class="wallet-chart-card">
      <div class="wallet-chart-title">üç© Egresos por Categor√≠a (Mes)</div>
      <canvas id="walletChartOutCatsDonut" height="240" style="width:100%;height:240px;"></canvas>
    </div>

        <div class="wallet-chart-card">
      <div class="wallet-chart-title">üöó Valor de Veh√≠culos</div>
      <canvas id="walletChartVehicleValues" height="320" style="width:100%;height:320px;"></canvas>
      <div class="wallet-vehicles-total" id="walletVehiclesTotalValue">Total: $0.00</div>
    </div>
  </div>
</div>

  <div class="card">
    <h2>üí≥ Billetera</h2>
    <p style="color: var(--text-secondary); font-weight:800; margin-top:-0.75rem;">
      Registra ingresos y egresos (gastos). Esto es independiente de los autos; es tu caja general.
    </p>

    <div class="gain-top" style="margin-top:1rem;">
      <div class="kpi">
        <div class="k-title">Saldo</div>
        <div class="k-val" id="walletBalance">$0.00</div>
      </div>
      <div class="kpi">
        <div class="k-title">Ingresos</div>
        <div class="k-val" id="walletIn">$0.00</div>
      </div>
      <div class="kpi">
        <div class="k-title">Egresos</div>
        <div class="k-val" id="walletOut">$0.00</div>
      </div>
    </div>
  </div>


  <div class="card">
    <h2>‚ûï Agregar movimiento</h2>
    <form id="walletForm">
      <div class="form-group">
        <label for="walletType">Tipo</label>
        <select id="walletType" required>
          <option value="">Seleccionar...</option>
          <option value="in">Ingreso</option>
          <option value="out">Egreso</option>
        </select>
      </div>
<div class="form-group" id="walletCategoryWrap" style="display:none;">
  <label for="walletCategory">CATEGOR√çA</label>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <select id="walletCategory" style="flex:1; min-width:260px;">
      <option value="">Seleccionar...</option>
    </select>
    <button type="button" class="btn-ghost" id="walletCategoryAddBtn">‚ûï Nueva categor√≠a</button>
    <button type="button" class="btn-ghost danger" id="walletCategoryDelBtn">üóë Quitar categor√≠a</button>
  </div>
</div>



      <div class="form-group">
        <label for="walletDate">Fecha</label>
        <input id="walletDate" type="date" required />
      </div>

      <div class="form-group">
        <label for="walletAmount">Monto</label>
        <input id="walletAmount" type="number" step="0.01" placeholder="$0.00" required />
      </div>

      <div class="form-group">
        <label for="walletNote">Concepto / Nota</label>
        <textarea id="walletNote" placeholder="Ej: Pago chofer, gasolina, refacci√≥n..."></textarea>
      </div>

      <button class="btn btn-primary" type="submit">GUARDAR MOVIMIENTO</button>
    </form>
  </div>

<div class="card">
  <h2>üóì Pr√≥ximos pagos</h2>
  <p class="hint">Registra pagos futuros. Al marcar <b>Terminar</b>, se crea un <b>Egreso</b> en Movimientos con la fecha de hoy.</p>

  <div class="grid-3" style="margin-top:1rem;">
    <div class="form-group">
      <label for="walletPayDue">Fecha programada</label>
      <input id="walletPayDue" type="date" />
    </div>


    <div class="form-group">
      <label for="walletPayAmount">Monto</label>
      <input id="walletPayAmount" type="number" inputmode="decimal" placeholder="0.00" />
    </div>

    <div class="form-group">
      <label for="walletPayCategory">Categor√≠a</label>
      <select id="walletPayCategory">
        <option value="">Seleccionar...</option>
      </select>
      <small style="display:block; margin-top:.6rem; color:rgba(255,255,255,0.65); font-weight:700;">
        Tip: esta categor√≠a se aplicar√° cuando marques <b>Terminar</b> (se crear√° el egreso con esa categor√≠a).
      </small>
    </div>

    <div class="form-group" style="grid-column:1/-1;">
      <label for="walletPayNote">Concepto / Nota</label>
      <textarea id="walletPayNote" rows="2" placeholder="Ej: Mantenimiento, renta, seguro..."></textarea>
    </div>
  </div>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
    <button class="btn-primary" id="walletPaySaveBtn" type="button">GUARDAR PAGO</button>
    <button class="btn-ghost" id="walletPayClearBtn" type="button">LIMPIAR</button>
  </div>

  <div id="walletPayList" style="margin-top:16px;"></div>
</div>


  
</section>

<!-- VEH√çCULOS -->
<section class="section" id="vehicles">
<div class="card">
<div class="vehicles-header">
<h2 style="margin:0;">üöô Mis Veh√≠culos</h2>
<button class="add-pill" onclick="scrollToAddVehicle()">+ Agregar</button>
</div>
<div class="vehicle-list" id="vehiclesList"></div>
</div>
<div class="card" id="addVehicleCard">
<h2>‚ûï Agregar Nuevo Veh√≠culo</h2>
<form id="vehicleForm">
<div class="form-group">
<label for="carName">Nombre del Veh√≠culo</label>
<input id="carName" placeholder="Ej: Chevrolet Aveo" required="" type="text"/>
</div>
<div class="form-group">
<label for="carYear">A√±o</label>
<input id="carYear" max="2030" min="1900" placeholder="2020" required="" type="number"/>
</div>
<div class="form-group">
<label for="carCategory">Categor√≠a</label>
<select id="carCategory" required="">
<option value="Particular">Particular</option>
<option value="Trabajo">Trabajo</option>
</select>
</div>
<div class="form-group">
<label for="carColor">Color</label>
<select id="carColor" onchange="toggleCustomColor('carColor','carColorOther')" required="" style="display:none;">
<option value="">Seleccionar...</option>
<option>Blanco</option>
<option>Blanco Perlado</option>
<option>Plata</option>
<option>Plata Met√°lico</option>
<option>Gris Claro</option>
<option>Gris Obscuro</option>
<option>Gris Oxford</option>
<option>Negro</option>
<option>Negro Mate</option>
<option>Rojo</option>
<option>Rojo Vino</option>
<option>Azul</option>
<option>Azul Marino</option>
<option>Verde</option>
<option>Verde Olivo</option>
<option>Amarillo</option>
<option>Naranja</option>
<option>Caf√©</option>
<option>Dorado</option>
<option>Morado</option>
<option value="__otro__">Otro‚Ä¶</option>
</select>
<div class="color-palette" data-select="carColor" data-other="carColorOther"></div>
<input id="carColorOther" placeholder="Escribe el color..." style="display:none; margin-top:0.75rem;" type="text"/>
<small class="color-palette-hint">Tip: elige un tono que se distinga (ej. Gris Claro vs Gris Obscuro).</small>
</div>
<div class="form-group">
<label for="carPlates">Placas</label>
<input id="carPlates" placeholder="ABC-123-D" type="text"/>
</div>
<div class="form-group">
<label for="carValue">Valor del veh√≠culo ($)</label>
<input id="carValue" type="number" step="0.01" placeholder="Ej: 150000" />
<small style="display:block; margin-top:.35rem; color:rgba(255,255,255,0.65); font-weight:700;">
  Tip: puedes poner el valor de compra o el valor actual estimado.
</small>
</div>
<!-- FOTO DEL VEH√çCULO (opcional) -->
<div class="form-group">
<label for="carPhoto">Fotograf√≠a del veh√≠culo (opcional)</label>
<input accept="image/*" id="carPhoto" type="file"/>
<div id="carPhotoPreviewWrap" style="display:none; margin-top:0.75rem;">
<img alt="Vista previa" id="carPhotoPreview" style="width:100%;max-height:240px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.15);"/>
<button class="btn btn-secondary" onclick="clearCarPhoto()" style="margin-top:.6rem;" type="button">Quitar foto</button>
</div>
<small style="display:block; margin-top:.6rem; color:rgba(255,255,255,0.65); font-weight:700;">
              Tip: usa una foto ligera para que cargue r√°pido (ideal &lt; 1MB).
            </small>
</div>
<button class="btn btn-primary" type="submit">Agregar Veh√≠culo</button>
</form>
</div>
</section>
<!-- VERIFICACIONES -->
<section class="section" id="verification">
<div class="card">
<h2>üìã Gesti√≥n de Verificaciones, Tenencia y Multas</h2>
<div id="vehicleSelector">
<p class="empty-state">Por favor, selecciona un veh√≠culo para gestionar sus verificaciones</p>
</div>
</div>
<div id="verificationForm" style="display:none;">
<div class="card">
<h2>‚ûï Agregar Registro</h2>
<form id="addVerificationForm">
<div class="form-group">
<label for="verificationType">Tipo</label>
<select id="verificationType" required="">
<option value="">Seleccionar...</option>
<option value="verificacion">Verificaci√≥n</option>
<option value="tenencia">Tenencia</option>
<option value="multa">Multa</option>
</select>
</div>
<div class="form-group">
<label for="verificationDate">Fecha</label>
<input id="verificationDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="verificationNext">Pr√≥xima Fecha (para verificaci√≥n/tenencia)</label>
<input id="verificationNext" type="date"/>
</div>
<div class="form-group">
<label for="verificationAmount">Monto (opcional)</label>
<input id="verificationAmount" placeholder="$0.00" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="verificationNotes">Notas</label>
<textarea id="verificationNotes" placeholder="Detalles adicionales..."></textarea>
</div>
<button class="btn btn-primary" type="submit">Agregar Registro</button>
</form>
</div>
</div>
</section>
<!-- MANTENIMIENTOS -->
<section class="section" id="maintenance">
<div class="card">
<h2>üîß Gesti√≥n de Mantenimientos</h2>
<div id="maintenanceVehicleSelector">
<p class="empty-state">Por favor, selecciona un veh√≠culo para gestionar sus mantenimientos</p>
</div>
</div>
<div id="maintenanceForm" style="display:none;">
<div class="card">
<h2>‚ûï Agregar Mantenimiento</h2>
<form id="addMaintenanceForm">
<div class="form-group">
<label for="maintenanceType">Tipo de Trabajo</label>
<select id="maintenanceType" required="">
<option value="">Seleccionar...</option>
<option value="cambio_aceite">Cambio de Aceite</option>
<option value="afinacion">Afinaci√≥n</option>
<option value="frenos">Frenos</option>
<option value="llantas">Llantas</option>
<option value="suspension">Suspensi√≥n</option>
<option value="bateria">Bater√≠a</option>
<option value="transmision">Transmisi√≥n</option>
<option value="aire_acondicionado">Aire Acondicionado</option>
<option value="otro">Otro</option>
</select>
</div>
<div class="form-group">
<label for="maintenanceDescription">Descripci√≥n del Trabajo</label>
<textarea id="maintenanceDescription" placeholder="Detalles del mantenimiento realizado..." required=""></textarea>
</div>
<div class="form-group">
<label for="maintenanceDate">Fecha</label>
<input id="maintenanceDate" required="" type="date"/>
</div>
<div class="form-group">
<label for="maintenanceCost">Costo</label>
<input id="maintenanceCost" placeholder="$0.00" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="maintenanceKm">Kilometraje</label>
<input id="maintenanceKm" placeholder="50000" type="number"/>
</div>
<button class="btn btn-primary" type="submit">Agregar Mantenimiento</button>
</form>
</div>
<div class="card">
<h2>üìú Historial de Mantenimientos</h2>
<div class="maintenance-list" id="maintenanceList"></div>
</div>
</div>
</section>
<!-- AUTOS DE TRABAJO -->
<section class="section" id="workcars">
<div class="card">
<h2>üè¢ Autos de trabajo</h2>
<p style="color: var(--text-secondary); font-weight:700; margin-top:-0.75rem;">
          Aqu√≠ aparecen autom√°ticamente los veh√≠culos marcados como <b>Trabajo</b>.
        </p>
<div class="subtabs">
<button class="chip active" id="workTabHome" onclick="showWorkTab('home')">Inicio</button>
<button class="chip" id="workTabGains" onclick="showWorkTab('gains')">Ganancias</button>
<button class="chip" id="workTabDrivers" onclick="showWorkTab('drivers')">Choferes</button>
</div>
<!-- HOME -->
<div id="workHome">
<div class="work-panel">
<div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; color:#fff;">üìå Panel de Autos de Trabajo</div>
<div style="color:rgba(255,255,255,0.75); font-weight:800;">Listado r√°pido de autos de trabajo.</div>
</div>
<button class="btn btn-primary" onclick="showWorkTab('gains')" style="padding:.85rem 1.2rem;">IR A GANANCIAS</button>
</div>
<div class="work-cards" id="workVehiclesGrid"></div>
</div>
<!-- Rentabilidad ALL TIME -->
<div class="card" style="margin-top:1.25rem;">
<h2>üìä Rentabilidad (visual)</h2>
<p style="color: var(--text-secondary); margin-top:-0.75rem; margin-bottom:1rem; font-weight:800;">
              Entrada = Pagos del chofer (hist√≥rico) ‚Ä¢ Salida = Mantenimientos (hist√≥rico)
            </p>
<div class="profit-grid" id="profitAllTimeGrid"></div>
</div>
</div>
<!-- GAINS -->
<div id="workGains" style="display:none;">
<div class="work-panel">
<div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; color:#fff;">üí∞ Ganancias</div>
<div style="color:rgba(255,255,255,0.78); font-weight:800;">
                  La semana es <b>Lunes ‚Üí Domingo</b>. Los pagos se capturan <b>manual</b> por veh√≠culo.
                  Los mantenimientos dentro del rango se descuentan autom√°ticamente.
                </div>
</div>
<button class="btn btn-danger" onclick="showWorkTab('home')" style="padding:.85rem 1.2rem;">SALIR</button>
</div>
<div style="margin-top:1rem;">
<div class="form-group">
<label for="gainsMonth">Selecciona mes</label>
<input id="gainsMonth" type="month"/>
</div>
<div>
<div style="font-family:'Space Mono',monospace; font-weight:900; margin-bottom:.35rem;">Semanas (Lunes ‚Üí Domingo)</div>
<div class="weeks-grid" id="weeksGrid"></div>
</div>
<div id="weekDetail" style="margin-top:1rem;">
<div class="gain-top">
<div class="kpi">
<div class="k-title">Pagos chofer (total)</div>
<div class="k-val" id="kpiIn">$0.00</div>
</div>
<div class="kpi">
<div class="k-title">Mantenimientos (total)</div>
<div class="k-val" id="kpiOut">$0.00</div>
</div>
<div class="kpi">
<div class="k-title">Ganancia real (total)</div>
<div class="k-val" id="kpiNet">$0.00</div>
</div>
</div>
<div class="gain-cards" id="gainCards"></div>
<!-- rentabilidad VISUAL por SEMANA -->
<div class="card" style="margin-top:1.25rem; margin-bottom:0;">
<h2>üìà Rentabilidad (visual) ‚Äî Semana seleccionada</h2>
<p style="color: var(--text-secondary); margin-top:-0.75rem; margin-bottom:1rem; font-weight:800;">
                    Entrada = Pagos del chofer (esta semana) ‚Ä¢ Salida = Mantenimientos (esta semana)
                  </p>
<div class="profit-grid" id="profitWeekGrid"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- DRIVERS -->
<div id="workDrivers" style="display:none;">
  <div class="card" style="margin-top:1rem;">
    <h2>‚ûï Agregar / Editar Chofer</h2>
    <p style="color: var(--text-secondary); font-weight:800; margin-top:-0.75rem;">
      Registra choferes y as√≠gnalos a un <b>veh√≠culo de Trabajo</b>.
    </p>

    <form id="driverForm" class="form-grid" autocomplete="off">
      <div class="form-group" style="grid-column:1/-1;">
        <label>CHOFER (NOMBRE COMPLETO)</label>
        <input id="drvName" type="text" placeholder="Ej: Juan P√©rez L√≥pez" required />
      </div>

      <div class="form-group">
        <label>CELULAR</label>
        <input id="drvPhone" type="tel" placeholder="Ej: 55 1234 5678" />
      </div>

      <div class="form-group">
        <label>CORREO</label>
        <input id="drvEmail" type="email" placeholder="Ej: correo@dominio.com" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>DIRECCI√ìN</label>
        <input id="drvAddress" type="text" placeholder="Calle, n√∫mero, colonia, alcald√≠a/municipio, estado" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>VEH√çCULO ASIGNADO (TRABAJO)</label>
        <select id="drvVehicle">
          <option value="">Sin asignar</option>
        </select>
        <small style="color:rgba(255,255,255,0.65); font-weight:800;">
          Nota: si tiene veh√≠culo asignado, se mantendr√° como activo.
        </small>
      </div>

      <div class="form-group">
        <label>FECHA DE INICIO</label>
        <input id="drvStart" type="date" />
      </div>

      <div class="form-group">
        <label>FECHA FINAL (SI DEJ√ì DE TRABAJAR)</label>
        <input id="drvEnd" type="date" />
      </div>

      <div class="form-group" style="grid-column:1/-1;">
        <label>OBSERVACIONES</label>
        <textarea id="drvNotes" rows="3" placeholder="Notas, incidencias, comentarios..."></textarea>
      </div>

      <div class="card" style="grid-column:1/-1; margin-top:.25rem;">
        <h2>üìå Referencia</h2>
        <div class="form-grid">
          <div class="form-group" style="grid-column:1/-1;">
            <label>NOMBRE</label>
            <input id="refName" type="text" placeholder="Ej: Mar√≠a Gonz√°lez" />
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>CELULAR</label>
            <input id="refPhone" type="tel" placeholder="Ej: 55 0000 0000" />
          </div>
        </div>
      </div>

      <input type="hidden" id="drvId" value="" />

      <div style="display:flex; gap:0.75rem; margin-top:1rem; grid-column:1/-1;">
        <button class="btn btn-primary" type="submit" style="flex:1;">GUARDAR CHOFER</button>
        <button class="btn btn-secondary" type="button" onclick="resetDriverForm()" style="flex:1;">LIMPIAR</button>
      </div>
    </form>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h2>üë• Choferes registrados</h2>
    <div id="driversList" class="maintenance-list"></div>
  </div>
</div>
</section>
</div>
<!-- MODAL EDITAR -->
<div class="modal-overlay" id="editModal" style="display:none;">
<div class="modal">
<div class="modal-header">
<h3>‚úèÔ∏è Editar Veh√≠culo</h3>
<button class="modal-close" onclick="closeEditModal()">‚úï</button>
</div>
<form id="editVehicleForm">
<input id="editCarId" type="hidden">
<div class="form-group">
<label for="editCarName">Nombre del Veh√≠culo</label>
<input id="editCarName" required="" type="text"/>
</div>
<div class="form-group">
<label for="editCarYear">A√±o</label>
<input id="editCarYear" max="2030" min="1900" required="" type="number"/>
</div>
<div class="form-group">
<label for="editCarCategory">Categor√≠a</label>
<select id="editCarCategory" required="">
<option value="Particular">Particular</option>
<option value="Trabajo">Trabajo</option>
</select>
</div>
<div class="form-group">
<label for="editCarColor">Color</label>
<select id="editCarColor" onchange="toggleCustomColor('editCarColor','editCarColorOther')" required="" style="display:none;">
<option value="">Seleccionar...</option>
<option>Blanco</option>
<option>Blanco Perlado</option>
<option>Plata</option>
<option>Plata Met√°lico</option>
<option>Gris Claro</option>
<option>Gris Obscuro</option>
<option>Gris Oxford</option>
<option>Negro</option>
<option>Negro Mate</option>
<option>Rojo</option>
<option>Rojo Vino</option>
<option>Azul</option>
<option>Azul Marino</option>
<option>Verde</option>
<option>Verde Olivo</option>
<option>Amarillo</option>
<option>Naranja</option>
<option>Caf√©</option>
<option>Dorado</option>
<option>Morado</option>
<option value="__otro__">Otro‚Ä¶</option>
</select>
<div class="color-palette" data-select="editCarColor" data-other="editCarColorOther"></div>
<input id="editCarColorOther" placeholder="Escribe el color..." style="display:none; margin-top:0.75rem;" type="text"/>
<small class="color-palette-hint">Tip: elige un tono que se distinga (ej. Gris Claro vs Gris Obscuro).</small>
</div>
<div class="form-group">
<label for="editCarPlates">Placas</label>
<input id="editCarPlates" type="text"/>
</div>
<div class="form-group">
<label for="editCarValue">Valor del veh√≠culo ($)</label>
<input id="editCarValue" type="number" step="0.01" placeholder="Ej: 150000"/>
<small style="display:block; margin-top:.35rem; color:rgba(255,255,255,0.65); font-weight:700;">
  Tip: puedes poner el valor de compra o el valor actual estimado.
</small>
</div>
<!-- FOTO DEL VEH√çCULO (opcional) -->
<div class="form-group">
<label for="editCarPhoto">Fotograf√≠a del veh√≠culo (opcional)</label>
<input accept="image/*" id="editCarPhoto" type="file"/>
<div id="editCarPhotoPreviewWrap" style="display:none; margin-top:0.75rem;">
<img alt="Vista previa" id="editCarPhotoPreview" style="width:100%;max-height:240px;object-fit:cover;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.15);"/>
<button class="btn btn-secondary" onclick="clearEditCarPhoto()" style="margin-top:.6rem;" type="button">Quitar foto</button>
</div>
<small style="display:block; margin-top:.6rem; color:rgba(255,255,255,0.65); font-weight:700;">
            Tip: usa una foto ligera para que cargue r√°pido (ideal &lt; 1MB).
          </small>
</div>
<div style="display:flex; gap:0.75rem; margin-top:1rem;">
<button class="btn btn-danger" onclick="closeEditModal()" style="flex:1;" type="button">Cancelar</button>
<button class="btn btn-primary" style="flex:1;" type="submit">Guardar cambios</button>
</div>
</input></form>
</div>
</div>
<script>
    // =========================
    // Storage base
    // =========================
    let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
    // Normaliza veh√≠culos antiguos: agrega value si no existe
    vehicles = vehicles.map(v => ({...v, value: Number(v.value) || 0}));
    let selectedVehicle = null;
    let verifications = JSON.parse(localStorage.getItem('verifications')) || {};
    let maintenances = JSON.parse(localStorage.getItem('maintenances')) || {};

    // =========================
    // Limpieza de datos hu√©rfanos (evita registros fantasma)
    // =========================
    function cleanOrphanMaintenances(){
      const validIds = new Set((vehicles || []).map(v => String(v.id)));
      let changed = false;

      Object.keys(maintenances || {}).forEach(id => {
        if(!validIds.has(String(id))){
          delete maintenances[id];
          changed = true;
        }
      });

      if(changed){
        localStorage.setItem('maintenances', JSON.stringify(maintenances));
      }
    }


    // Estado de edici√≥n de Verificaciones/Tenencias/Multas
    let editingVerification = { vehicleId: null, recordId: null };

    // Estado de edici√≥n de Mantenimientos
    let editingMaintenance = { vehicleId: null, recordId: null };

    // workPayments = { [vehicleId]: { [weekKeyStartISO]: number, ... }, ... }
    let workPayments = JSON.parse(localStorage.getItem('workPayments')) || {};

    
    // drivers = [{id, name, phone, email, address, vehicleId, startDate, endDate, notes, refName, refPhone}]
    let drivers = JSON.parse(localStorage.getItem('drivers')) || [];
    // =========================
    // Billetera (ingresos / egresos)
    // =========================
    // walletTx = [{id, type:'in'|'out', date:'YYYY-MM-DD', amount:number, note:string}]
    let walletTx = JSON.parse(localStorage.getItem('walletTx')) || [];

    function saveWallet(){
      localStorage.setItem('walletTx', JSON.stringify(walletTx));
    }

    // =========================
    // Sync Autos de Trabajo -> Billetera
    // =========================
    function _walletFindTxIndexById(txId){
      return (walletTx || []).findIndex(t => String(t.id) === String(txId));
    }
    function _walletUpsertTx(txId, tx){
      if(!walletTx) walletTx = [];
      const idx = _walletFindTxIndexById(txId);
      const payload = { ...tx, id: txId };
      if(idx === -1){
        walletTx.push(payload);
      }else{
        walletTx[idx] = { ...walletTx[idx], ...payload };
      }
      saveWallet();
    }
    function _walletRemoveTx(txId){
      if(!walletTx) return;
      const idx = _walletFindTxIndexById(txId);
      if(idx !== -1){
        walletTx.splice(idx,1);
        saveWallet();
      }
    }
    function _vehicleTitleById(vehicleId){
      const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
      if(!v) return String(vehicleId || '');
      const plate = (v.plates && String(v.plates).trim()) ? String(v.plates).trim() : '';
      const name  = (v.name && String(v.name).trim()) ? String(v.name).trim() : '';
      return name || plate || String(vehicleId || '');
    }

    // Upsert de pago semanal (Ingreso -> categor√≠a "Autos")
    function syncWorkPaymentToWallet(vehicleId, weekStartISO, amountOrNull){
      const txId = `wp:${vehicleId}:${weekStartISO}`;
      const amt = safeNumber(amountOrNull);
      if(!amountOrNull || amt <= 0){
        _walletRemoveTx(txId);
        return;
      }
      const veh = _vehicleTitleById(vehicleId);
      const date = normalizeISODateString(weekStartISO) || weekStartISO;
      _walletUpsertTx(txId, {
        type: 'in',
        category: 'Autos',
        date,
        amount: amt,
        note: `Pago chofer (${veh}) - Semana ${date}`
      });
    }

    // Upsert de mantenimiento (Egreso -> categor√≠a "Mantenimientos autos") SOLO si est√° completado
    function syncMaintenanceToWallet(vehicleId, maintenanceObj){
      if(!maintenanceObj) return;
      const mid = maintenanceObj.id;
      const txId = `mt:${vehicleId}:${mid}`;
      const amt = safeNumber(maintenanceObj.cost);

      // Si no hay monto v√°lido, quitamos el movimiento
      if(amt <= 0){
        _walletRemoveTx(txId);
        return;
      }

      const veh = _vehicleTitleById(vehicleId);

      // Fecha: si tiene date √∫sala; si no, plannedDate; si no, hoy
      const rawDate = maintenanceObj.date || maintenanceObj.plannedDate || ymd(new Date());
      const date = normalizeISODateString(rawDate) || rawDate;

      const desc = (maintenanceObj.description && String(maintenanceObj.description).trim()) ? String(maintenanceObj.description).trim() : '';
      const type = (maintenanceObj.type && String(maintenanceObj.type).trim()) ? String(maintenanceObj.type).trim() : 'Mantenimiento';
      const extra = desc ? ` - ${desc}` : '';

      const status = (maintenanceObj.completed === true) ? 'Realizado' : 'Programado';

      _walletUpsertTx(txId, {
        type: 'out',
        category: 'Mantenimientos autos',
        date,
        amount: amt,
        note: `Mantenimiento (${veh}) - ${type}${extra} [${status}]`
      });
    }

    // Backfill / Re-sync completo (Autos de trabajo -> Billetera)
    // Esto asegura que pagos/mantenimientos YA existentes se reflejen sin tener que editarlos.
    function syncAllWorkCarsToWallet(){
      try{
        // Sync de pagos semanales (Ingresos)
        if(workPayments){
          for(const vid of Object.keys(workPayments)){
            const weeksObj = workPayments[vid] || {};
            for(const wk of Object.keys(weeksObj)){
              syncWorkPaymentToWallet(vid, wk, weeksObj[wk]);
            }
          }
        }

        // Sync de mantenimientos (Egresos)
        if(maintenances){
          for(const vid of Object.keys(maintenances)){
            const list = maintenances[vid] || [];
            if(Array.isArray(list)){
              for(const m of list){
                syncMaintenanceToWallet(vid, m);
              }
            }
          }
        }
      }catch(_e){}
    }


    function calcWallet(){
      const inSum = (walletTx || []).filter(t=>t.type==='in').reduce((a,b)=>a+safeNumber(b.amount),0);
      const outSum = (walletTx || []).filter(t=>t.type==='out').reduce((a,b)=>a+safeNumber(b.amount),0);
      const balance = inSum - outSum;
      return { inSum, outSum, balance };
    }

    /* ===== BILLETERA: Pr√≥ximos pagos (recordatorios) ===== */
let walletUpcoming = [];

function walletLoadUpcoming(){
  try{
    walletUpcoming = JSON.parse(localStorage.getItem('walletUpcoming') || '[]') || [];
    if(!Array.isArray(walletUpcoming)) walletUpcoming = [];
  }catch(e){ walletUpcoming = []; }
}

function walletSaveUpcoming(){
  localStorage.setItem('walletUpcoming', JSON.stringify(walletUpcoming || []));
}

function walletFmtDateES(iso){
  // iso: YYYY-MM-DD
  if(!iso || String(iso).length < 10) return '';
  const [y,m,d] = iso.split('-').map(x=>parseInt(x,10));
  if(!y || !m || !d) return iso;
  const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  return `${d} de ${meses[m-1]} de ${y}`;
}

function walletISOToday(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function walletClearUpcomingForm(){
  const due = document.getElementById('walletPayDue');
  const amt = document.getElementById('walletPayAmount');
  const cat = document.getElementById('walletPayCategory');
  const note = document.getElementById('walletPayNote');
  if(due) due.value = '';
  if(amt) amt.value = '';
  if(cat) cat.value = '';
  if(note) note.value = '';
  delete document.body.dataset.walletPayEditId;
}

function renderWalletUpcoming(){
  const box = document.getElementById('walletPayList');
  if(!box) return;

  // sort by due date asc
  const items = (walletUpcoming || []).slice().sort((a,b)=> String(a.due||'').localeCompare(String(b.due||'')));

  if(items.length === 0){
    box.innerHTML = `<div style="padding:10px 0; color: rgba(255,255,255,0.65);">No hay pagos programados.</div>`;
    return;
  }

  box.innerHTML = items.map(it=>{
    const due = walletFmtDateES(it.due);
    const amt = money(safeNumber(it.amount));
    const note = String(it.note||'').trim() || 'Pago programado';
    return `
      <div class="wallet-pay-item">
        <div class="wallet-pay-meta">
          <div class="wallet-pay-title">${escapeHtml(note)}</div>
          <div class="wallet-pay-sub">
            <span>üìÖ ${escapeHtml(due || it.due || '')}</span>
            <span>üí≥ ${escapeHtml(amt)}</span>
            ${it.category ? `<span>üè∑Ô∏è ${escapeHtml(String(it.category))}</span>` : ''}
          </div>
        </div>
        <div class="wallet-pay-actions">
          <button class="btn-mini" data-pay-act="edit" data-pay-id="${it.id}">Editar</button>
          <button class="btn-mini ok" data-pay-act="done" data-pay-id="${it.id}">Terminar</button>
          <button class="btn-mini danger" data-pay-act="del" data-pay-id="${it.id}">Eliminar</button>
        </div>
      </div>
    `;
  }).join('');

  // bind actions
  box.querySelectorAll('button[data-pay-act]').forEach(btn=>{
    btn.onclick = (e)=>{
      if(e) e.preventDefault();
      const act = btn.getAttribute('data-pay-act');
      const id = btn.getAttribute('data-pay-id');
      if(!id) return;

      const idx = (walletUpcoming||[]).findIndex(x=> String(x.id) === String(id));
      if(idx < 0) return;

      if(act === 'del'){
        walletUpcoming.splice(idx,1);
        walletSaveUpcoming();
        renderWalletUpcoming();
        return;
      }

      if(act === 'edit'){
        const it = walletUpcoming[idx];
        const due = document.getElementById('walletPayDue');
        const amt = document.getElementById('walletPayAmount');
        const note = document.getElementById('walletPayNote');
        const cat = document.getElementById('walletPayCategory');
        if(due) due.value = String(it.due||'');
        if(amt) amt.value = String(it.amount||'');
        if(note) note.value = String(it.note||'');
        walletPopulateUpcomingCategorySelect();
        if(cat) cat.value = String(it.category||'');
        document.body.dataset.walletPayEditId = String(it.id);
        // scroll suave al formulario
        due?.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }

      if(act === 'done'){
        // Crear egreso en movimientos con fecha de hoy (fecha de t√©rmino)
        const it = walletUpcoming[idx];
        const doneDate = walletISOToday();

        walletTx = walletTx || [];
        walletTx.push({
          id: String(Date.now()),
          type: 'out',
          amount: safeNumber(it.amount),
          note: String(it.note||'').trim() || 'Pago',
          category: String(it.category||'').trim() || 'Otros',
          date: doneDate
        });

        // borrar el pago programado
        walletUpcoming.splice(idx,1);

        saveWallet();
        walletSaveUpcoming();

        // refrescar UI billetera
        renderWalletList();
        renderWalletCharts();
        renderWalletUpcoming();
        return;
      }
    };
  });
}

/* ===== BILLETERA: Categor√≠as (Ingresos/Egresos) ===== */
let walletCatsIn = [];
let walletCatsOut = [];

const WALLET_CATS_IN_DEFAULT = [
  "Marina",
  "Autos",
  "Empresa Computadoras",
  "Empresa ciberseguridad",
  "Futbol",
  "Ventas autos",
  "Otros"
];

const WALLET_CATS_OUT_DEFAULT = [
  "Gasto Quincena",
  "Mantenimientos autos",
  "Casa CDMX",
  "Casa cuernavaca",
  "Escuela",
  "Mis Gastos",
  "Gasolina",
  "Viajes"
];

function walletLoadCategories(){
  try{
    walletCatsIn = JSON.parse(localStorage.getItem('walletCatsIn') || '[]') || [];
    walletCatsOut = JSON.parse(localStorage.getItem('walletCatsOut') || '[]') || [];
  }catch(_){
    walletCatsIn = [];
    walletCatsOut = [];
  }
  if(!Array.isArray(walletCatsIn) || walletCatsIn.length === 0) walletCatsIn = WALLET_CATS_IN_DEFAULT.slice();
  if(!Array.isArray(walletCatsOut) || walletCatsOut.length === 0) walletCatsOut = WALLET_CATS_OUT_DEFAULT.slice();

  // limpiar duplicados / vac√≠os
  walletCatsIn = Array.from(new Set(walletCatsIn.map(x=>String(x||'').trim()).filter(Boolean)));
  walletCatsOut = Array.from(new Set(walletCatsOut.map(x=>String(x||'').trim()).filter(Boolean)));
}

function walletSaveCategories(){
  localStorage.setItem('walletCatsIn', JSON.stringify(walletCatsIn || []));
  localStorage.setItem('walletCatsOut', JSON.stringify(walletCatsOut || []));
}


function walletPopulateUpcomingCategorySelect(){
  const sel = document.getElementById('walletPayCategory');
  if(!sel) return;

  // Asegurar categor√≠as cargadas
  if(!Array.isArray(walletCatsOut) || walletCatsOut.length === 0){
    try{ walletLoadCategories(); }catch(e){}
  }

  const current = String(sel.value || '').trim();
  const opts = ['<option value="">Seleccionar...</option>']
    .concat((walletCatsOut || []).map(c=>{
      const v = String(c||'').trim();
      if(!v) return '';
      const esc = escapeHtml(v);
      return `<option value="${esc}">${esc}</option>`;
    }).filter(Boolean));

  sel.innerHTML = opts.join('');
  if(current){
    // re-seleccionar si todav√≠a existe
    const exists = (walletCatsOut || []).some(c=>String(c||'').trim() === current);
    sel.value = exists ? current : '';
  }
}

function walletPopulateCategorySelect(){
  const wrap = document.getElementById('walletCategoryWrap');
  const typeSel = document.getElementById('walletType');
  const catSel = document.getElementById('walletCategory');
  if(!wrap || !typeSel || !catSel) return;

  const t = String(typeSel.value || '').trim(); // 'in' | 'out'
  if(t !== 'in' && t !== 'out'){
    wrap.style.display = 'none';
    catSel.innerHTML = '<option value="">Seleccionar...</option>';
    return;
  }

  wrap.style.display = '';
  const arr = (t === 'in') ? walletCatsIn : walletCatsOut;
  const current = catSel.value || '';

  catSel.innerHTML = '<option value="">Seleccionar...</option>' + arr.map(c=>{
    const esc = escapeHtml(c);
    return `<option value="${esc}">${esc}</option>`;
  }).join('');

  if(current && arr.includes(current)) catSel.value = current;
}

function walletAddNewCategory(){
  const t = String(document.getElementById('walletType')?.value || '').trim();
  if(t !== 'in' && t !== 'out'){
    showAlert('warning','Primero selecciona el tipo (Ingreso/Egreso).');
    return;
  }
  const name = prompt('Nombre de la nueva categor√≠a:');
  if(!name) return;
  const cat = String(name).trim();
  if(!cat) return;

  if(t === 'in'){
    if(!walletCatsIn.includes(cat)) walletCatsIn.push(cat);
  }else{
    if(!walletCatsOut.includes(cat)) walletCatsOut.push(cat);
  }
  walletSaveCategories();
  walletPopulateCategorySelect();
  walletPopulateUpcomingCategorySelect();
  const catSel = document.getElementById('walletCategory');
  if(catSel) catSel.value = cat;
}


function walletRemoveCategory(){
  const t = String(document.getElementById('walletType')?.value || '').trim();
  const catSel = document.getElementById('walletCategory');
  const raw = String(catSel?.value || '').trim();

  if(t !== 'in' && t !== 'out'){
    showAlert('warning','Primero selecciona el tipo (Ingreso/Egreso).');
    return;
  }
  if(!raw){
    showAlert('warning','Selecciona la categor√≠a que deseas quitar.');
    return;
  }

  // Aviso si existen movimientos con esa categor√≠a
  const usedCount = (walletTx || []).filter(x => String(x?.type||'').trim()===t && String(x?.category||'').trim()===raw).length;
  const msg = usedCount > 0
    ? `Vas a quitar la categor√≠a "${raw}".\n\n‚ö†Ô∏è Nota: Hay ${usedCount} movimiento(s) con esa categor√≠a (no se borrar√°n, solo ya no aparecer√° en el selector).\n\n¬øDeseas continuar?`
    : `¬øSeguro que quieres quitar la categor√≠a "${raw}"?`;

  if(!confirm(msg)) return;

  if(t === 'in'){
    walletCatsIn = (walletCatsIn || []).filter(c => String(c).trim() !== raw);
  }else{
    walletCatsOut = (walletCatsOut || []).filter(c => String(c).trim() !== raw);
  }

  walletSaveCategories();
  walletPopulateCategorySelect();
  if(catSel) catSel.value = '';

  showAlert('success','Categor√≠a eliminada del selector.');
}

function renderWallet(){
  walletLoadCategories();
walletLoadUpcoming();
  // Cargar categor√≠as de Egresos en Pr√≥ximos pagos
  walletPopulateUpcomingCategorySelect();
// KPIs
  const w = calcWallet();
  const elBal = document.getElementById('walletBalance');
  const elIn  = document.getElementById('walletIn');
  const elOut = document.getElementById('walletOut');
  if(elBal) elBal.textContent = money(w.balance);
  if(elIn)  elIn.textContent  = money(w.inSum);
  if(elOut) elOut.textContent = money(w.outSum);

  // default date hoy
  const wd = document.getElementById('walletDate');
  if(wd && !wd.value){
    const now = new Date();
    wd.value = ymd(now);
  }

  // Calendario por rango de meses (multi-a√±o)
  const wmFrom = document.getElementById('walletMonthFrom');
  const wmTo = document.getElementById('walletMonthTo');
  if(wmFrom && wmTo){
    const now = new Date();
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const cur = `${now.getFullYear()}-${mm}`;

    if(!wmFrom.value) wmFrom.value = cur;
    if(!wmTo.value) wmTo.value = wmFrom.value || cur;

    const normalizeRange = ()=>{
      if(wmFrom.value && wmTo.value && wmFrom.value > wmTo.value){
        wmTo.value = wmFrom.value;
      }
    };

    wmFrom.onchange = ()=>{
      normalizeRange();
      renderWalletList();
      renderWalletCharts();
    };
    wmTo.onchange = ()=>{
      normalizeRange();
      renderWalletList();
      renderWalletCharts();
    };
  }

renderWalletList();
  renderWalletCharts();
  renderWalletDashboardCard();

// Pr√≥ximos pagos: defaults + botones
const payDue = document.getElementById('walletPayDue');
if(payDue && !payDue.value) payDue.value = walletISOToday();

const paySave = document.getElementById('walletPaySaveBtn');
const payClear = document.getElementById('walletPayClearBtn');

if(paySave){
  paySave.onclick = (e)=>{
      if(e) e.preventDefault();
    const due = document.getElementById('walletPayDue')?.value || '';
    const amount = safeNumber(document.getElementById('walletPayAmount')?.value || 0);
    const note = String(document.getElementById('walletPayNote')?.value || '').trim();
    const category = String(document.getElementById('walletPayCategory')?.value || '').trim();

    if(!due){ alert('Selecciona la fecha programada.'); return; }
    if(!(amount > 0)){ alert('Ingresa un monto v√°lido.'); return; }
    if(!note){ alert('Escribe un concepto o nota.'); return; }
    if(!category){ alert('Selecciona una categor√≠a.'); return; }

    const editId = document.body.dataset.walletPayEditId;
    if(editId){
      const idx = (walletUpcoming||[]).findIndex(x=>String(x.id)===String(editId));
      if(idx >= 0){
        walletUpcoming[idx].due = due;
        walletUpcoming[idx].amount = amount;
        walletUpcoming[idx].note = note;
        walletUpcoming[idx].category = category;
      }
    }else{
      walletUpcoming = walletUpcoming || [];
      walletUpcoming.push({ id: String(Date.now()), due, amount, note, category });
    }

    walletSaveUpcoming();
    walletClearUpcomingForm();
    if(payDue) payDue.value = walletISOToday();
    renderWalletUpcoming();
  };
}

if(payClear){
  payClear.onclick = (e)=>{
      if(e) e.preventDefault();
    walletClearUpcomingForm();
    if(payDue) payDue.value = walletISOToday();
  };
}

renderWalletUpcoming();
}


    function renderWalletList(){
  const list = document.getElementById('walletTxList');
  if(!list) return;

  const mFrom = document.getElementById('walletMonthFrom')?.value || '';
  const mTo   = document.getElementById('walletMonthTo')?.value || mFrom || '';

  const items = (walletTx || [])
    .slice()
    .filter(t => {
      if(!mFrom) return true;
      const d = String(t?.date || '').trim();   // "YYYY-MM-DD"
      const ym = (d.length >= 7) ? d.slice(0,7) : '';
      if(!ym) return false;
      if(!mTo) return ym === mFrom;
      return (ym >= mFrom && ym <= mTo);
    })
    .sort((a,b)=>{
      const da = parseISODateLocal(a.date)?.getTime() || 0;
      const db = parseISODateLocal(b.date)?.getTime() || 0;
      if(db !== da) return db - da;
      return String(b.id).localeCompare(String(a.id));
    });

  if(items.length === 0){
    list.innerHTML = '<div class="empty-state">No hay movimientos para este mes.</div>';
    return;
  }

  const incomes  = items.filter(t => t.type === 'in');
  const expenses = items.filter(t => t.type === 'out');

  const renderTxItems = (arr) => {
    if(!arr.length) return '<div class="empty-state" style="padding:0.75rem 0;">Sin movimientos.</div>';

    return `
      <div class="maintenance-list">
        ${arr.map(t=>{
          const isIn = t.type === 'in';
          const badge = isIn
            ? '<span class="badge badge-success">Ingreso</span>'
            : '<span class="badge badge-danger">Egreso</span>';
          const sign = isIn ? '+' : '-';
          const amt = money(safeNumber(t.amount));
          const note = (t.note || '').trim();
          const noteHtml = note ? `<p>${escapeHtml(note)}</p>` : '<p style="opacity:.75;">(Sin nota)</p>';

          return `
            <div class="maintenance-item">
              <div class="item-info">
                <h4>${badge} <span style="margin-left:.5rem; font-family:'Space Mono',monospace;">${escapeHtml(formatDateMX(t.date))}</span></h4>
                <div style="margin-top:.35rem;">
                  <div style="font-weight:900; font-size:1.05rem;">${sign} ${escapeHtml(amt)}</div>
                  ${noteHtml}
                </div>
              </div>
              <div class="row-actions" style="align-self:flex-start;">
                <button class="btn-mini danger" type="button" onclick="deleteWalletTx('${String(t.id)}')">Eliminar</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  };

  const col = (titleHtml, count, innerHtml) => `
    <details class="wallet-drop">
      <summary>
        <div class="wallet-col-title">${titleHtml} <span class="hint">${count} mov.</span></div>
        <div class="wallet-caret">‚ñæ</div>
      </summary>
      <div class="wallet-scroll">
        ${innerHtml}
      </div>
    </details>
  `;

  list.innerHTML = `
    <div class="wallet-columns">
      <div class="wallet-col">
        ${col('‚úÖ&nbsp;Ingresos', incomes.length, renderTxItems(incomes))}
      </div>
      <div class="wallet-col">
        ${col('‚õî&nbsp;Egresos', expenses.length, renderTxItems(expenses))}
      </div>
    </div>
  `;
}


// =========================
// Billetera: Gr√°ficas (Mes actual / seleccionado + A√±o)
// =========================
function walletResizeCanvasToDisplay(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const targetW = Math.max(280, Math.floor(rect.width));
  const targetH = Math.max(220, Math.floor(rect.height));
  if(canvas.width !== Math.floor(targetW*dpr) || canvas.height !== Math.floor(targetH*dpr)){
    canvas.width = Math.floor(targetW*dpr);
    canvas.height = Math.floor(targetH*dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
}

function walletStyleVars(){
  const cs = getComputedStyle(document.documentElement);
  return {
    cIn: (cs.getPropertyValue('--success') || '#00E676').trim(),
    cOut:(cs.getPropertyValue('--danger')  || '#ef4444').trim(),
    grid:'rgba(255,255,255,0.10)',
    text:'rgba(255,255,255,0.85)',
    sub :'rgba(255,255,255,0.60)',
    panel:'rgba(0,0,0,0.12)'
  };
}

function walletGetRangeISO(){
  const wmFrom = document.getElementById('walletMonthFrom');
  const wmTo = document.getElementById('walletMonthTo');

  const now = new Date();
  const mm = String(now.getMonth()+1).padStart(2,'0');
  const cur = `${now.getFullYear()}-${mm}`;

  let from = (wmFrom && wmFrom.value) ? wmFrom.value : cur;
  let to = (wmTo && wmTo.value) ? wmTo.value : from;

  if(from && to && from > to) to = from;
  return { from, to };
}

function walletFilterByRange(mFrom, mTo){
  return (walletTx || []).filter(t=>{
    const d = String(t?.date || '').trim(); // YYYY-MM-DD
    if(d.length < 7) return false;
    const ym = d.slice(0,7);
    if(!mFrom) return true;
    if(!mTo) return ym === mFrom;
    return (ym >= mFrom && ym <= mTo);
  });
}

function walletAggRangeInOut(mFrom, mTo){
  const items = walletFilterByRange(mFrom, mTo);
  let inSum = 0, outSum = 0;
  items.forEach(t=>{
    const amt = safeNumber(t.amount);
    if(t.type === 'in') inSum += amt;
    if(t.type === 'out') outSum += amt;
  });
  return { inSum, outSum, items };
}

function walletTopExpenseConceptsRange(mFrom, mTo){
  const items = walletFilterByRange(mFrom, mTo).filter(t=>t.type==='out');
  const map = {}; // concept -> sum
  items.forEach(t=>{
    const note = String(t.note || '').trim();
    let concept = note ? note.split(/\s+/)[0] : 'Sin';
    concept = concept ? concept.slice(0,18) : 'Sin';
    if(!concept) concept = 'Sin';
    map[concept] = (map[concept] || 0) + safeNumber(t.amount);
  });
  const arr = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  const top = arr.slice(0,6);
  const rest = arr.slice(6);
  const otherSum = rest.reduce((s, [,v])=>s+v, 0);
  if(otherSum > 0) top.push(['Otros', otherSum]);
  return top; // [ [label, value], ... ]
}

function walletAggMonthDaily(mFrom, mTo){
  // Si es un solo mes => serie diaria
  if(mFrom && mTo && mFrom === mTo){
    const y = parseInt(mFrom.slice(0,4), 10);
    const m = parseInt(mFrom.slice(5,7), 10); // 1-12
    if(isNaN(y) || isNaN(m) || m < 1 || m > 12){
      return { labels: [], inArr: [], outArr: [] };
    }

    const daysInMonth = new Date(y, m, 0).getDate();
    const labels = [];
    const inArr = Array(daysInMonth).fill(0);
    const outArr = Array(daysInMonth).fill(0);

    for(let d=1; d<=daysInMonth; d++){
      labels.push(String(d).padStart(2,'0'));
    }

    (walletTx || []).forEach(t=>{
      const ds = String(t?.date || '').trim(); // "YYYY-MM-DD"
      if(ds.length < 10) return;
      if(ds.slice(0,7) !== mFrom) return;

      const day = parseInt(ds.slice(8,10), 10);
      if(isNaN(day) || day < 1 || day > daysInMonth) return;

      const amt = safeNumber(t.amount);
      const idx = day - 1;
      if(t.type === 'in') inArr[idx] += amt;
      if(t.type === 'out') outArr[idx] += amt;
    });

    return { labels, inArr, outArr };
  }

  // Rango de meses => serie mensual (un punto por mes)
  const labels = [];
  const inArr = [];
  const outArr = [];

  if(!mFrom) return { labels: [], inArr: [], outArr: [] };
  if(!mTo) mTo = mFrom;
  if(mFrom > mTo) mTo = mFrom;

  let y = parseInt(mFrom.slice(0,4),10);
  let m = parseInt(mFrom.slice(5,7),10);
  const yEnd = parseInt(mTo.slice(0,4),10);
  const mEnd = parseInt(mTo.slice(5,7),10);

  while(y < yEnd || (y === yEnd && m <= mEnd)){
    const mm = String(m).padStart(2,'0');
    const key = `${y}-${mm}`;
    labels.push(key);

    let sIn = 0, sOut = 0;
    (walletTx || []).forEach(t=>{
      const ds = String(t?.date || '').trim();
      if(ds.length < 7) return;
      if(ds.slice(0,7) !== key) return;
      const amt = safeNumber(t.amount);
      if(t.type === 'in') sIn += amt;
      if(t.type === 'out') sOut += amt;
    });
    inArr.push(sIn);
    outArr.push(sOut);

    m++;
    if(m > 12){ m = 1; y++; }
  }

  return { labels, inArr, outArr };
}


function walletDrawMonthBars(canvas, inSum, outSum, title){
  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { cIn, cOut, grid, text, sub } = walletStyleVars();
  const cGain = '#3b82f6'; // azul para ganancia

  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // title
  ctx.fillStyle = text;
  ctx.font = "700 13px Space Mono, monospace";
  ctx.fillText(title, 14, 20);

  const gain = inSum - outSum;

  const top=34, left=55, right=14, bottom=30;
  const pw = w-left-right, ph=h-top-bottom;

  const maxVal = Math.max(1, inSum, outSum, gain) * 1.15;

  // grid + eje Y con cantidades
  ctx.strokeStyle = grid;
  ctx.fillStyle = sub;
  ctx.font = "700 11px DM Sans, sans-serif";

  for(let i=0;i<=4;i++){
    const y = top + ph*(i/4);
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(left+pw,y); ctx.stroke();

    const val = Math.round(maxVal * (1 - i/4));
    const label = money(val);
    const tw = ctx.measureText(label).width;
    ctx.fillText(label, left - tw - 6, y + 3);
  }

  const labels = ["Ingresos","Egresos","Ganancia"];
  const vals = [inSum, outSum, gain];
  const cols = [cIn, cOut, cGain];

  const barW = Math.min(60, pw/7);
  const gap = Math.min(40, pw/10);
  const baseX = left + pw/2 - (barW*3 + gap*2)/2;

  for(let i=0;i<3;i++){
    const bh = (vals[i]/maxVal)*ph;
    const x = baseX + i*(barW+gap);

    ctx.fillStyle = cols[i];
    ctx.globalAlpha = 0.9;
    ctx.fillRect(x, top+ph-bh, barW, bh);
    ctx.globalAlpha = 1;

    // cantidad arriba
    ctx.fillStyle = text;
    ctx.font = "800 12px DM Sans, sans-serif";
    const valStr = money(vals[i]);
    const twVal = ctx.measureText(valStr).width;
    ctx.fillText(valStr, x + (barW - twVal)/2, top+ph-bh-6);

    // nombre abajo
    ctx.fillStyle = sub;
    ctx.font = "700 12px DM Sans, sans-serif";
    const tw = ctx.measureText(labels[i]).width;
    ctx.fillText(labels[i], x + (barW-tw)/2, top+ph+18);
  }
}

function walletDrawDonut(canvas, inSum, outSum, title){
  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { cIn, cOut, text, sub, grid } = walletStyleVars();

  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // title
  ctx.fillStyle = text;
  ctx.font = "700 13px Space Mono, monospace";
  ctx.fillText(title, 14, 20);

  const total = inSum + outSum;
  if(total <= 0){
    ctx.fillStyle = sub;
    ctx.font = "800 13px DM Sans, sans-serif";
    ctx.fillText("Sin datos en este mes.", 14, 48);
    return;
  }

  const cx = w/2, cy = (h/2)+6;
  const r = Math.min(w,h)*0.32;
  const rIn = r*0.62;

  // Angles
  const aIn = (inSum/total) * Math.PI*2;
  const aOut = (outSum/total) * Math.PI*2;

  let ang = -Math.PI/2;

  // Ingresos slice
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.arc(cx,cy,r,ang,ang+aIn);
  ctx.closePath();
  ctx.fillStyle = cIn;
  ctx.globalAlpha = 0.85;
  ctx.fill();
  ctx.globalAlpha = 1;
  ang += aIn;

  // Egresos slice
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.arc(cx,cy,r,ang,ang+aOut);
  ctx.closePath();
  ctx.fillStyle = cOut;
  ctx.globalAlpha = 0.85;
  ctx.fill();
  ctx.globalAlpha = 1;

  // Hole
  ctx.beginPath();
  ctx.arc(cx,cy,rIn,0,Math.PI*2);
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.fill();
  ctx.strokeStyle = grid;
  ctx.stroke();

  // Center text (ganancias en azul con contraste)
  const balance = inSum - outSum;

  const blue = '#3b82f6';

  // c√≠rculo central m√°s oscuro para contraste
  ctx.beginPath();
  ctx.arc(cx, cy, rIn * 0.92, 0, Math.PI * 2);
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  ctx.fill();

  // sombra suave
  ctx.shadowColor = 'rgba(0,0,0,0.6)';
  ctx.shadowBlur = 6;

  ctx.fillStyle = blue;
  ctx.font = "900 16px Space Mono, monospace";
  const balStr = money(balance);
  const tw = ctx.measureText(balStr).width;
  ctx.fillText(balStr, cx - tw/2, cy+2);

  ctx.shadowBlur = 0;

  ctx.fillStyle = blue;
  ctx.font = "900 12px DM Sans, sans-serif";
  const lab = "Ganancias";
  const lw = ctx.measureText(lab).width;
  ctx.fillText(lab, cx - lw/2, cy+18);

  // Legend
  let lx = 14, ly = h-8;
  ctx.font = "800 11px DM Sans, sans-serif";

  ctx.fillStyle = cIn;
  ctx.fillRect(lx, ly-10, 10, 10);
  ctx.fillStyle = text;
  ctx.fillText("Ingresos", lx+14, ly);
  lx += 14 + ctx.measureText("Ingresos").width + 16;

  ctx.fillStyle = cOut;
  ctx.fillRect(lx, ly-10, 10, 10);
  ctx.fillStyle = text;
  ctx.fillText("Egresos", lx+14, ly);
}

function walletCategoryColor(mode, i){
  // mode: 'in' | 'out'
  // Golden-angle palette for distinct colors (per categor√≠a)
  const base = (mode === 'in') ? 140 : 10;     // verde-ish / rojo-ish de arranque
  const hue = (base + (i * 137.508)) % 360;    // golden angle
  const sat = 82;
  const light = 52;
  return `hsl(${hue} ${sat}% ${light}%)`;
}

function walletDrawCategoryDonut(canvas, labels, values, title, base){
  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { text, sub, grid } = walletStyleVars();

  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // title
  ctx.fillStyle = text;
  ctx.font = "700 13px Space Mono, monospace";
  ctx.fillText(title, 14, 20);

  const total = (values || []).reduce((a,b)=>a+Number(b||0),0);
  if(!total || total <= 0){
    ctx.fillStyle = sub;
    ctx.font = "800 13px DM Sans, sans-serif";
    ctx.fillText("Sin datos en este mes.", 14, 48);
    return;
  }

  const cx = w/2, cy = (h/2)+6;
  const r = Math.min(w,h)*0.32;
  const rIn = r*0.62;

  // Draw slices
  let ang = -Math.PI/2;
  const n = labels.length;

  for(let i=0;i<n;i++){
    const v = Number(values[i]||0);
    const a = (v/total) * Math.PI*2;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,ang,ang+a);
    ctx.closePath();
    ctx.fillStyle = walletCategoryColor(base, i);
    ctx.globalAlpha = 0.88;
    ctx.fill();
    ctx.globalAlpha = 1;

    ang += a;
  }

  // Hole
  ctx.beginPath();
  ctx.arc(cx,cy,rIn,0,Math.PI*2);
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.fill();
  ctx.strokeStyle = grid;
  ctx.stroke();

  // Center total
  ctx.beginPath();
  ctx.arc(cx,cy,rIn * 0.92, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  ctx.fill();

  ctx.fillStyle = (base === 'in') ? '#22c55e' : '#ef4444';
  ctx.font = "900 15px Space Mono, monospace";
  const totStr = money(total);
  const tw = ctx.measureText(totStr).width;
  ctx.fillText(totStr, cx - tw/2, cy+2);

  ctx.fillStyle = text;
  ctx.font = "900 12px DM Sans, sans-serif";
  const lab = "Total";
  const lw = ctx.measureText(lab).width;
  ctx.fillText(lab, cx - lw/2, cy+18);

  // Legend (up to 6 items)
  const maxLeg = 10;
  const shown = Math.min(labels.length, maxLeg);
  let lx = 14, ly = h-8;
  ctx.font = "800 11px DM Sans, sans-serif";

  for(let i=0;i<shown;i++){
    const name = labels[i];
    ctx.fillStyle = walletCategoryColor(base, i);
    ctx.fillRect(lx, ly-10, 10, 10);
    ctx.fillStyle = text;
    ctx.fillText(name, lx+14, ly);
    lx += 14 + ctx.measureText(name).width + 16;
    if(lx > w-120){
      lx = 14;
      ly -= 16;
    }
  }
  if(labels.length > maxLeg){
    ctx.fillStyle = sub;
    ctx.fillText(`+${labels.length-maxLeg} m√°s`, lx, ly);
  }
}

function walletDrawTrend(canvas, labels, inArr, outArr, title){
  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { cIn, cOut, grid, text, sub } = walletStyleVars();
  const cGain = '#3b82f6';

  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // title
  ctx.fillStyle = text;
  ctx.font = "700 13px Space Mono, monospace";
  ctx.fillText(title, 14, 20);

  // legend
  ctx.font = "700 12px DM Sans, sans-serif";
  ctx.fillStyle = cIn; ctx.fillRect(14, 30, 10, 10);
  ctx.fillStyle = text; ctx.fillText("Ingresos", 28, 39);

  ctx.fillStyle = cOut; ctx.fillRect(105, 30, 10, 10);
  ctx.fillStyle = text; ctx.fillText("Egresos", 119, 39);

  ctx.fillStyle = cGain; ctx.fillRect(185, 30, 10, 10);
  ctx.fillStyle = text; ctx.fillText("Ganancia", 199, 39);

  const top=52, left=62, right=14, bottom=34;
  const pw = w-left-right, ph=h-top-bottom;

  const gainArr = (inArr || []).map((v,i)=> Math.max(0, v - (outArr[i]||0)));
  const maxVal = Math.max(1, ...(inArr||[0]), ...(outArr||[0]), ...gainArr) * 1.15;

  // grid
  ctx.strokeStyle = grid;
  for(let i=0;i<=4;i++){
    const y = top + ph*(i/4);
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(left+pw,y); ctx.stroke();
  }

  const n = labels.length;
  if(n < 2){
    ctx.fillStyle = sub;
    ctx.font = "800 13px DM Sans, sans-serif";
    ctx.fillText("Sin datos.", 14, top + 20);
    return;
  }

  const xAt = i => left + (pw * (i/(n-1)));
  const yAt = v => top + ph - ((v/maxVal)*ph);

  function drawLine(arr, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const x = xAt(i);
      const y = yAt((arr[i]||0));
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  drawLine(inArr, cIn);
  drawLine(outArr, cOut);
  drawLine(gainArr, cGain);

  // x labels
  const k = (n <= 16) ? 2 : (n <= 24) ? 3 : 5;
  ctx.fillStyle = sub;
  ctx.font = "700 11px DM Sans, sans-serif";
  for(let i=0;i<n;i+=k){
    const lbl = labels[i];
    const tw = ctx.measureText(lbl).width;
    ctx.fillText(lbl, xAt(i)-tw/2, top+ph+20);
  }

  // eje Y labels (m√°s peque√±os para que no se corten)
  ctx.fillStyle = sub;
  ctx.font = "700 10px DM Sans, sans-serif";
  for(let i=0;i<=4;i++){
    const val = Math.round(maxVal * (1 - i/4));
    const lab = money(val);
    const y = top + ph*(i/4);
    const tw = ctx.measureText(lab).width;
    ctx.fillText(lab, left - tw - 6, y + 3);
  }
}

function walletAggByYear(){
  const map = {}; // {year: {in:0,out:0}}
  (walletTx || []).forEach(t=>{
    const d = String(t?.date || '').trim();
    if(d.length < 4) return;
    const y = parseInt(d.slice(0,4), 10);
    if(isNaN(y)) return;
    if(!map[y]) map[y] = { in:0, out:0 };
    const amt = safeNumber(t.amount);
    if(t.type === 'in') map[y].in += amt;
    if(t.type === 'out') map[y].out += amt;
  });
  const years = Object.keys(map).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
  return { years, map };
}

function walletDrawYearBars(canvas){
  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { cIn, cOut, grid, text, sub } = walletStyleVars();
  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  const { years, map } = walletAggByYear();
  if(!years.length){
    ctx.fillStyle = sub;
    ctx.font = "800 13px DM Sans, sans-serif";
    ctx.fillText("Sin datos a√∫n.", 14, 40);
    return;
  }

  const top=34, left=40, right=14, bottom=26;
  const pw = w-left-right, ph=h-top-bottom;

  const s1 = years.map(y=>map[y].in||0);
  const s2 = years.map(y=>map[y].out||0);
  const maxVal = Math.max(1, ...s1, ...s2) * 1.15;

  // grid
  ctx.strokeStyle = grid;
  for(let i=0;i<=4;i++){
    const y = top + ph*(i/4);
    ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(left+pw,y); ctx.stroke();
  }

  const n = years.length;
  const groupW = pw / n;
  const barW = Math.min(22, groupW*0.25);
  const gap = Math.min(10, groupW*0.12);
  const offset = (groupW - (barW*2 + gap))/2;

  for(let i=0;i<n;i++){
    const x0 = left + i*groupW + offset;
    const bh1 = (s1[i]/maxVal)*ph;
    const bh2 = (s2[i]/maxVal)*ph;

    ctx.fillStyle = cIn; ctx.globalAlpha=0.85;
    ctx.fillRect(x0, top+ph-bh1, barW, bh1);

    ctx.fillStyle = cOut; ctx.globalAlpha=0.80;
    ctx.fillRect(x0+barW+gap, top+ph-bh2, barW, bh2);
    ctx.globalAlpha=1;

    const lbl = String(years[i]);
    ctx.fillStyle = sub;
    ctx.font = "700 11px DM Sans, sans-serif";
    const tw = ctx.measureText(lbl).width;
    ctx.fillText(lbl, left + i*groupW + (groupW-tw)/2, top+ph+18);
  }

  // legend
  ctx.fillStyle = cIn; ctx.globalAlpha=0.85; ctx.fillRect(left, h-12, 10, 10); ctx.globalAlpha=1;
  ctx.fillStyle = text; ctx.font="700 12px DM Sans, sans-serif"; ctx.fillText("Ingresos", left+14, h-3);
  ctx.fillStyle = cOut; ctx.globalAlpha=0.80; ctx.fillRect(left+90, h-12, 10, 10); ctx.globalAlpha=1;
  ctx.fillStyle = text; ctx.fillText("Egresos", left+104, h-3);
}

function walletVehicleColorToHex(raw){
  const s = String(raw||'').trim().toLowerCase();
  if(!s) return null;
  // Si ya es un color CSS v√°lido (hex o rgb/rgba/hsl), lo dejamos pasar
  if(s.startsWith('#') || s.startsWith('rgb') || s.startsWith('hsl')) return raw;

  // Mapeo r√°pido de nombres comunes (ES)
  const map = {
    'blanco':'#e5e7eb',
    'negro':'#111827',
    'gris':'#9ca3af',
    'plata':'#cbd5e1',
    'rojo':'#ef4444',
    'vino':'#7f1d1d',
    'azul':'#3b82f6',
    'azul marino':'#1e3a8a',
    'marino':'#1e3a8a',
    'verde':'#22c55e',
    'verde oscuro':'#166534',
    'amarillo':'#facc15',
    'naranja':'#f97316',
    'morado':'#8b5cf6',
    'violeta':'#8b5cf6',
    'rosa':'#ec4899',
    'cafe':'#78350f',
    'caf√©':'#78350f'
  };
  if(map[s]) return map[s];

  // Si viene algo tipo "Morado" o "Gris", intentamos por inclusi√≥n
  for(const k in map){
    if(s.includes(k)) return map[k];
  }
  return null;
}


function walletDrawVehicleValuesBars(canvas, vehiclesList, title){
  // NOTA: Este chart se dibuja en canvas (sin Chart.js) para mantener el estilo del dashboard.
  // Requisito UX: NO repetir el t√≠tulo dentro de la gr√°fica (ya existe en el encabezado del card).
  // Adem√°s: quitar valores por barra y mostrar escala/valores en la parte superior.

  walletResizeCanvasToDisplay(canvas);
  const ctx = canvas.getContext('2d');
  const { grid, text, sub } = walletStyleVars();

  const w = canvas.getBoundingClientRect().width;
  const h = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,w,h);

  // layout (horizontal bars)
  const top = 36, left = 140, right = 18, bottom = 16;
  const pw = w - left - right;
  const ph = h - top - bottom;

  // Datos: solo con valor > 0 (si ninguno, mostramos "Sin datos")
  const data = (vehiclesList || [])
    .map(v=>({
      name: String(v.name||'Veh√≠culo').trim() || 'Veh√≠culo',
      color: String(v.color||'').trim(),
      value: Number(v.value||0)
    }))
    .filter(v=>v.value > 0);

  // grid tenue (vertical)
  ctx.strokeStyle = grid;
  // grid tenue (0%, 50%, 100%)
  for(let i=0;i<=2;i++){
    const x = left + pw*(i/2);
    ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, top+ph); ctx.stroke();
  }

  if(!data.length){
    ctx.fillStyle = sub;
    ctx.font = "800 13px DM Sans, sans-serif";
    ctx.fillText("Sin valores de veh√≠culos a√∫n.", 14, top + 24);
    return;
  }

  // ordenar desc y limitar para legibilidad
  data.sort((a,b)=>b.value-a.value);
  const maxItems = 10;
  const view = data.slice(0, maxItems);

  // escala (max)
  const maxVal = Math.max(...view.map(v=>v.value), 1);

  // valores/escala en la parte superior (0, 50% y 100%)
  ctx.fillStyle = sub;
  ctx.font = "800 11px DM Sans, sans-serif";
  ctx.textBaseline = "alphabetic";
  for(let i=0;i<=2;i++){
    const val = maxVal*(i/2);
    const lbl = money(val);
    const x = left + pw*(i/2);
    const tw = ctx.measureText(lbl).width;
    // centrado sobre la l√≠nea de grid
    const tx = Math.max(left, Math.min(w-right-tw, x - tw/2));
    // un poquito arriba del √°rea de barras
    ctx.fillText(lbl, tx, top - 10);
  }

  // barras
  const n = view.length;
  const rowH = ph / n;
  const barH = Math.max(12, Math.min(22, rowH * 0.62));

  const xAt = v => left + ((v/maxVal) * pw);

  for(let i=0;i<n;i++){
    const v = view[i];

    // y center de la fila
    const cy = top + rowH*i + rowH/2;
    const y = cy - barH/2;

    // nombre (izquierda)
    ctx.fillStyle = sub;
    ctx.font = "800 12px DM Sans, sans-serif";
    const nameMax = 18;
    const name = v.name.length > nameMax ? v.name.slice(0,nameMax) + '‚Ä¶' : v.name;
    ctx.fillText(name, 14, cy + 4);

    // barra
    const x2 = xAt(v.value);
    const c = walletVehicleColorToHex(v.color) || '#00e676';
    ctx.fillStyle = c;
    ctx.globalAlpha = 0.90;
    ctx.fillRect(left, y, Math.max(2, x2-left), barH);
    ctx.globalAlpha = 1;
  }

  // nota si hay m√°s de maxItems
  if(data.length > maxItems){
    ctx.fillStyle = sub;
    ctx.font = "800 11px DM Sans, sans-serif";
    ctx.fillText(`.`, 14, h - 8);
  }
}


function renderWalletCharts(){
  const cBars = document.getElementById('walletChartMonthBars');
  const cDon  = document.getElementById('walletChartMonthDonut');
  const cTr   = document.getElementById('walletChartTrend30');
  const cInC  = document.getElementById('walletChartInCatsDonut');
  const cOutC = document.getElementById('walletChartOutCatsDonut');
  const cYear = document.getElementById('walletChartYearBars');
  const cVeh  = document.getElementById('walletChartVehicleValues');
  const cVehTot = document.getElementById('walletVehiclesTotalValue');
  if(!cBars || !cDon || !cTr) return;

  const rng = walletGetRangeISO();
  const mFrom = rng.from;
  const mTo = rng.to;
  const period = (mFrom === mTo) ? mFrom : `${mFrom} a ${mTo}`;
  const { inSum, outSum } = walletAggRangeInOut(mFrom, mTo);

  walletDrawMonthBars(cBars, inSum, outSum, `Ingresos vs Egresos (${period})`);

  const slices = walletTopExpenseConceptsRange(mFrom, mTo);
  walletDrawDonut(cDon, inSum, outSum, `Ingresos vs Egresos (${period})`);

  const tm = walletAggMonthDaily(mFrom, mTo);
walletDrawTrend(cTr, tm.labels, tm.inArr, tm.outArr, `Tendencia (${period})`);

// Circular por categor√≠a (con base en el mes/rango seleccionado)
if(cInC || cOutC){
  const txIn = {};
  const txOut = {};
  const list = (walletTx || []).filter(t=>{
      const d = String(t.date||'');
      return d >= mFrom+'-01' && d <= mTo+'-31';
    });
  list.forEach(t=>{
    const cat = String(t.category || 'Sin categor√≠a').trim() || 'Sin categor√≠a';
    const amt = Number(t.amount || 0);
    if(t.type === 'in')  txIn[cat]  = (txIn[cat]  || 0) + amt;
    if(t.type === 'out') txOut[cat] = (txOut[cat] || 0) + amt;
  });

  // ordenar desc
  const inPairs = Object.entries(txIn).sort((a,b)=>b[1]-a[1]);
  const outPairs = Object.entries(txOut).sort((a,b)=>b[1]-a[1]);

  const inLabels = inPairs.map(p=>p[0]);
  const inVals   = inPairs.map(p=>p[1]);
  const outLabels= outPairs.map(p=>p[0]);
  const outVals  = outPairs.map(p=>p[1]);

  if(cInC)  walletDrawCategoryDonut(cInC,  inLabels,  inVals,  `Ingresos por Categor√≠a (${period})`, 'in');
  if(cOutC) walletDrawCategoryDonut(cOutC, outLabels, outVals, `Egresos por Categor√≠a (${period})`, 'out');
}
  if(cYear) walletDrawYearBars(cYear);
  if(cVeh){
    // ordenar por valor desc (solo los que tengan valor > 0)
    const listVeh = (vehicles || []).map(v=>({ 
      name: String(v.name||'Veh√≠culo').trim() || 'Veh√≠culo',
      color: String(v.color||'').trim(),
      value: Number(v.value||0)
    }));
    walletDrawVehicleValuesBars(cVeh, listVeh, 'Valor de Veh√≠culos');
    if(cVehTot){
      const totalV = listVeh.reduce((a,b)=>a + (Number(b.value)||0), 0);
      cVehTot.innerHTML = '<span class="sub">Total:</span> ' + money(totalV);
    }
  }

  // Re-render on resize (debounced)
  let t = null;
  window.removeEventListener('resize', window.__walletChartsResizeHandler || (()=>{}));
  window.__walletChartsResizeHandler = ()=>{
    clearTimeout(t);
    t = setTimeout(renderWalletCharts, 140);
  };
  window.addEventListener('resize', window.__walletChartsResizeHandler);
}





    function deleteWalletTx(id){
      walletTx = (walletTx || []).filter(t => String(t.id) !== String(id));
      saveWallet();
      renderWallet();
      renderDashboard(); // para refrescar KPIs en dashboard si est√°s ah√≠
      showAlert('success','Movimiento eliminado.');
    }

    function renderWalletDashboardCard(){
      const w = calcWallet();
      const kBal = document.getElementById('walletKpiBalance');
      const kIn  = document.getElementById('walletKpiIn');
      const kOut = document.getElementById('walletKpiOut');
      if(kBal) kBal.textContent = money(w.balance);
      if(kIn)  kIn.textContent  = money(w.inSum);
      if(kOut) kOut.textContent = money(w.outSum);

      const lastWrap = document.getElementById('walletLastTx');
      if(!lastWrap) return;

      const last = (walletTx || []).slice().sort((a,b)=>{
        const da = parseISODateLocal(a.date)?.getTime() || 0;
        const db = parseISODateLocal(b.date)?.getTime() || 0;
        return db - da;
      }).slice(0,3);

      if(last.length === 0){
        lastWrap.innerHTML = '<div class="empty-state" style="padding:1.25rem 1rem;">Sin movimientos a√∫n.</div>';
        return;
      }

      lastWrap.innerHTML = last.map(t=>{
        const isIn = t.type === 'in';
        const badge = isIn ? '<span class="badge badge-success">Ingreso</span>' : '<span class="badge badge-danger">Egreso</span>';
        const sign = isIn ? '+' : '-';
        return `
          <div class="maintenance-item" style="cursor:pointer;" onclick="showSection('wallet')">
            <div class="item-info">
              <h4>${badge} <span style="margin-left:.5rem; font-family:'Space Mono',monospace;">${escapeHtml(formatDateMX(t.date))}</span></h4>
              <p style="margin-top:.25rem; font-weight:900;">${sign} ${escapeHtml(money(safeNumber(t.amount)))}</p>
            </div>
            <div class="chev">‚Ä∫</div>
          </div>
        `;
      }).join('');
    }

    function openQuickWalletTx(){
      // te manda a la secci√≥n billetera y te enfoca monto
      showSection('wallet');
      setTimeout(()=>{
        const amt = document.getElementById('walletAmount');
        if(amt) amt.focus();
      }, 60);
    }
    cleanOrphanMaintenances();
let workTab = 'home';
    let selectedMonthISO = '';
    let selectedWeekStartISO = '';

    // =========================
    // Helpers
    // =========================
    const MS_DAY = 24 * 60 * 60 * 1000;

    function normalizeISODateString(s){
      if(!s || typeof s !== 'string') return '';
      const str = s.trim();
      if(/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(str);
      if(m){
        const dd = String(m[1]).padStart(2,'0');
        const mm = String(m[2]).padStart(2,'0');
        const yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }
      return str;
    }

    // Parsea "YYYY-MM-DD" como fecha LOCAL (sin corrimiento UTC)
    function parseISODateLocal(iso){
      if(!iso || typeof iso !== 'string') return null;
      iso = normalizeISODateString(iso);
      const parts = iso.split('-').map(Number);
      if(parts.length !== 3) return null;
      const [y, m, d] = parts;
      if(!y || !m || !d) return null;
      return new Date(y, m - 1, d); // LOCAL
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

function setVerificationFormMode(isEdit){
      const h2 = document.querySelector('#verificationForm h2');
      const btn = document.querySelector('#addVerificationForm button[type="submit"]');
      if(h2) h2.textContent = isEdit ? '‚úèÔ∏è Editar Registro' : '‚ûï Agregar Registro';
      if(btn) btn.textContent = isEdit ? 'Guardar cambios' : 'Agregar Registro';
    }


    function setMaintenanceFormMode(isEdit){
      const h2 = document.querySelector('#maintenanceForm .card h2');
      const btn = document.querySelector('#addMaintenanceForm button[type="submit"]');
      if(h2) h2.textContent = isEdit ? '‚úèÔ∏è Editar Mantenimiento' : '‚ûï Agregar Mantenimiento';
      if(btn) btn.textContent = isEdit ? 'Guardar cambios' : 'Agregar Mantenimiento';
    }

    function scrollToAddVehicle() {
      const el = document.getElementById('addVehicleCard');
      if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function toggleCustomColor(selectId, otherId) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel || !other) return;
      const isOther = sel.value === "__otro__";
      other.style.display = isOther ? "block" : "none";
      if (!isOther) other.value = "";
    }

    function getColorValue(selectId, otherId) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel) return "";
      if (sel.value === "__otro__") return (other?.value || "").trim() || "Otro";
      return sel.value.trim();
    }
    // ===== Paleta de colores (Veh√≠culos): reemplaza visualmente el select =====
    const VEHICLE_COLOR_PALETTE = [
      { name: "Blanco", hex: "#FFFFFF" },
      { name: "Blanco Perlado", hex: "#F6F7F9" },
      { name: "Plata", hex: "#C0C0C0" },
      { name: "Plata Met√°lico", hex: "#A9ADB3" },
      { name: "Gris Claro", hex: "#C7CBD1" },
      { name: "Gris Obscuro", hex: "#59606A" },
      { name: "Gris Oxford", hex: "#3A3F46" },
      { name: "Negro", hex: "#0B0F14" },
      { name: "Negro Mate", hex: "#262A2F" },
      { name: "Rojo", hex: "#D32F2F" },
      { name: "Rojo Vino", hex: "#7B1E2B" },
      { name: "Azul", hex: "#1976D2" },
      { name: "Azul Marino", hex: "#0D47A1" },
      { name: "Verde", hex: "#2E7D32" },
      { name: "Verde Olivo", hex: "#556B2F" },
      { name: "Amarillo", hex: "#F9A825" },
      { name: "Naranja", hex: "#EF6C00" },
      { name: "Caf√©", hex: "#6D4C41" },
      { name: "Dorado", hex: "#C9A227" },
      { name: "Morado", hex: "#6A1B9A" }
    ];

    function buildVehicleColorPalette(selectId, otherId){
      const container = document.querySelector(`.color-palette[data-select="${selectId}"]`);
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if(!container || !sel) return;

      // Construir swatches una sola vez
      if(container.dataset.ready === "1") return;
      container.dataset.ready = "1";

      container.innerHTML = "";
      VEHICLE_COLOR_PALETTE.forEach(c => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "color-swatch";
        b.style.background = c.hex;
        b.setAttribute("data-name", c.name);
        b.setAttribute("title", c.name);

        // Blancos: borde m√°s visible
        if(c.hex.toUpperCase() === "#FFFFFF" || c.name.includes("Perlado")){
          b.style.borderColor = "rgba(0,0,0,0.18)";
        }

        b.addEventListener("click", () => {
          sel.value = c.name;
          toggleCustomColor(selectId, otherId);
          syncVehicleColorPalette(selectId, otherId);
        });

        container.appendChild(b);
      });

      // Swatch "Otro‚Ä¶"
      const otherBtn = document.createElement("button");
      otherBtn.type = "button";
      otherBtn.className = "color-swatch";
      otherBtn.setAttribute("data-name", "Otro‚Ä¶");
      otherBtn.setAttribute("title", "Otro‚Ä¶");
      otherBtn.style.background = "linear-gradient(135deg, rgba(255,255,255,0.85), rgba(0,230,118,0.55), rgba(0,0,0,0.6))";
      otherBtn.addEventListener("click", () => {
        sel.value = "__otro__";
        toggleCustomColor(selectId, otherId);
        if(other) other.focus();
        syncVehicleColorPalette(selectId, otherId);
      });
      container.appendChild(otherBtn);

      // Si cambian por c√≥digo (ej. al abrir modal), sincroniza
      sel.addEventListener("change", () => syncVehicleColorPalette(selectId, otherId));
      if(other){
        other.addEventListener("input", () => syncVehicleColorPalette(selectId, otherId));
      }

      // sync inicial
      syncVehicleColorPalette(selectId, otherId);
    }

    function syncVehicleColorPalette(selectId, otherId){
      const container = document.querySelector(`.color-palette[data-select="${selectId}"]`);
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if(!container || !sel) return;

      const val = (sel.value || "").trim();
      const swatches = Array.from(container.querySelectorAll(".color-swatch"));
      swatches.forEach(s => s.classList.remove("is-selected"));

      if(val === "__otro__"){
        // √∫ltimo swatch es "Otro‚Ä¶"
        const last = swatches[swatches.length - 1];
        if(last) last.classList.add("is-selected");
        return;
      }

      const found = swatches.find(s => (s.getAttribute("data-name") || "") === val);
      if(found) found.classList.add("is-selected");
    }

    function initVehicleColorPalettes(){
      buildVehicleColorPalette("carColor", "carColorOther");
      buildVehicleColorPalette("editCarColor", "editCarColorOther");
    }


    function setColorSelect(selectId, otherId, value) {
      const sel = document.getElementById(selectId);
      const other = document.getElementById(otherId);
      if (!sel) return;

      const options = Array.from(sel.options).map(o => o.value || o.text);
      const found = options.includes(value);

      if (found) {
        sel.value = value;
        if (other) { other.style.display = "none"; other.value = ""; }
      } else {
        sel.value = "__otro__";
        if (other) { other.style.display = "block"; other.value = value || ""; }
      }
    }

    function colorToHex(colorName) {
      const map = {
        // Blancos
        "Blanco":"#FFFFFF",
        "Blanco Perlado":"#F6F7F9",

        // Negros
        "Negro":"#0B0F14",
        "Negro Mate":"#262A2F",

        // Grises / Plata
        "Gris":"#9CA3AF",              // compat
        "Gris Claro":"#C7CBD1",
        "Gris Obscuro":"#59606A",
        "Gris Oxford":"#3A3F46",
        "Plata":"#C0C0C0",
        "Plata Met√°lico":"#A9ADB3",

        // Colores
        "Rojo":"#D32F2F",
        "Rojo Vino":"#7B1E2B",
        "Vino":"#7B1E2B",              // compat
        "Azul":"#1976D2",
        "Azul Marino":"#0D47A1",
        "Verde":"#2E7D32",
        "Verde Olivo":"#556B2F",
        "Amarillo":"#F9A825",
        "Naranja":"#EF6C00",
        "Caf√©":"#6D4C41",
        "Morado":"#6A1B9A",
        "Dorado":"#C9A227"
      };
      return map[colorName] || "#9CA3AF";
    }

    function getCarSvgDataUri(hex="#e11d48") {
      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="360" height="200" viewBox="0 0 360 200">
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="${hex}" stop-opacity="0.95"/>
            <stop offset="1" stop-color="${hex}" stop-opacity="0.55"/>
          </linearGradient>
          <linearGradient id="glass" x1="0" x2="1">
            <stop offset="0" stop-color="#bfefff" stop-opacity="0.55"/>
            <stop offset="1" stop-color="#00E676" stop-opacity="0.12"/>
          </linearGradient>
        </defs>

        <g>
          <path d="M55 120c10-35 35-60 85-60h85c40 0 65 16 82 45l22 6c14 4 21 14 21 28v18H40v-18c0-10 6-18 15-20l0 0z"
                fill="url(#g)"/>
          <path d="M130 66h70c28 0 48 10 64 30l-80 0-54-30z" fill="url(#glass)"/>
          <circle cx="120" cy="154" r="20" fill="#0b1220"/>
          <circle cx="120" cy="154" r="10" fill="#111827"/>
          <circle cx="260" cy="154" r="20" fill="#0b1220"/>
          <circle cx="260" cy="154" r="10" fill="#111827"/>
          <rect x="66" y="118" width="40" height="10" rx="5" fill="#ffffff" opacity="0.65"/>
          <rect x="286" y="118" width="35" height="10" rx="5" fill="#ffffff" opacity="0.65"/>
        </g>
      </svg>`;
      return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
    }

    // ‚úÖ FIX: formateo basado en parse local (evita -1 d√≠a)
    function formatDateMX(dateStr) {
      const d = parseISODateLocal(dateStr);
      return d ? d.toLocaleDateString('es-MX') : (dateStr || '');
    }

    function ymd(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function safeNumber(n){
      const x = parseFloat(n);
      return Number.isFinite(x) ? x : 0;
    }

    function money(n){
      const x = safeNumber(n);
      return x.toLocaleString('es-MX', { style:'currency', currency:'MXN' });
    }

    // ‚úÖ Helper: detectar mantenimientos terminados (acepta datos viejos string/1)
    function isMaintenanceCompleted(m){
      if(!m) return false;
      if(m.completed === true) return true;
      if(m.completed === 1) return true;
      if(typeof m.completed === 'string' && m.completed.toLowerCase() === 'true') return true;
      return false;
    }


    // =========================
    // Limpieza al borrar veh√≠culo (evita "fantasmas" en dashboard)
    // =========================
    function purgeVehicleData(vehicleId){
      const vid = String(vehicleId);

      // Verificaciones
      if(verifications && Object.prototype.hasOwnProperty.call(verifications, vid)){
        delete verifications[vid];
      }
      // Mantenimientos
      if(maintenances && Object.prototype.hasOwnProperty.call(maintenances, vid)){
        delete maintenances[vid];
      }
      // Pagos (autos de trabajo)
      if(workPayments && Object.prototype.hasOwnProperty.call(workPayments, vid)){
        delete workPayments[vid];
      }
      // Choferes: desasignar
      if(Array.isArray(drivers) && drivers.length){
        let changed = false;
        drivers = drivers.map(d => {
          if(d && String(d.vehicleId) === vid){
            changed = true;
            return { ...d, vehicleId: "" };
          }
          return d;
        });
        if(changed) localStorage.setItem('drivers', JSON.stringify(drivers));
      }

      // UI state
      if(selectedVehicle && String(selectedVehicle.id) === vid) selectedVehicle = null;
      if(window.__openMaintVehicleId && String(window.__openMaintVehicleId) === vid) window.__openMaintVehicleId = null;
      if(window.__openVeriVehicleId && String(window.__openVeriVehicleId) === vid) window.__openVeriVehicleId = null;

      // Persist
      localStorage.setItem('verifications', JSON.stringify(verifications));
      localStorage.setItem('maintenances', JSON.stringify(maintenances));
      localStorage.setItem('workPayments', JSON.stringify(workPayments));
    }

    // Limpia registros hu√©rfanos (por si qued√≥ basura en storage)
    function cleanupOrphanData(){
      const valid = new Set((vehicles || []).map(v => String(v.id)));
      let changed = false;

      const cleanObj = (objName, objRef) => {
        if(!objRef) return;
        for(const k of Object.keys(objRef)){
          if(!valid.has(String(k))){
            delete objRef[k];
            changed = true;
          }
        }
        if(changed) localStorage.setItem(objName, JSON.stringify(objRef));
      };

      cleanObj('verifications', verifications);
      cleanObj('maintenances', maintenances);
      cleanObj('workPayments', workPayments);
    }


    // =========================
    // Estatus vehicular
    // =========================
    // ‚úÖ FIX: c√°lculo de d√≠as con fechas locales (sin UTC)
    function calcDaysUntil(dateStr){
      if(!dateStr) return null;

      const t0 = new Date();
      const today = new Date(t0.getFullYear(), t0.getMonth(), t0.getDate()); // 00:00 local

      const d = parseISODateLocal(dateStr);
      if(!d) return null;

      const target = new Date(d.getFullYear(), d.getMonth(), d.getDate()); // 00:00 local
      return Math.floor((target - today)/MS_DAY);
    }

    function getVehicleStatusWithDays(vehicleId) {
      const records = (verifications && verifications[vehicleId]) ? verifications[vehicleId] : [];
      // ‚úÖ NUEVO: ignorar registros "terminados" para alertas/estatus
      const withNext = records.filter(r => r && r.nextDate && !r.completed);

      if (withNext.length === 0) return { label:'Sin informaci√≥n', detail:'No hay fechas pendientes', dotClass:'gray' };

      let minDaysUntil = Infinity;
      let minDate = null;

      for (const r of withNext) {
        const daysUntil = calcDaysUntil(r.nextDate);
        if (daysUntil === null) continue;
        if (daysUntil < minDaysUntil) {
          minDaysUntil = daysUntil;
          minDate = r.nextDate;
        }
      }

      if (minDate === null) return { label:'Sin informaci√≥n', detail:'No hay fechas v√°lidas', dotClass:'gray' };

      if (minDaysUntil < 0) return { label:'Vencido', detail:`Hace ${Math.abs(minDaysUntil)} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'danger' };
      if (minDaysUntil <= 30) return { label:'Pr√≥ximo', detail:`En ${minDaysUntil} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'warning' };
      return { label:'Al d√≠a', detail:`Pr√≥xima en ${minDaysUntil} d√≠a(s) ‚Ä¢ ${formatDateMX(minDate)}`, dotClass:'success' };
    }

    function getSoonestRecord(vehicleId){
      const records = (verifications && verifications[vehicleId]) ? verifications[vehicleId] : [];
      // ‚úÖ NUEVO: ignorar terminados
      const withNext = records.filter(r => r && r.nextDate && !r.completed);
      if(withNext.length === 0) return null;

      let best = null;
      let bestDays = Infinity;
      for(const r of withNext){
        const days = calcDaysUntil(r.nextDate);
        if(days === null) continue;
        if(days < bestDays){
          bestDays = days;
          best = { ...r, daysUntil: days };
        }
      }
      return best;
    }

    function getProgressInfo(daysUntil){
      const horizon = 180;
      if(daysUntil === null || daysUntil === undefined) return { pct:0, cls:'good', text:'Sin fecha' };
      if(daysUntil < 0) return { pct:100, cls:'bad', text:'Vencido' };
      if(daysUntil <= 30){
        const pct = Math.min(100, Math.max(0, Math.round((1 - (daysUntil/30))*100)));
        return { pct, cls:'warn', text:'Pr√≥ximo' };
      }
      const pct = Math.min(100, Math.max(0, Math.round((1 - (Math.min(daysUntil,horizon)/horizon))*100)));
      return { pct, cls:'good', text:'Al d√≠a' };
    }

    function typeLabel(type){
      const map = { verificacion:'Verificaci√≥n', tenencia:'Tenencia', multa:'Multa' };
      return map[type] || type;
    }

    function typeIcon(type){
      const map = { verificacion:'‚úÖ', tenencia:'üí∞', multa:'‚ö†Ô∏è' };
      return map[type] || 'üìå';
    }

    function maintenanceTypeLabel(type){
      const map = {
        cambio_aceite:'Cambio de Aceite',
        afinacion:'Afinaci√≥n',
        frenos:'Frenos',
        llantas:'Llantas',
        suspension:'Suspensi√≥n',
        bateria:'Bater√≠a',
        transmision:'Transmisi√≥n',
        aire_acondicionado:'Aire Acondicionado',
        otro:'Otro'
      };
      return map[type] || type;
    }

    // =========================
    // Navegaci√≥n
    // =========================
    function showSection(sectionName, event){
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

      document.getElementById(sectionName).classList.add('active');
      if(event && event.target) event.target.classList.add('active');
      else {
        // auto-activate nav button when called programmatically
        const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => (b.getAttribute('onclick')||'').includes("'"+sectionName+"'"));
        if(btn) btn.classList.add('active');
      }

      if(sectionName === 'dashboard'){
        renderDashboard();
      }else if(sectionName === 'wallet'){
        renderWallet();
      }else if(sectionName === 'vehicles'){
        renderVehicles();
      }else if(sectionName === 'verification'){
        renderVehicleSelector();
        checkVerificationAlerts();
      }else if(sectionName === 'maintenance'){
        renderMaintenanceVehicleSelector();
      }else if(sectionName === 'workcars'){
        renderWorkCarsModule();
      }
    }

    // =========================
    // Dashboard
    // =========================
    function renderDashboard(){
      let alertsCount = 0;
      let overdueCount = 0;
      let upcomingCount = 0;
      const allAlerts = [];
      const vehicleSummaryData = [];

      const typeStats = {
        verificacion:{ total:0, overdue:0, upcoming:0 },
        tenencia:{ total:0, overdue:0, upcoming:0 },
        multa:{ total:0, overdue:0, upcoming:0 }
      };

      vehicles.forEach(vehicle => {
        const vehicleAlerts = { vehicle, verifications:[], overdue:0, upcoming:0 };

        if(verifications[vehicle.id]){
          verifications[vehicle.id].forEach(record => {
            // ‚úÖ NUEVO: ignorar terminados en alertas
            if(record && record.nextDate && !record.completed){
              const daysUntil = calcDaysUntil(record.nextDate);
              if(daysUntil === null) return;

              if(typeStats[record.type]) typeStats[record.type].total++;

              if(daysUntil < 0){
                overdueCount++; alertsCount++;
                vehicleAlerts.overdue++;
                vehicleAlerts.verifications.push({ ...record, daysUntil, status:'overdue' });
                if(typeStats[record.type]) typeStats[record.type].overdue++;

                allAlerts.push({
                  vehicle: vehicle.name,
                  type: record.type,
                  daysUntil,
                  nextDate: record.nextDate,
                  status:'danger'
                });
              }else if(daysUntil <= 30){
                upcomingCount++; alertsCount++;
                vehicleAlerts.upcoming++;
                vehicleAlerts.verifications.push({ ...record, daysUntil, status:'upcoming' });
                if(typeStats[record.type]) typeStats[record.type].upcoming++;

                allAlerts.push({
                  vehicle: vehicle.name,
                  type: record.type,
                  daysUntil,
                  nextDate: record.nextDate,
                  status:'warning'
                });
              }
            }
          });
        }

        if(vehicleAlerts.verifications.length > 0) vehicleSummaryData.push(vehicleAlerts);
      });

      document.getElementById('totalVehicles').textContent = vehicles.length;
      document.getElementById('alertsCount').textContent = alertsCount;
      document.getElementById('overdueCount').textCo
      // ‚úÖ Dashboard: billetera
      if(typeof renderWalletDashboardCard === 'function') renderWalletDashboardCard();
ntent = overdueCount;
      document.getElementById('upcomingCount').textContent = upcomingCount;

      const alertsContainer = document.getElementById('dashboardAlerts');
      if(allAlerts.length === 0){
        alertsContainer.innerHTML = '<div class="card"><div class="empty-state"><p>‚úÖ No hay alertas pendientes. Todos tus veh√≠culos est√°n al d√≠a.</p></div></div>';
      }else{
        allAlerts.sort((a,b)=>a.daysUntil-b.daysUntil);
        alertsContainer.innerHTML = allAlerts.map(alert => {
          const message = alert.daysUntil < 0 ? `VENCIDA hace ${Math.abs(alert.daysUntil)} d√≠as` : `Vence en ${alert.daysUntil} d√≠as`;
          return `
            <div class="alert alert-${alert.status}">
              <div>
                <strong>${escapeHtml(alert.vehicle)}</strong> - ${escapeHtml(typeLabel(alert.type))}
                <br>
                <span style="font-size:0.9rem;">${message} (${formatDateMX(alert.nextDate)})</span>
              </div>
            </div>
          `;
        }).join('');
      }

      const typeSummary = document.getElementById('typeSummary');
      const types = [
        { key:'verificacion', name:'Verificaci√≥n', icon:'‚úÖ' },
        { key:'tenencia', name:'Tenencia', icon:'üí∞' },
        { key:'multa', name:'Multas', icon:'‚ö†Ô∏è' }
      ];
      typeSummary.innerHTML = types.map(t => {
        const s = typeStats[t.key] || { total:0, overdue:0, upcoming:0 };
        return `
          <div class="type-card">
            <div class="type-icon">${t.icon}</div>
            <div>
              <div class="type-title">${t.name}</div>
              <div class="type-metrics">
                <span class="pill good">Total: ${s.total}</span>
                <span class="pill warn">Pr√≥x: ${s.upcoming}</span>
                <span class="pill bad">Venc: ${s.overdue}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      const progressContainer = document.getElementById('vehicleProgress');
      if(!vehicles || vehicles.length === 0){
        progressContainer.innerHTML = '<div class="empty-state"><p>No hay veh√≠culos registrados.</p></div>';
      }else{
        const items = vehicles.map(v => {
          const soon = getSoonestRecord(v.id);
          const title = (v.name && v.name.trim()) ? v.name.trim() : ((v.plates && v.plates.trim()) ? v.plates.trim() : 'Veh√≠culo');
          if(!soon){
            return { v, title, daysUntil:null, date:null, type:null, info:{ pct:0, cls:'good', text:'Sin fechas' } };
          }
          const info = getProgressInfo(soon.daysUntil);
          return { v, title, daysUntil:soon.daysUntil, date:soon.nextDate, type:soon.type, info };
        }).sort((a,b)=>{
          const ad = (a.daysUntil === null) ? 999999 : a.daysUntil;
          const bd = (b.daysUntil === null) ? 999999 : b.daysUntil;
          return ad - bd;
        });

        progressContainer.innerHTML = items.map(item => {
          const dText = item.daysUntil === null ? '‚Äî' : (item.daysUntil < 0 ? `-${Math.abs(item.daysUntil)}d` : `${item.daysUntil}d`);
          const rightLabel = item.daysUntil === null ? 'Sin fecha' : `${typeIcon(item.type)} ${typeLabel(item.type)}`;
          const dateText = item.date ? formatDateMX(item.date) : '‚Äî';
          const fillClass = item.info.cls === 'bad' ? 'bad' : (item.info.cls === 'warn' ? 'warn' : 'good');

          return `
            <div class="vehicle-progress-item">
              <div class="vp-left">
                <div class="vp-title">${escapeHtml(item.title)}</div>
                <div class="vp-sub">${escapeHtml(item.v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(item.v.color || '‚Äî')}${item.v.plates ? ` ‚Ä¢ ${escapeHtml(item.v.plates)}` : ''}</div>
              </div>

              <div class="vp-bar-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                  <div style="font-weight:900; color:rgba(255,255,255,0.85);">${rightLabel}</div>
                  <span class="pill ${fillClass === 'bad' ? 'bad' : (fillClass === 'warn' ? 'warn' : 'good')}">${item.info.text}</span>
                </div>
                <div class="vp-bar">
                  <div class="vp-fill ${fillClass}" style="width:${item.info.pct}%;"></div>
                </div>
              </div>

              <div class="vp-right">
                <div class="vp-days">${dText}</div>
                <div class="vp-date">${dateText}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      const summaryContainer = document.getElementById('vehicleSummary');
      if(vehicleSummaryData.length === 0){
        summaryContainer.innerHTML = '<div class="empty-state"><p>No hay alertas por veh√≠culo</p></div>';
      }else{
        summaryContainer.innerHTML = vehicleSummaryData.map(data => {
          const verificationsList = data.verifications.map(v => {
            const daysText = v.daysUntil < 0 ? `Vencida hace ${Math.abs(v.daysUntil)} d√≠as` : `${v.daysUntil} d√≠as restantes`;
            const badgeClass = v.status === 'overdue' ? 'badge-danger' : 'badge-warning';
            return `
              <div style="margin-top:0.5rem; padding-left:1rem; border-left:2px solid var(--border);">
                <span class="badge ${badgeClass}">${escapeHtml(typeLabel(v.type))}</span>
                <span style="margin-left:0.5rem; color:var(--text-secondary); font-size:0.875rem;">${daysText}</span>
              </div>
            `;
          }).join('');

          return `
            <div class="maintenance-item">
              <div class="item-info">
                <h4>üöó ${escapeHtml(data.vehicle.name)}</h4>
                <p style="color: var(--text-secondary); margin-bottom:0.5rem;">
                  ${escapeHtml(data.vehicle.year)} ‚Ä¢ ${escapeHtml(data.vehicle.color)}
                  ${data.vehicle.plates ? ` ‚Ä¢ ${escapeHtml(data.vehicle.plates)}` : ''}
                </p>
                ${verificationsList}
              </div>
              <div style="text-align:right;">
                ${data.overdue > 0 ? `<div class="badge badge-danger" style="display:block; margin-bottom:0.5rem;">${data.overdue} vencida(s)</div>` : ''}
                ${data.upcoming > 0 ? `<div class="badge badge-warning" style="display:block;">${data.upcoming} pr√≥xima(s)</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      const upcomingContainer = document.getElementById('upcomingVerifications');
      const upcomingVerifications = allAlerts.filter(a => a.daysUntil >= 0).slice(0,10);

      if(upcomingVerifications.length === 0){
        upcomingContainer.innerHTML = '<div class="empty-state"><p>No hay verificaciones pr√≥ximas programadas</p></div>';
      }else{
        upcomingContainer.innerHTML = upcomingVerifications.map(alert => `
          <div class="verification-item">
            <div class="item-info">
              <h4>${escapeHtml(alert.vehicle)}</h4>
              <p>${escapeHtml(typeLabel(alert.type))}</p>
              <p>üìÖ ${formatDateMX(alert.nextDate)}</p>
            </div>
            <div>
              <div class="badge badge-warning">${alert.daysUntil} d√≠as</div>
            </div>
          </div>
        `).join('');
      }

      // ‚úÖ Dashboard: mantenimientos programados
      renderUpcomingMaintenancesDashboard();
    }

    // =========================
    // Dashboard: Mantenimientos programados (futuros)
    // =========================
    function renderUpcomingMaintenancesDashboard(){
      const upcomingMaintContainer = document.getElementById('upcomingMaintenances');
      if(upcomingMaintContainer){
              const upcomingMaint = [];
              const vehicleById = new Map((vehicles || []).map(v => [String(v.id), v]));

              // Recorremos por entries para evitar desincronizaciones por llaves num√©ricas/string
              const entries = Object.entries(maintenances || {});
              for(const [vidKey, list] of entries){
                const v = vehicleById.get(String(vidKey));
                if(!v) continue; // si el veh√≠culo no existe, ignorar (hu√©rfano)
                (list || []).forEach(m => {
                  if(!m) return;
                  if(isMaintenanceCompleted(m)) return; // solo programados
                  const dRaw = m.plannedDate || m.date;
                  if(!dRaw) return;

                  const dISO = normalizeISODateString(dRaw);
                  const daysUntil = calcDaysUntil(dISO);
                  if(daysUntil === null) return;
                  if(daysUntil >= 0){
                    upcomingMaint.push({
                      vehicleName: (v.name && v.name.trim()) ? v.name.trim() : (v.plates || 'Veh√≠culo'),
                      date: dISO,
                      type: m.type || 'mantenimiento',
                      daysUntil
                    });
                  }
                });
              }

              upcomingMaint.sort((a,b) => parseISODateLocal(a.date) - parseISODateLocal(b.date));
              const top = upcomingMaint.slice(0,10);

              if(top.length === 0){
                upcomingMaintContainer.innerHTML = '<div class="empty-state"><p>No hay mantenimientos programados</p></div>';
              }else{
                upcomingMaintContainer.innerHTML = top.map(item => `
                  <div class="verification-item">
                    <div class="item-info">
                      <h4>${escapeHtml(item.vehicleName)}</h4>
                      <p>üîß ${escapeHtml(maintenanceTypeLabel(item.type))}</p>
                      <p>üìÖ ${formatDateMX(item.date)}</p>
                    </div>
                    <div>
                      <div class="badge badge-warning">${item.daysUntil} D√çAS</div>
                    </div>
                  </div>
                `).join('');
              }
            }
    }

    // =========================
    // Foto de veh√≠culo (opcional) - se guarda en vehicles[].image (DataURL)
    // =========================
    let pendingVehicleImageDataUrl = null;

    function setupCarPhotoUploader(){
      const input = document.getElementById('carPhoto');
      if(!input) return;

      input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file){
          clearCarPhoto();
          return;
        }
        if(!file.type || !file.type.startsWith('image/')){
          alert('Selecciona una imagen v√°lida.');
          clearCarPhoto();
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          pendingVehicleImageDataUrl = String(reader.result || '');
          const wrap = document.getElementById('carPhotoPreviewWrap');
          const img = document.getElementById('carPhotoPreview');
          if(img) img.src = pendingVehicleImageDataUrl;
          if(wrap) wrap.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
    }

    function clearCarPhoto(){
      pendingVehicleImageDataUrl = null;
      const input = document.getElementById('carPhoto');
      const wrap = document.getElementById('carPhotoPreviewWrap');
      const img = document.getElementById('carPhotoPreview');
      if(input) input.value = '';
      if(img) img.src = '';
      if(wrap) wrap.style.display = 'none';
    }

    // =========================
    // Foto (editar veh√≠culo) - si no seleccionas nada, conserva la foto actual
    // pendingEditVehicleImageDataUrl:
    //   undefined => sin cambios
    //   null      => quitar foto
    //   "data:..."=> nueva foto
    // =========================
    let pendingEditVehicleImageDataUrl = undefined;

    function setupEditCarPhotoUploader(){
      const input = document.getElementById('editCarPhoto');
      if(!input) return;

      input.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file){
          // si el usuario cancela el selector, no cambiamos nada
          return;
        }
        if(!file.type || !file.type.startsWith('image/')){
          alert('Selecciona una imagen v√°lida.');
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          pendingEditVehicleImageDataUrl = String(reader.result || '');
          const wrap = document.getElementById('editCarPhotoPreviewWrap');
          const img = document.getElementById('editCarPhotoPreview');
          if(img) img.src = pendingEditVehicleImageDataUrl;
          if(wrap) wrap.style.display = 'block';
        };
        reader.readAsDataURL(file);
      });
    }

    function clearEditCarPhoto(){
      // marcar como "quitar foto"
      pendingEditVehicleImageDataUrl = null;
      const input = document.getElementById('editCarPhoto');
      const wrap = document.getElementById('editCarPhotoPreviewWrap');
      const img = document.getElementById('editCarPhotoPreview');
      if(input) input.value = '';
      if(img) img.src = '';
      if(wrap) wrap.style.display = 'none';
    }
// =========================
    // Veh√≠culos
    // =========================
    document.getElementById('vehicleForm').addEventListener('submit', function(e){
      e.preventDefault();

      const vehicle = {
        id: Date.now(),
        name: document.getElementById('carName').value.trim(),
        year: document.getElementById('carYear').value,
        category: document.getElementById('carCategory').value || 'Particular',
        color: getColorValue('carColor','carColorOther'),
        plates: document.getElementById('carPlates').value.trim(),
        value: parseFloat(document.getElementById('carValue').value) || 0,
        image: pendingVehicleImageDataUrl || null
      };

      vehicles.push(vehicle);
      localStorage.setItem('vehicles', JSON.stringify(vehicles));
      this.reset();

        // reset categor√≠a
        walletPopulateCategorySelect();
      clearCarPhoto();
      document.getElementById('carColorOther').style.display = 'none';
      document.getElementById('carCategory').value = 'Particular';

      renderVehicles();
      renderDashboard();
      renderWorkCarsModule();
      showAlert('success', '¬°Veh√≠culo agregado exitosamente!');
    });

    // =========================
    // Billetera: eventos
    // =========================
    const walletForm = document.getElementById('walletForm');

// ===== Categor√≠as =====
const _typeSel = document.getElementById('walletType');
const _catAddBtn = document.getElementById('walletCategoryAddBtn');
const _catDelBtn = document.getElementById('walletCategoryDelBtn');
if(_typeSel){
  _typeSel.addEventListener('change', ()=>{
    const _catSel = document.getElementById('walletCategory');
    if(_catSel) _catSel.value = '';
    walletPopulateCategorySelect();
  });
}
if(_catAddBtn){
  _catAddBtn.onclick = (e)=>{
    if(e) e.preventDefault();
    walletAddNewCategory();
  };
}
if(_catDelBtn){
  _catDelBtn.onclick = (e)=>{
    if(e) e.preventDefault();
    walletRemoveCategory();
  };
}
walletPopulateCategorySelect();
    if(walletForm){
      walletForm.addEventListener('submit', function(e){
        e.preventDefault();

        const type = (document.getElementById('walletType')?.value || '').trim();
        const date = normalizeISODateString(document.getElementById('walletDate')?.value || '');
        const amount = safeNumber(document.getElementById('walletAmount')?.value);
        const note = (document.getElementById('walletNote')?.value || '').trim();
        const category = (document.getElementById('walletCategory')?.value || '').trim();

        if(!type){
          showAlert('warning','Selecciona el tipo (Ingreso/Egreso).');
          return;
        }
        if(!category){
          showAlert('warning','Selecciona una categor√≠a.');
          return;
        }
        if(!date){
          showAlert('warning','Selecciona una fecha.');
          return;
        }
        if(amount <= 0){
          showAlert('warning','Ingresa un monto v√°lido (> 0).');
          return;
        }

        walletTx.push({
          id: Date.now(),
          type,
          category,
          date,
          amount,
          note
        });

        saveWallet();
        this.reset();

        // deja la fecha como hoy para capturas r√°pidas
        const wd = document.getElementById('walletDate');
        if(wd){ wd.value = ymd(new Date()); }

        renderWallet();
        renderDashboard();
        showAlert('success','Movimiento guardado.');
      });
    }

    function renderVehicles(){
      const container = document.getElementById('vehiclesList');

      if(!vehicles || vehicles.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay veh√≠culos registrados. Agrega tu primer veh√≠culo arriba.</p></div>';
        return;
      }

      container.innerHTML = vehicles.map(v => {
        const isSelected = selectedVehicle && selectedVehicle.id === v.id;
        const plateTitle = (v.plates && v.plates.trim()) ? v.plates.trim() : '‚Äî';
        const mainTitle = (v.name && String(v.name).trim()) ? String(v.name).trim() : plateTitle;
        const status = getVehicleStatusWithDays(v.id);
        const hex = colorToHex(v.color || "Rojo");
        const imgSrc = v.image || getCarSvgDataUri(hex);

        const cat = (v.category === 'Trabajo') ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>` : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

        const sub = `${escapeHtml(plateTitle)} <span class="bullet">¬∑</span> ${escapeHtml(v.year || '‚Äî')} <span class="bullet">¬∑</span> ${escapeHtml(v.color || '‚Äî')}`;
        const driverName = getDriverNameForVehicle(v.id);
        const driverLine = (v.category === 'Trabajo' && driverName) ? `<div class="vehicle-subtitle" style="margin-top:.25rem;">üë§ ${escapeHtml(driverName)}</div>` : '';
        const vVal = Number(v.value) || 0;
        const valLine = `<div class="vehicle-value">üí∞ ${vVal > 0 ? money(vVal) : '<span style="opacity:.75; font-weight:800;">Sin valor</span>'}</div>`;


        return `
          <div class="vehicle-row ${isSelected ? 'selected' : ''}" onclick="selectVehicle(${v.id})">
            <div class="vehicle-row-top">
              <div>
                <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                <div class="vehicle-subtitle">${sub}</div>
                ${valLine}
                ${driverLine}
              </div>

              <div class="vehicle-carimg">
                <img src="${imgSrc}" alt="auto">
              </div>
            </div>

            <div class="vehicle-row-bottom">
              <div class="status">
                <span class="dot ${status.dotClass}"></span>
                <div class="status-text">
                  <div>${status.label}</div>
                  <small>${status.detail}</small>
                </div>
              </div>

              <div class="row-actions">
                <button class="btn-mini" onclick="openEditModal(${v.id}, event)">Editar</button>
                <button class="btn-mini danger" onclick="deleteVehicle(${v.id}, event)">Eliminar</button>
                <span class="chev">‚Ä∫</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectVehicle(id){
      selectedVehicle = vehicles.find(v => v.id === id);
      renderVehicles();

      if(document.getElementById('verification').classList.contains('active')){
        document.getElementById('verificationForm').style.display = 'block';
        renderVehicleSelector();
        renderVerifications();
        checkVerificationAlerts();
      }

      if(document.getElementById('maintenance').classList.contains('active')){
        document.getElementById('maintenanceForm').style.display = 'block';
        renderMaintenanceVehicleSelector();
        renderMaintenances();
      }
    }

    function deleteVehicle(id, event){
      event.stopPropagation();
      if(confirm('¬øEst√°s seguro de que deseas eliminar este veh√≠culo?\n\nSe borrar√°n tambi√©n verificaciones, mantenimientos y pagos asociados.')){
        // 1) Purga hijos (evita mantenimientos/verificaciones "fantasma")
        purgeVehicleData(id);

        // 2) Borra veh√≠culo
        vehicles = vehicles.filter(v => String(v.id) !== String(id));
        localStorage.setItem('vehicles', JSON.stringify(vehicles));

        // 3) Limpieza extra por si quedara algo hu√©rfano
        cleanupOrphanData();
    // ‚úÖ Sync inicial: refleja pagos/mantenimientos existentes en Billetera
    syncAllWorkCarsToWallet();

        // 4) Refrescos
        renderVehicles();
        renderDashboard();
        renderWorkCarsModule();
        showAlert('success', 'Veh√≠culo eliminado correctamente');
      }
    }

    // =========================
    // Editar Veh√≠culo (modal)
    // =========================
    function openEditModal(id, event){
      event.stopPropagation();
      const v = vehicles.find(x => x.id === id);
      if(!v) return;

      document.getElementById('editCarId').value = v.id;
      document.getElementById('editCarName').value = v.name || '';
      document.getElementById('editCarYear').value = v.year || '';
      document.getElementById('editCarPlates').value = v.plates || '';
      document.getElementById('editCarValue').value = (Number(v.value) || 0) ? (Number(v.value) || 0) : '';
      document.getElementById('editCarCategory').value = v.category || 'Particular';
      setColorSelect('editCarColor','editCarColorOther', v.color || '');

      
      syncVehicleColorPalette('editCarColor','editCarColorOther');
// reset estado de foto en edici√≥n
      pendingEditVehicleImageDataUrl = undefined;
      const eWrap = document.getElementById('editCarPhotoPreviewWrap');
      const eImg = document.getElementById('editCarPhotoPreview');
      const eInput = document.getElementById('editCarPhoto');
      if(eInput) eInput.value = '';

      if(v.image){
        if(eImg) eImg.src = v.image;
        if(eWrap) eWrap.style.display = 'block';
      }else{
        if(eImg) eImg.src = '';
        if(eWrap) eWrap.style.display = 'none';
      }

      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal(){
      document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editModal').addEventListener('click', (e) => {
      if(e.target && e.target.id === 'editModal') closeEditModal();
    });

    document.getElementById('editVehicleForm').addEventListener('submit', function(e){
      e.preventDefault();
      const id = Number(document.getElementById('editCarId').value);
      const idx = vehicles.findIndex(v => v.id === id);
      if(idx === -1) return;

      vehicles[idx] = {
        ...vehicles[idx],
        name: document.getElementById('editCarName').value.trim(),
        year: document.getElementById('editCarYear').value,
        category: document.getElementById('editCarCategory').value || 'Particular',
        color: getColorValue('editCarColor','editCarColorOther'),
        plates: document.getElementById('editCarPlates').value.trim(),
        value: parseFloat(document.getElementById('editCarValue').value) || 0,
        // foto: solo cambia si el usuario seleccion√≥ / quit√≥ una
        image: (pendingEditVehicleImageDataUrl !== undefined) ? pendingEditVehicleImageDataUrl : vehicles[idx].image
      };

      localStorage.setItem('vehicles', JSON.stringify(vehicles));
      if(selectedVehicle && selectedVehicle.id === id) selectedVehicle = vehicles[idx];

      pendingEditVehicleImageDataUrl = undefined;
      closeEditModal();
      renderVehicles();
      renderDashboard();
      renderWorkCarsModule();

      showAlert('success', 'Veh√≠culo actualizado correctamente');
    });

    // =========================
    // Verificaciones
    // =========================
    function renderVehicleSelector(){
      const container = document.getElementById('vehicleSelector');
      if(vehicles.length === 0){
        container.innerHTML = '<p class="empty-state">No hay veh√≠culos registrados. Agrega un veh√≠culo primero.</p>';
        document.getElementById('verificationForm').style.display = 'none';
        return;
      }

      const openId = window.__openVeriVehicleId || null;

      container.innerHTML = `
        <div class="vehicle-list">
          ${vehicles.map(vehicle => {
            const isOpen = openId === vehicle.id;

            // ‚úÖ En Verificaciones debe resaltar el NOMBRE (no la placa)
            const mainTitle = (vehicle.name && vehicle.name.trim()) ? vehicle.name.trim() : ((vehicle.plates && vehicle.plates.trim()) ? vehicle.plates.trim() : 'Veh√≠culo');

            const subParts = [];
            if(vehicle.plates && vehicle.plates.trim()) subParts.push(escapeHtml(vehicle.plates.trim()));
            if(vehicle.year) subParts.push(escapeHtml(vehicle.year));
            if(vehicle.color) subParts.push(escapeHtml(vehicle.color));
            const sub = subParts.join(' <span class="bullet">¬∑</span> ');

            const status = getVehicleStatusWithDays(vehicle.id);
            const imgSrc = vehicle.image || getCarSvgDataUri(colorToHex(vehicle.color || "Rojo"));

            const dn = getDriverNameForVehicle(vehicle.id);
            const driverLine = dn ? `<div class="vehicle-subtitle">üë§ ${escapeHtml(dn)}</div>` : '';

            const cat = (vehicle.category === 'Trabajo')
              ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>`
              : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

            return `
              <div class="vehicle-row ${isOpen ? 'selected' : ''}" onclick="toggleVerificationPanel(${vehicle.id})">
                <div class="vehicle-row-top">
                  <div>
                    <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                    ${sub ? `<div class="vehicle-subtitle">${sub}</div>` : ''}
                    ${driverLine}
                  </div>
                  <div class="vehicle-carimg">
                    <img src="${imgSrc}" alt="auto">
                  </div>
                </div>
                <div class="vehicle-row-bottom">
                  <div class="status">
                    <span class="dot ${status.dotClass}"></span>
                    <div class="status-text">
                      <div>${status.label}</div>
                      <small>${status.detail}</small>
                    </div>
                  </div>
                  <div class="row-actions">
                    <span class="chev">${isOpen ? '‚åÑ' : '‚Ä∫'}</span>
                  </div>
                </div>
              </div>

              <div class="veri-panel" id="veriPanel-${vehicle.id}" style="display:${isOpen ? 'block' : 'none'};">
                <div class="panel-actions">
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); openAddVerificationFor(${vehicle.id});">+ Agregar</button>
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); toggleVerificationPanel(${vehicle.id}, true);">Cerrar</button>
                </div>
                <div class="verification-list" id="veriList-${vehicle.id}"></div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // Renderiza el panel abierto (si existe)
      if(openId) renderVerificationsFor(openId);
    }

    function selectVehicleForVerification(id){
      selectedVehicle = vehicles.find(v => v.id === id);
      document.getElementById('verificationForm').style.display = 'block';
      renderVehicleSelector();
      renderVerifications();
    }

    document.getElementById('addVerificationForm').addEventListener('submit', function(e){
      e.preventDefault();
      if(!selectedVehicle) return;

      const data = {
        type: document.getElementById('verificationType').value,
        date: document.getElementById('verificationDate').value,
        nextDate: document.getElementById('verificationNext').value,
        amount: document.getElementById('verificationAmount').value,
        notes: document.getElementById('verificationNotes').value
      };

      // ‚úÖ Modo edici√≥n
      if(editingVerification && editingVerification.recordId && editingVerification.vehicleId === selectedVehicle.id){
        const vid = editingVerification.vehicleId;
        const rid = editingVerification.recordId;
        const list = verifications[vid] || [];
        const idx = list.findIndex(r => r.id === rid);
        if(idx !== -1){
          const prev = list[idx];
          list[idx] = { ...prev, ...data }; // conserva completed/completedDate
          verifications[vid] = list;
          localStorage.setItem('verifications', JSON.stringify(verifications));

          editingVerification = { vehicleId: null, recordId: null };
          setVerificationFormMode(false);
          this.reset();

          renderVerificationsFor(vid);
          checkVerificationAlerts();
          renderDashboard();
          renderVehicles();
          showAlert('success', 'Registro actualizado correctamente');
        }
        return;
      }

      // ‚úÖ Alta normal
      const verification = {
        id: Date.now(),
        ...data,
        completed: false,
        completedDate: ''
      };

      if(!verifications[selectedVehicle.id]) verifications[selectedVehicle.id] = [];
      verifications[selectedVehicle.id].push(verification);
      localStorage.setItem('verifications', JSON.stringify(verifications));

      this.reset();
      renderVerificationsFor(selectedVehicle.id);
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('success', 'Registro agregado correctamente');
    });


    function renderVerificationsFor(vehicleId){
      // Contenedor en cascada (por veh√≠culo). Si no existe, cae a legacy (si alg√∫n d√≠a se usa).
      const container = document.getElementById(`veriList-${vehicleId}`) || document.getElementById('verificationList');
      if(!container) return;

      const list = (verifications[vehicleId] || []);
      if(list.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay registros para este veh√≠culo</p></div>';
        return;
      }

      // ‚úÖ FIX sort: usar parse local
      const records = list.slice().sort((a,b) =>
        (parseISODateLocal(b.nextDate || b.date) - parseISODateLocal(a.nextDate || a.date))
      );

      container.innerHTML = records.map(record => {
        const typeNames = { verificacion:'‚úÖ Verificaci√≥n', tenencia:'üí∞ Tenencia', multa:'‚ö†Ô∏è Multa' };

        let statusBadge = '';
        if(record.completed){
          statusBadge = '<span class="badge badge-success">TERMINADO</span>';
        }else if(record.nextDate){
          const daysUntil = calcDaysUntil(record.nextDate);
          if(daysUntil < 0) statusBadge = '<span class="badge badge-danger">Vencido</span>';
          else if(daysUntil <= 30) statusBadge = '<span class="badge badge-warning">Pr√≥ximo</span>';
          else statusBadge = '<span class="badge badge-success">Al d√≠a</span>';
        }

        return `
          <div class="verification-item">
            <div class="item-info">
              <h4>${typeNames[record.type] || record.type} ${statusBadge}</h4>
              <p>Fecha: ${formatDateMX(record.date)}</p>
              ${record.nextDate ? `<p>Pr√≥xima: ${formatDateMX(record.nextDate)} (${calcDaysUntil(record.nextDate)} d√≠as)</p>` : ''}
              ${record.amount ? `<p>Monto: $${Number(record.amount).toFixed(2)}</p>` : ''}
              ${record.notes ? `<p><em>${escapeHtml(record.notes)}</em></p>` : ''}
            </div>
            <div class="item-actions">
              <button class="btn btn-small btn-secondary" onclick="editVerification(${vehicleId}, ${record.id})">Editar</button>
              <button class="btn btn-small btn-success" onclick="toggleVerificationComplete(${vehicleId}, ${record.id})">${record.completed ? 'Reabrir' : 'Completar'}</button>
              <button class="btn btn-small btn-danger" onclick="deleteVerification(${vehicleId}, ${record.id})">Eliminar</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderVerifications(){
      if(!selectedVehicle) return;
      renderVerificationsFor(selectedVehicle.id);
    }

    function closeAllVerificationPanels(){
      document.querySelectorAll('[id^="veriPanel-"]').forEach(p => { p.style.display = 'none'; });
    }

    function toggleVerificationPanel(vehicleId, forceClose=false){
      const panel = document.getElementById(`veriPanel-${vehicleId}`);
      if(!panel) return;

      const wasOpen = panel.style.display !== 'none';

      // Accordion: cierra todos antes de abrir uno
      closeAllVerificationPanels();

      if(forceClose || wasOpen){
        window.__openVeriVehicleId = null;
        selectedVehicle = null;
        editingVerification = { vehicleId: null, recordId: null };
        setVerificationFormMode(false);
        document.getElementById('verificationForm').style.display = 'none';
        return;
      }

      panel.style.display = 'block';
      window.__openVeriVehicleId = vehicleId;

      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;
      document.getElementById('verificationForm').style.display = 'block';

      renderVerificationsFor(vehicleId);
    }

    function openAddVerificationFor(vehicleId){
      // Asegura panel abierto y veh√≠culo seleccionado
      if(window.__openVeriVehicleId !== vehicleId){
        toggleVerificationPanel(vehicleId);
      }
      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;

      // reset modo edici√≥n
      editingVerification = { vehicleId: null, recordId: null };
      setVerificationFormMode(false);
      const formEl = document.getElementById('addVerificationForm');
      if(formEl) formEl.reset();

      const formWrap = document.getElementById('verificationForm');
      formWrap.style.display = 'block';
      formWrap.scrollIntoView({behavior:'smooth', block:'start'});
    }
      

    function toggleVerificationComplete(vehicleId, recordId){
      const list = verifications[vehicleId] || [];
      const idx = list.findIndex(r => r.id === recordId);
      if(idx === -1) return;

      if(list[idx].completed){
        list[idx].completed = false;
        list[idx].completedDate = '';
        showAlert('info', 'Registro reabierto');
      }else{
        list[idx].completed = true;
        list[idx].completedDate = ymd(new Date());
        showAlert('success', 'Registro marcado como TERMINADO');
      }

      verifications[vehicleId] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerificationsFor(vehicleId);
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
    }

function editVerification(vehicleId, recordId){
      const list = verifications[vehicleId] || [];
      const rec = list.find(r => r.id === recordId);
      if(!rec) return;

      // Abre panel y form
      if(window.__openVeriVehicleId !== vehicleId){
        toggleVerificationPanel(vehicleId);
      }
      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;

      document.getElementById('verificationForm').style.display = 'block';
      setVerificationFormMode(true);
      editingVerification = { vehicleId, recordId };

      // Poblar campos
      document.getElementById('verificationType').value = rec.type || '';
      document.getElementById('verificationDate').value = rec.date || '';
      document.getElementById('verificationNext').value = rec.nextDate || '';
      document.getElementById('verificationAmount').value = rec.amount || '';
      document.getElementById('verificationNotes').value = rec.notes || '';

      const formWrap = document.getElementById('verificationForm');
      formWrap.scrollIntoView({behavior:'smooth', block:'start'});
    }

function deleteVerification(vehicleId, id){
      // Soporta: deleteVerification(id) (legacy con selectedVehicle) y deleteVerification(vehicleId, id)
      const vid = (typeof id === 'undefined') ? (selectedVehicle ? selectedVehicle.id : null) : vehicleId;
      const rid = (typeof id === 'undefined') ? vehicleId : id;
      if(!vid) return;

      if(confirm('¬øEliminar este registro?')){
        verifications[vid] = (verifications[vid] || []).filter(v => v.id !== rid);
        localStorage.setItem('verifications', JSON.stringify(verifications));
        renderVerificationsFor(vid);
        checkVerificationAlerts();
        renderDashboard();
        renderVehicles();
      }
}

    // ‚úÖ NUEVO: terminar / reabrir registro
    function terminateVerification(id){
      if(!selectedVehicle) return;

      const list = verifications[selectedVehicle.id] || [];
      const idx = list.findIndex(r => r.id === id);
      if(idx === -1) return;

      const today = ymd(new Date());
      list[idx].completed = true;
      list[idx].completedDate = today;

      verifications[selectedVehicle.id] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerifications();
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('success', 'Registro marcado como TERMINADO');
    }

    function reopenVerification(id){
      if(!selectedVehicle) return;

      const list = verifications[selectedVehicle.id] || [];
      const idx = list.findIndex(r => r.id === id);
      if(idx === -1) return;

      list[idx].completed = false;
      list[idx].completedDate = '';

      verifications[selectedVehicle.id] = list;
      localStorage.setItem('verifications', JSON.stringify(verifications));

      renderVerifications();
      checkVerificationAlerts();
      renderDashboard();
      renderVehicles();
      showAlert('warning', 'Registro reabierto');
    }

    function checkVerificationAlerts(){
      const container = document.getElementById('verificationAlerts');
      if(!container) return;
      const alerts = [];

      vehicles.forEach(vehicle => {
        if(verifications[vehicle.id]){
          verifications[vehicle.id].forEach(record => {
            // ‚úÖ NUEVO: ignorar terminados en alertas
            if(record && record.nextDate && !record.completed){
              const daysUntil = calcDaysUntil(record.nextDate);
              if(daysUntil === null) return;

              if(daysUntil < 0) alerts.push({ type:'danger', message:`${vehicle.name}: ${typeLabel(record.type)} VENCIDA desde ${Math.abs(daysUntil)} d√≠as` });
              else if(daysUntil <= 30) alerts.push({ type:'warning', message:`${vehicle.name}: ${typeLabel(record.type)} pr√≥xima en ${daysUntil} d√≠as` });
            }
          });
        }
      });

      if(alerts.length > 0){
        container.innerHTML = alerts.map(a => `<div class="alert alert-${a.type}">‚ö†Ô∏è ${escapeHtml(a.message)}</div>`).join('');
      }else{
        container.innerHTML = '';
      }
    }

    // =========================
    // Mantenimientos
    // =========================
    function renderMaintenanceVehicleSelector(){
      const container = document.getElementById('maintenanceVehicleSelector');
      if(!container) return;

      if(vehicles.length === 0){
        container.innerHTML = '<p class="empty-state">No hay veh√≠culos registrados. Agrega un veh√≠culo primero.</p>';
        document.getElementById('maintenanceForm').style.display = 'none';
        return;
      }

      const openId = window.__openMaintVehicleId || null;

      container.innerHTML = `
        <div class="vehicle-list">
          ${vehicles.map(vehicle => {
            const isOpen = openId === vehicle.id;

            // ‚úÖ En Mantenimientos debe resaltar el NOMBRE (no la placa)
            const mainTitle = (vehicle.name && vehicle.name.trim())
              ? vehicle.name.trim()
              : ((vehicle.plates && vehicle.plates.trim()) ? vehicle.plates.trim() : 'Veh√≠culo');

            // Subt√≠tulo: placas ¬∑ a√±o ¬∑ color
            const subParts = [];
            if(vehicle.plates && vehicle.plates.trim()) subParts.push(escapeHtml(vehicle.plates.trim()));
            if(vehicle.year) subParts.push(escapeHtml(vehicle.year));
            if(vehicle.color) subParts.push(escapeHtml(vehicle.color));
            const sub = subParts.join(' <span class="bullet">¬∑</span> ');

            const status = getVehicleStatusWithDays(vehicle.id);
            const imgSrc = vehicle.image || getCarSvgDataUri(colorToHex(vehicle.color || "Rojo"));

            const dn = getDriverNameForVehicle(vehicle.id);
            const driverLine = dn ? `<div class="vehicle-subtitle">üë§ ${escapeHtml(dn)}</div>` : '';

            const cat = (vehicle.category === 'Trabajo')
              ? `<span class="badge badge-success" style="margin-left:.5rem;">TRABAJO</span>`
              : `<span class="badge badge-muted" style="margin-left:.5rem;">PARTICULAR</span>`;

            return `
              <div class="vehicle-row ${isOpen ? 'selected' : ''}" onclick="toggleMaintenancePanel(${vehicle.id})">
                <div class="vehicle-row-top">
                  <div>
                    <div class="vehicle-name-main">${escapeHtml(mainTitle)} ${cat}</div>
                    ${sub ? `<div class="vehicle-subtitle">${sub}</div>` : ''}
                    ${driverLine}
                  </div>
                  <div class="vehicle-carimg">
                    <img src="${imgSrc}" alt="auto">
                  </div>
                </div>

                <div class="vehicle-row-bottom">
                  <div class="status">
                    <span class="dot ${status.dotClass}"></span>
                    <div class="status-text">
                      <div>${status.label}</div>
                      <small>${status.detail}</small>
                    </div>
                  </div>

                  <div class="row-actions">
                    <span class="chev">${isOpen ? '‚åÑ' : '‚Ä∫'}</span>
                  </div>
                </div>
              </div>

              <div class="veri-panel" id="maintPanel-${vehicle.id}" style="display:${isOpen ? 'block' : 'none'};">
                <div class="panel-actions">
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); openAddMaintenanceFor(${vehicle.id});">+ Agregar</button>
                  <button class="mini-btn" type="button" onclick="event.stopPropagation(); toggleMaintenancePanel(${vehicle.id}, true);">Cerrar</button>
                </div>
                <div class="maintenance-list" id="maintList-${vehicle.id}"></div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // Renderiza el panel abierto (si existe)
      if(openId) renderMaintenancesFor(openId);
    }

    // =========================
    // Mantenimientos (panel por veh√≠culo, estilo Verificaciones)
    // =========================
    function toggleMaintenancePanel(vehicleId, forceClose=false){
      const current = window.__openMaintVehicleId || null;

      if(forceClose || current === vehicleId){
        window.__openMaintVehicleId = null;
        selectedVehicle = null;
        editingMaintenance = { vehicleId: null, recordId: null };
        setMaintenanceFormMode(false);
        const f = document.getElementById('addMaintenanceForm');
        if(f) f.reset();
        const mf = document.getElementById('maintenanceForm');
        if(mf) mf.style.display = 'none';
      }else{
        window.__openMaintVehicleId = vehicleId;
        selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;
        const mf = document.getElementById('maintenanceForm');
        if(mf) mf.style.display = selectedVehicle ? 'block' : 'none';
      }

      renderMaintenanceVehicleSelector();
    }

    function openAddMaintenanceFor(vehicleId){
      window.__openMaintVehicleId = vehicleId;
      selectedVehicle = vehicles.find(v => v.id === vehicleId) || null;

      // al agregar nuevo, salimos de edici√≥n
      editingMaintenance = { vehicleId: null, recordId: null };
      setMaintenanceFormMode(false);
      const f = document.getElementById('addMaintenanceForm');
      if(f) f.reset();

      const mf = document.getElementById('maintenanceForm');
      if(mf) mf.style.display = selectedVehicle ? 'block' : 'none';

      renderMaintenanceVehicleSelector();

      const form = document.getElementById('addMaintenanceForm');
      if(form) form.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function renderMaintenancesFor(vehicleId){
      const container = document.getElementById(`maintList-${vehicleId}`) || document.getElementById('maintenanceList');
      if(!container) return;

      const list = (maintenances && maintenances[vehicleId]) ? maintenances[vehicleId] : [];
      if(list.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay mantenimientos registrados para este veh√≠culo</p></div>';
        return;
      }

      // Orden por fecha (local)
      const records = [...list].sort((a,b) => (parseISODateLocal(b.date) - parseISODateLocal(a.date)));

      const typeNames = {
        cambio_aceite:'üõ¢Ô∏è Cambio de Aceite',
        afinacion:'‚öôÔ∏è Afinaci√≥n',
        frenos:'üõë Frenos',
        llantas:'üöó Llantas',
        suspension:'üîß Suspensi√≥n',
        bateria:'üîã Bater√≠a',
        transmision:'‚ö° Transmisi√≥n',
        aire_acondicionado:'‚ùÑÔ∏è Aire Acondicionado',
        otro:'üî® Otro'
      };

      container.innerHTML = records.map(record => {
        const daysUntil = calcDaysUntil(record.date);
        const isPlanned = (!isMaintenanceCompleted(record)) && (daysUntil !== null) && (daysUntil >= 0); // hoy o futuro
        const badge = isPlanned
          ? '<span class="badge badge-warning">Programado</span>'
          : '<span class="badge badge-success">Realizado</span>';

        const extraPlanned = (record.plannedDate && record.plannedDate !== record.date)
          ? `<div class="details">üìå Programado originalmente: <b>${formatDateMX(record.plannedDate)}</b></div>`
          : '';

        const actions = isPlanned
          ? `
            <div class="row-actions" style="gap:.5rem;">
              <button class="btn-mini" type="button" onclick="completeMaintenance(${record.id}, ${vehicleId})">Terminar</button>
              <button class="btn-mini" type="button" onclick="editMaintenance(${record.id}, ${vehicleId})">Editar</button>
              <button class="btn-mini danger" type="button" onclick="deleteMaintenance(${record.id}, ${vehicleId})">Eliminar</button>
            </div>
          `
          : `
            <div class="row-actions" style="gap:.5rem;">
              <button class="btn-mini" type="button" onclick="editMaintenance(${record.id}, ${vehicleId})">Editar</button>
              <button class="btn-mini danger" type="button" onclick="deleteMaintenance(${record.id}, ${vehicleId})">Eliminar</button>
            </div>
          `;

        return `
          <div class="maintenance-item" style="align-items:flex-start;">
            <div class="item-info" style="flex:1; min-width:0;">
              <h4 style="display:flex; align-items:center; gap:.6rem; flex-wrap:wrap;">
                <span>${typeNames[record.type] || escapeHtml(record.type)}</span>
                ${badge}
              </h4>
              <p>${escapeHtml(record.description)}</p>
              <p>
                üìÖ ${formatDateMX(record.date)}
                ${record.cost ? ` ‚Ä¢ üí∞ $${parseFloat(record.cost).toFixed(2)}` : ''}
                ${record.km ? ` ‚Ä¢ üõ£Ô∏è ${escapeHtml(record.km)} km` : ''}
              </p>
              ${extraPlanned}
            </div>
            ${actions}
          </div>
        `;
      }).join('');
    }



    

    function editMaintenance(recordId, vehicleId){
      const vid = vehicleId || (selectedVehicle ? selectedVehicle.id : null);
      if(!vid) return;

      // abrir panel + seleccionar
      window.__openMaintVehicleId = vid;
      selectedVehicle = vehicles.find(v => v.id === vid) || null;
      document.getElementById('maintenanceForm').style.display = selectedVehicle ? 'block' : 'none';

      const list = (maintenances && maintenances[vid]) ? maintenances[vid] : [];
      const rec = list.find(m => m.id === recordId);
      if(!rec) return;

      // llenar formulario
      document.getElementById('maintenanceType').value = rec.type || '';
      document.getElementById('maintenanceDescription').value = rec.description || '';
      document.getElementById('maintenanceDate').value = rec.date || '';
      document.getElementById('maintenanceCost').value = rec.cost || '';
      document.getElementById('maintenanceKm').value = rec.km || '';

      editingMaintenance = { vehicleId: vid, recordId: recordId };
      setMaintenanceFormMode(true);

      renderMaintenanceVehicleSelector();

      const form = document.getElementById('addMaintenanceForm');
      if(form) form.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    function completeMaintenance(recordId, vehicleId){
      const vid = vehicleId || (selectedVehicle ? selectedVehicle.id : null);
      if(!vid) return;

      const list = (maintenances && maintenances[vid]) ? maintenances[vid] : [];
      const idx = list.findIndex(m => m.id === recordId);
      if(idx === -1) return;

      if(!confirm('¬øMarcar este mantenimiento como TERMINADO?')){
        return;
      }

      const rec = list[idx] || {};
      const today = new Date();
      const todayISO = ymd(today);

      // si estaba programado, guardamos fecha original
      const planned = normalizeISODateString(rec.plannedDate || rec.date || '') || null;

      list[idx] = {
        ...rec,
        completed: true,
        plannedDate: planned,
        date: todayISO
      };

      maintenances[vid] = list;
      localStorage.setItem('maintenances', JSON.stringify(maintenances));

      // salir de edici√≥n si aplica
      if(editingMaintenance && editingMaintenance.vehicleId === vid && editingMaintenance.recordId === recordId){
        editingMaintenance = { vehicleId: null, recordId: null };
        const form = document.getElementById('addMaintenanceForm');
        if(form) form.reset();
        setMaintenanceFormMode(false);
      }

      renderMaintenancesFor(vid);
      renderDashboard();
      renderVehicles();
      renderWorkCarsModule();
      recalcWeekTotalsSoft();
      showAlert('success', 'Mantenimiento marcado como terminado');
    }

function selectVehicleForMaintenance(id){
      openAddMaintenanceFor(id);
    }

    document.getElementById('addMaintenanceForm').addEventListener('submit', function(e){
      e.preventDefault();
      if(!selectedVehicle) return;

      const vid = selectedVehicle.id;

      const type = document.getElementById('maintenanceType').value;
      const description = document.getElementById('maintenanceDescription').value;
      const date = document.getElementById('maintenanceDate').value;
      const cost = document.getElementById('maintenanceCost').value;
      const km = document.getElementById('maintenanceKm').value;

      if(!maintenances[vid]) maintenances[vid] = [];

      // si la fecha es hoy o pasado => se considera realizado
      const daysUntil = calcDaysUntil(date);
      const isDoneAuto = (daysUntil === null) ? false : (daysUntil <= 0);

      // MODO EDICI√ìN
      if(editingMaintenance && editingMaintenance.vehicleId === vid && editingMaintenance.recordId){
        const idx = maintenances[vid].findIndex(m => m.id === editingMaintenance.recordId);
        if(idx !== -1){
          const prev = maintenances[vid][idx] || {};
          maintenances[vid][idx] = {
            ...prev,
            type,
            description,
            date,
            cost,
            km,
            // si era programado y lo mueven a pasado/hoy, lo marcamos realizado
            completed: (prev.completed === true) ? true : isDoneAuto
          };
        }

        // salir de edici√≥n
        editingMaintenance = { vehicleId: null, recordId: null };
        setMaintenanceFormMode(false);
        this.reset();
        localStorage.setItem('maintenances', JSON.stringify(maintenances));

        // Sync a billetera (Egreso -> Mantenimientos autos) si aplica
        try{ syncMaintenanceToWallet(vid, maintenances[vid][idx]); }catch(_e){}

        renderMaintenancesFor(vid);
        renderDashboard();
        renderVehicles();
        renderWorkCarsModule();
        recalcWeekTotalsSoft();
        showAlert('success', 'Mantenimiento actualizado correctamente');
        return;
      }

      // NUEVO REGISTRO
      const maintenance = {
        id: Date.now(),
        type,
        description,
        date,
        cost,
        km,
        completed: isDoneAuto,
        plannedDate: (isDoneAuto ? null : date)
      };

      maintenances[vid].push(maintenance);
      localStorage.setItem('maintenances', JSON.stringify(maintenances));

      // Sync a billetera (Egreso -> Mantenimientos autos) si aplica
      try{ syncMaintenanceToWallet(vid, maintenance); }catch(_e){}

      this.reset();
      setMaintenanceFormMode(false);
      renderMaintenancesFor(vid);
      renderDashboard();
      renderVehicles();
      renderWorkCarsModule();
      recalcWeekTotalsSoft();
      showAlert('success', (maintenance.completed ? 'Mantenimiento registrado (realizado)' : 'Mantenimiento registrado (programado)'));
    });


    // =========================
    // Form Choferes (Autos de trabajo)
    // =========================
    (function(){
      const drvForm = document.getElementById('driverForm');
      if(!drvForm) return;

      // poblar select al iniciar
      populateDriverVehicleSelect();
      renderDriversList();

      drvForm.addEventListener('submit', function(e){
        e.preventDefault();

        const idField = document.getElementById('drvId');
        const editingId = (idField && idField.value) ? String(idField.value) : '';

        const data = {
          id: editingId ? Number(editingId) : Date.now(),
          name: (document.getElementById('drvName').value || '').trim(),
          phone: (document.getElementById('drvPhone').value || '').trim(),
          email: (document.getElementById('drvEmail').value || '').trim(),
          address: (document.getElementById('drvAddress').value || '').trim(),
          vehicleId: (document.getElementById('drvVehicle').value || '').trim(),
          startDate: (document.getElementById('drvStart').value || '').trim(),
          endDate: (document.getElementById('drvEnd').value || '').trim(),
          notes: (document.getElementById('drvNotes').value || '').trim(),
          refName: (document.getElementById('refName').value || '').trim(),
          refPhone: (document.getElementById('refPhone').value || '').trim(),
        };

        if(!data.name){
          alert('Ingresa el nombre del chofer.');
          return;
        }

        // Guardar/actualizar chofer
        const idx = (drivers || []).findIndex(d => String(d.id) === String(data.id));
        if(idx === -1){
          drivers.push(data);
        }else{
          // si cambi√≥ de veh√≠culo, limpiar v√≠nculos previos
          const prevVehicleId = (drivers[idx].vehicleId || '').toString();
          drivers[idx] = {...drivers[idx], ...data};
          if(prevVehicleId && prevVehicleId !== data.vehicleId){
            const oldV = (vehicles || []).find(x => String(x.id) === String(prevVehicleId));
            if(oldV && String(oldV.driverId) === String(data.id)) delete oldV.driverId;
          }
        }

        // Sincronizar v√≠nculo bidireccional
        if(data.vehicleId){
          linkDriverToVehicle(data.id, data.vehicleId);
        }else{
          // quitar driverId de cualquier veh√≠culo que lo tenga
          (vehicles || []).forEach(v => {
            if(String(v.driverId || '') === String(data.id)) delete v.driverId;
          });
          const d = getDriverById(data.id);
          if(d) d.vehicleId = '';
        }

        saveDrivers();
        localStorage.setItem('vehicles', JSON.stringify(vehicles || []));

        resetDriverForm();
        renderDriversList();
        renderWorkCarsHome();
        renderWeekDetailCards();
        alert('Chofer guardado.');
      });
    })();

    function renderMaintenances(){
      const container = document.getElementById('maintenanceList');
      if(!container) return;

      // ‚ö†Ô∏è Si no hay veh√≠culo seleccionado, no mostrar residuos viejos
      if(!selectedVehicle){
        container.innerHTML = '<div class="empty-state"><p>Selecciona un veh√≠culo para ver su historial</p></div>';
        return;
      }

      const vehicleId = String(selectedVehicle.id);

      // üîí Solo mantenimientos que realmente pertenecen al veh√≠culo (evita "fantasmas")
      const records = (maintenances[vehicleId] || [])
        .filter(m => String(m.vehicleId || vehicleId) === vehicleId)
        .slice()
        .sort((a,b) => (parseISODateLocal(b.date) - parseISODateLocal(a.date)));

      if(records.length === 0){
        container.innerHTML = '<div class="empty-state"><p>No hay mantenimientos registrados para este veh√≠culo</p></div>';
        return;
      }

      const typeNames = {
        cambio_aceite:'üõ¢Ô∏è Cambio de Aceite', afinacion:'‚öôÔ∏è Afinaci√≥n', frenos:'üõë Frenos', llantas:'üöó Llantas',
        suspension:'üîß Suspensi√≥n', bateria:'üîã Bater√≠a', transmision:'‚ö° Transmisi√≥n', aire_acondicionado:'‚ùÑÔ∏è Aire Acondicionado', otro:'üî® Otro'
      };

      container.innerHTML = records.map(record => `
        <div class="maintenance-item">
          <div class="item-info">
            <h4>${typeNames[record.type] || escapeHtml(record.type || 'Mantenimiento')}</h4>
            <p>${escapeHtml(record.description || '')}</p>
            <p>üìÖ ${formatDateMX(record.date)}
              ${record.cost ? ` ‚Ä¢ üí∞ $${parseFloat(record.cost).toFixed(2)}` : ''}
              ${record.km ? ` ‚Ä¢ üõ£Ô∏è ${escapeHtml(record.km)} km` : ''}</p>
            ${record.plannedDate && String(record.plannedDate) !== String(record.date)
              ? `<p class="planned-note">üìå Programado originalmente: ${formatDateMX(record.plannedDate)}</p>`
              : ''}
          </div>
          <button class="btn btn-danger" onclick="deleteMaintenance(${record.id}, ${vehicleId})" style="padding:.55rem 1rem;">Eliminar</button>
        </div>
      `).join('');
    }

    function deleteMaintenance(id, vehicleId){
      const vid = vehicleId || (selectedVehicle ? selectedVehicle.id : null);
      if(!vid) return;

      if(confirm('¬øEliminar este registro de mantenimiento?')){
        maintenances[vid] = (maintenances[vid] || []).filter(m => m.id !== id);
        localStorage.setItem('maintenances', JSON.stringify(maintenances));

        // refrescos
        renderMaintenancesFor(vid);
        if(selectedVehicle && selectedVehicle.id === vid) renderMaintenances(); // legacy
        renderDashboard();
        renderVehicles();
        renderWorkCarsModule();
        recalcWeekTotalsSoft();
      }
    }

    // =========================
    // Autos de trabajo
    // =========================
    function showWorkTab(tab){
      workTab = tab;
            const bHome = document.getElementById('workTabHome');
      const bGains = document.getElementById('workTabGains');
      const bDrivers = document.getElementById('workTabDrivers');

      if(bHome) bHome.classList.toggle('active', tab === 'home');
      if(bGains) bGains.classList.toggle('active', tab === 'gains');
      if(bDrivers) bDrivers.classList.toggle('active', tab === 'drivers');

      const pHome = document.getElementById('workHome');
      const pGains = document.getElementById('workGains');
      const pDrivers = document.getElementById('workDrivers');

      if(pHome) pHome.style.display = (tab === 'home') ? 'block' : 'none';
      if(pGains) pGains.style.display = (tab === 'gains') ? 'block' : 'none';
      if(pDrivers) pDrivers.style.display = (tab === 'drivers') ? 'block' : 'none';

      if(tab === 'home'){
        renderWorkCarsHome();
      }else if(tab === 'gains'){
        renderWorkGains();
      }else{
        renderWorkDrivers();
      }
    }

    function getWorkVehicles(){
      return (vehicles || []).filter(v => (v.category || 'Particular') === 'Trabajo');
    }

    
    // =========================
    // Choferes (Drivers)
    // =========================
    function saveDrivers(){
      localStorage.setItem('drivers', JSON.stringify(drivers || []));
    }

    function getDriverById(id){
      return (drivers || []).find(d => String(d.id) === String(id)) || null;
    }

    function getDriverByVehicleId(vehicleId){
      const vId = String(vehicleId);
      return (drivers || []).find(d => String(d.vehicleId || '') === vId) || null;
    }

    function getDriverNameForVehicle(vehicleId){
      const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
      const d = v && v.driverId ? getDriverById(v.driverId) : getDriverByVehicleId(vehicleId);
      return d ? (d.name || '') : '';
    }

    function populateDriverVehicleSelect(){
      const sel = document.getElementById('drvVehicle');
      if(!sel) return;
      const current = sel.value;
      const workCars = getWorkVehicles();
      sel.innerHTML = '<option value="">Sin asignar</option>' + workCars.map(v => {
        const title = (v.name || 'Veh√≠culo') + (v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : '');
        return `<option value="${v.id}">${title}</option>`;
      }).join('');
      if([...sel.options].some(o => o.value === current)) sel.value = current;
    }

    function unlinkDriverFromVehicle(vehicleId){
      const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
      if(v && v.driverId){
        const d = getDriverById(v.driverId);
        if(d) d.vehicleId = '';
      }
      if(v) delete v.driverId;
    }

    function linkDriverToVehicle(driverId, vehicleId){
      const d = getDriverById(driverId);
      if(!d) return;

      // Si el veh√≠culo ya ten√≠a chofer, lo desvinculamos
      if(vehicleId){
        const v = (vehicles || []).find(x => String(x.id) === String(vehicleId));
        if(v && v.driverId && String(v.driverId) !== String(driverId)){
          const prev = getDriverById(v.driverId);
          if(prev) prev.vehicleId = '';
        }
        if(v) v.driverId = driverId;
      }

      // Si el chofer estaba ligado a otro veh√≠culo, lo limpiamos
      if(d.vehicleId && vehicleId && String(d.vehicleId) !== String(vehicleId)){
        const oldV = (vehicles || []).find(x => String(x.id) === String(d.vehicleId));
        if(oldV && String(oldV.driverId) === String(driverId)) delete oldV.driverId;
      }

      d.vehicleId = vehicleId || '';
    }

    function resetDriverForm(){
      const form = document.getElementById('driverForm');
      if(form) form.reset();
      const id = document.getElementById('drvId');
      if(id) id.value = '';
      populateDriverVehicleSelect();
    }

    function fillDriverForm(d){
      document.getElementById('drvId').value = d ? String(d.id) : '';
      document.getElementById('drvName').value = d?.name || '';
      document.getElementById('drvPhone').value = d?.phone || '';
      document.getElementById('drvEmail').value = d?.email || '';
      document.getElementById('drvAddress').value = d?.address || '';
      document.getElementById('drvVehicle').value = d?.vehicleId ? String(d.vehicleId) : '';
      document.getElementById('drvStart').value = d?.startDate || '';
      document.getElementById('drvEnd').value = d?.endDate || '';
      document.getElementById('drvNotes').value = d?.notes || '';
      document.getElementById('refName').value = d?.refName || '';
      document.getElementById('refPhone').value = d?.refPhone || '';
    }

    function renderDriversList(){
      const list = document.getElementById('driversList');
      if(!list) return;
      if(!drivers || drivers.length === 0){
        list.innerHTML = '<div class="empty-state"><p>No hay choferes registrados.</p></div>';
        return;
      }

      list.innerHTML = drivers
        .slice()
        .sort((a,b) => (a.endDate ? 1 : 0) - (b.endDate ? 1 : 0))
        .map(d => {
          const v = d.vehicleId ? (vehicles || []).find(x => String(x.id) === String(d.vehicleId)) : null;
          const vLabel = v ? `${escapeHtml(v.name || 'Veh√≠culo')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}` : 'Sin asignar';
          const active = d.endDate ? 'Inactivo' : 'Activo';
          return `
            <div class="maintenance-item" style="gap:.75rem;">
              <div style="flex:1;">
                <div style="font-weight:900; color:#fff;">${escapeHtml(d.name || 'Chofer')}</div>
                <div style="color:rgba(255,255,255,0.75); font-weight:800; margin-top:.1rem;">
                  ${escapeHtml(active)} ‚Ä¢ Veh√≠culo: <b>${vLabel}</b>
                </div>
                ${d.phone ? `<div style="color:rgba(255,255,255,0.65); font-weight:800;">üì± ${escapeHtml(d.phone)}</div>` : ''}
                ${d.address ? `<div style="color:rgba(255,255,255,0.65); font-weight:800;">üìç ${escapeHtml(d.address)}</div>` : ''}
              </div>
              <div style="display:flex; flex-direction:column; gap:.5rem; min-width:170px;">
                <button class="btn btn-secondary" type="button" onclick="editDriver('${d.id}')">Editar</button>
                <button class="btn btn-danger" type="button" onclick="deleteDriver('${d.id}')">Eliminar</button>
              </div>
            </div>
          `;
        }).join('');
    }

    function editDriver(id){
      const d = getDriverById(id);
      if(!d) return;
      showWorkTab('drivers');
      populateDriverVehicleSelect();
      fillDriverForm(d);
      window.scrollTo({top: 0, behavior:'smooth'});
    }

    function deleteDriver(id){
      const d = getDriverById(id);
      if(!d) return;
      if(!confirm('¬øEliminar chofer?')) return;

      // Desvincular del veh√≠culo
      if(d.vehicleId){
        const v = (vehicles || []).find(x => String(x.id) === String(d.vehicleId));
        if(v && String(v.driverId) === String(d.id)) delete v.driverId;
      }

      drivers = (drivers || []).filter(x => String(x.id) !== String(id));
      saveDrivers();
      localStorage.setItem('vehicles', JSON.stringify(vehicles || []));
      resetDriverForm();
      renderDriversList();
      renderWorkCarsHome();
      renderWeekDetailCards();
    }

    function renderWorkDrivers(){
      populateDriverVehicleSelect();
      renderDriversList();
    }function renderWorkCarsModule(){
      if(!document.getElementById('workcars').classList.contains('active')) return;

      const monthInput = document.getElementById('gainsMonth');
      if(!monthInput.value){
        const now = new Date();
        monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }
      selectedMonthISO = monthInput.value;

      const weeks = computeWeeksForMonth(selectedMonthISO);
      if(!selectedWeekStartISO && weeks.length) selectedWeekStartISO = weeks[0].startISO;

      if(workTab === 'home') renderWorkCarsHome();
      else if(workTab === 'gains') renderWorkGains();
      else renderWorkDrivers();
    }

    function renderWorkCarsHome(){
      const grid = document.getElementById('workVehiclesGrid');
      const workCars = getWorkVehicles();

      if(workCars.length === 0){
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <b>Trabajo</b>.</p></div>';
      }else{
        grid.innerHTML = workCars.map(v => {
          const title = v.name || 'Veh√≠culo';
          const dname = getDriverNameForVehicle(v.id);
          const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}${dname ? ` ‚Ä¢ Chofer: ${escapeHtml(dname)}` : ''}`;
          return `
            <div class="work-card">
              <h4>${escapeHtml(title)}</h4>
              <p>${sub}</p>
              <span class="cat">Categor√≠a: Trabajo</span>
            </div>
          `;
        }).join('');
      }

      renderProfitabilityAllTime();
    }

    // ===== Semanas (Lunes‚ÜíDomingo) por mes =====
    function computeWeeksForMonth(monthISO){
      const [yy, mm] = monthISO.split('-').map(x => parseInt(x,10));
      const firstDay = new Date(yy, mm-1, 1);

      // primer lunes dentro del mes
      let d = new Date(firstDay);
      while(d.getDay() !== 1){
        d.setDate(d.getDate()+1);
      }

      const weeks = [];
      let idx = 1;

      while(d.getMonth() === (mm-1)){
        const start = new Date(d);
        const end = new Date(d);
        end.setDate(end.getDate() + 6);

        weeks.push({
          idx,
          startISO: ymd(start),
          endISO: ymd(end),
          start,
          end
        });

        idx++;
        d.setDate(d.getDate()+7);
      }

      return weeks;
    }

    // ‚úÖ FIX: prettyRange basado en parse local
    function prettyRange(startISO, endISO){
      const s = parseISODateLocal(startISO);
      const e = parseISODateLocal(endISO);
      return `${s.toLocaleDateString('es-MX')} ‚Üí ${e.toLocaleDateString('es-MX')}`;
    }

    function renderWorkGains(){
      const monthInput = document.getElementById('gainsMonth');
      monthInput.onchange = () => {
        selectedMonthISO = monthInput.value;
        const weeks = computeWeeksForMonth(selectedMonthISO);
        selectedWeekStartISO = weeks.length ? weeks[0].startISO : '';
        renderWorkGains();
      };

      selectedMonthISO = monthInput.value;
      const weeks = computeWeeksForMonth(selectedMonthISO);

      const weeksGrid = document.getElementById('weeksGrid');
      if(weeks.length === 0){
        weeksGrid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay semanas para este mes.</p></div>';
      }else{
        if(!selectedWeekStartISO) selectedWeekStartISO = weeks[0].startISO;

        weeksGrid.innerHTML = weeks.map(w => {
          const active = (w.startISO === selectedWeekStartISO);
          return `
            <div class="week-tile ${active ? 'active' : ''}" onclick="selectWeek('${w.startISO}')">
              <div class="wk-title">Semana ${w.idx}</div>
              <div class="wk-range">${prettyRange(w.startISO, w.endISO)}</div>
            </div>
          `;
        }).join('');
      }

      renderWeekDetailCards();
      scheduleWeekRefresh();
    }

    function selectWeek(weekStartISO){
      selectedWeekStartISO = weekStartISO;
      renderWorkGains();
    }

    // ‚úÖ FIX: rango de semana con parse local
    function getWeekRangeFromStartISO(weekStartISO){
      const s = parseISODateLocal(weekStartISO);
      const e = parseISODateLocal(weekStartISO);
      e.setDate(e.getDate() + 6);
      return { start:s, end:e, startISO: ymd(s), endISO: ymd(e) };
    }

    // ‚úÖ FIX: evaluaci√≥n por rango con parse local
    function isDateInRange(dateISO, start, end){
      if(!dateISO) return false;

      const d = parseISODateLocal(dateISO);
      if(!d) return false;

      const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const ss = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const ee = new Date(end.getFullYear(), end.getMonth(), end.getDate());
      return dd >= ss && dd <= ee;
    }

    function getMaintenanceInWeek(vehicleId, weekStartISO){
      const { start, end } = getWeekRangeFromStartISO(weekStartISO);
      const list = (maintenances && maintenances[vehicleId]) ? maintenances[vehicleId] : [];
      const filtered = list.filter(m => m && m.date && isDateInRange(m.date, start, end));
      const total = filtered.reduce((acc, m) => acc + safeNumber(m.cost), 0);
      return { items: filtered, total };
    }

    function getPayment(vehicleId, weekStartISO){
      const byWeek = workPayments[vehicleId] || {};
      const v = byWeek[weekStartISO];
      return (v === undefined || v === null) ? '' : String(v);
    }

    function setPayment(vehicleId, weekStartISO, valueStr){
      if(!workPayments[vehicleId]) workPayments[vehicleId] = {};
      const trimmed = String(valueStr ?? '').trim();

      let num = null;
      if(trimmed === ''){
        delete workPayments[vehicleId][weekStartISO];
      }else{
        num = safeNumber(trimmed);
        workPayments[vehicleId][weekStartISO] = num;
      }

      localStorage.setItem('workPayments', JSON.stringify(workPayments));

      // Sync a billetera (Ingreso -> Autos)
      syncWorkPaymentToWallet(vehicleId, weekStartISO, num);
    }

    function renderWeekDetailCards(){
      const workCars = getWorkVehicles();
      const cards = document.getElementById('gainCards');

      if(!selectedWeekStartISO){
        cards.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>Selecciona una semana.</p></div>';
        updateKPIs(0,0,0);
        renderProfitabilityWeek();
        return;
      }

      if(workCars.length === 0){
        cards.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos de <b>Trabajo</b>.</p></div>';
        updateKPIs(0,0,0);
        renderProfitabilityWeek();
        return;
      }

      const weekKey = selectedWeekStartISO;

      cards.innerHTML = workCars.map(v => {
        const title = v.name || 'Veh√≠culo';
        const dname = getDriverNameForVehicle(v.id);
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}${dname ? ` ‚Ä¢ Chofer: ${escapeHtml(dname)}` : ''}`;

        const m = getMaintenanceInWeek(v.id, weekKey);
        const payVal = getPayment(v.id, weekKey);

        const maintText = m.items.length
          ? ('<br>' + m.items.map(it => `‚Ä¢ ${(it.type || 'otro')} ‚Äî ${money(it.cost)} (${formatDateMX(it.date)})`).join('<br>'))
          : 'Sin mantenimientos en esta semana.';

        return `
          <div class="gain-card" data-vid="${v.id}">
            <h4>${escapeHtml(title)}</h4>
            <div class="gain-sub">${sub}</div>

            <div class="gain-label">Pago del chofer (esta semana)</div>
            <input
              class="pay-input"
              inputmode="numeric"
              autocomplete="off"
              placeholder="0"
              value="${escapeHtml(payVal)}"
              data-week="${weekKey}"
              data-vid="${v.id}"
              oninput="onPayInput(this)"
            />

            <div class="row-kv">
              <div>Mantenimientos (semana)</div>
              <div>${money(m.total)}</div>
            </div>

            <div class="row-kv" style="margin-top:.5rem;">
              <div>Ganancia real <small>Neto</small></div>
              <div class="net-val" id="net_${v.id}">${money(safeNumber(payVal) - m.total)}</div>
            </div>

            <div class="details">
              <div style="opacity:.9; font-weight:900; margin-top:.65rem;">Detalle mantenimientos:</div>
              ${maintText}
            </div>
          </div>
        `;
      }).join('');

      recalcWeekTotalsSoft();
      renderProfitabilityWeek();
    }

    function onPayInput(el){
      const vid = Number(el.dataset.vid);
      const wk = el.dataset.week;

      setPayment(vid, wk, el.value);

      recalcWeekTotalsSoft();
      scheduleAllTimeRefresh();
      scheduleWeekRefresh();
    }

    function updateKPIs(inTotal, outTotal, netTotal){
      document.getElementById('kpiIn').textContent = money(inTotal);
      document.getElementById('kpiOut').textContent = money(outTotal);
      document.getElementById('kpiNet').textContent = money(netTotal);
    }

    function recalcWeekTotalsSoft(){
      if(!document.getElementById('workcars').classList.contains('active')) return;
      if(workTab !== 'gains') return;
      if(!selectedWeekStartISO) return;

      const weekKey = selectedWeekStartISO;
      const workCars = getWorkVehicles();

      let totalIn = 0;
      let totalOut = 0;

      workCars.forEach(v => {
        const input = document.querySelector(`.pay-input[data-vid="${v.id}"][data-week="${weekKey}"]`);
        const pay = input ? safeNumber(input.value) : safeNumber(getPayment(v.id, weekKey));
        const m = getMaintenanceInWeek(v.id, weekKey);
        const net = pay - m.total;

        totalIn += pay;
        totalOut += m.total;

        const netEl = document.getElementById(`net_${v.id}`);
        if(netEl) netEl.textContent = money(net);
      });

      updateKPIs(totalIn, totalOut, totalIn - totalOut);
    }

    // =========================
    // Rentabilidad (pies) - dibujado
    // =========================
    function drawPie(canvas, entrada, salida){
      const ctx = canvas.getContext('2d');
      const w = canvas.width = 160;
      const h = canvas.height = 160;

      ctx.clearRect(0,0,w,h);

      const inVal = Math.max(0, safeNumber(entrada));
      const outVal = Math.max(0, safeNumber(salida));
      const total = inVal + outVal;

      const cx = w/2, cy = h/2, r = 62;

      ctx.beginPath();
      ctx.arc(cx,cy,r,0,Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fill();

      if(total <= 0){
        ctx.fillStyle = 'rgba(255,255,255,0.75)';
        ctx.font = '900 22px "Space Mono", monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('0%', cx, cy);
        return;
      }

      const start = -Math.PI/2;
      const inAng = (inVal/total) * Math.PI*2;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+inAng);
      ctx.closePath();
      ctx.fillStyle = '#3b82f6';
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start+inAng,start+Math.PI*2);
      ctx.closePath();
      ctx.fillStyle = '#f59e0b';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx,cy,40,0,Math.PI*2);
      ctx.fillStyle = 'rgba(10,14,39,0.85)';
      ctx.fill();

      const inPct = Math.round((inVal/total)*100);
      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.font = '900 26px "Space Mono", monospace';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(inPct + '%', cx, cy);
    }

    // =========================
    // Rentabilidad ALL TIME (hist√≥rico)
    // =========================
    let allTimeRAF = null;
    function scheduleAllTimeRefresh(){
      if(allTimeRAF) cancelAnimationFrame(allTimeRAF);
      allTimeRAF = requestAnimationFrame(() => {
        allTimeRAF = null;
        if(document.getElementById('workcars').classList.contains('active')){
          renderProfitabilityAllTime();
        }
      });
    }

    function sumAllPaymentsForVehicle(vehicleId){
      const byWeek = workPayments[vehicleId] || {};
      return Object.values(byWeek).reduce((acc, val) => acc + safeNumber(val), 0);
    }

    function sumAllMaintForVehicle(vehicleId){
      const list = (maintenances && maintenances[vehicleId]) ? maintenances[vehicleId] : [];
      return list.reduce((acc, m) => acc + safeNumber(m.cost), 0);
    }

    function renderProfitabilityAllTime(){
      const grid = document.getElementById('profitAllTimeGrid');
      if(!grid) return;

      const workCars = getWorkVehicles();
      if(workCars.length === 0){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <strong>Trabajo</strong>.</p></div>`;
        return;
      }

      let totalIn = 0;
      let totalOut = 0;

      const perCar = workCars.map(v => {
        const entrada = sumAllPaymentsForVehicle(v.id);
        const salida = sumAllMaintForVehicle(v.id);
        const neto = entrada - salida;
        totalIn += entrada;
        totalOut += salida;
        return { v, entrada, salida, neto };
      });

      const totalNet = totalIn - totalOut;

      const cards = [];

      cards.push(`
        <div class="profit-card">
          <div class="pie-wrap">
            <canvas id="pie_total"></canvas>
            <div class="pie-label">Total</div>
          </div>
          <div class="profit-meta">
            <div class="profit-title">Total (todos)</div>
            <div class="kv">
              <span><i class="dot-mini dot-in"></i>Entrada: ${money(totalIn)}</span>
              <span><i class="dot-mini dot-out"></i>Salida: ${money(totalOut)}</span>
              <span class="${totalNet < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(totalNet)}</span>
            </div>
          </div>
        </div>
      `);

      perCar.forEach(({v, entrada, salida, neto}, idx) => {
        const title = v.name || 'Veh√≠culo';
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}`;

        cards.push(`
          <div class="profit-card">
            <div class="pie-wrap">
              <canvas id="pie_${idx}"></canvas>
              <div class="pie-label">${escapeHtml(title)}</div>
            </div>
            <div class="profit-meta">
              <div class="profit-title">${escapeHtml(title)}</div>
              <div class="profit-sub">${sub}</div>
              <div class="kv">
                <span><i class="dot-mini dot-in"></i>Entrada: ${money(entrada)}</span>
                <span><i class="dot-mini dot-out"></i>Salida: ${money(salida)}</span>
                <span class="${neto < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(neto)}</span>
              </div>
            </div>
          </div>
        `);
      });

      grid.innerHTML = cards.join('');

      const cTotal = document.getElementById('pie_total');
      if(cTotal) drawPie(cTotal, totalIn, totalOut);

      perCar.forEach(({entrada, salida}, idx) => {
        const c = document.getElementById(`pie_${idx}`);
        if(c) drawPie(c, entrada, salida);
      });
    }

    // =========================
    // Rentabilidad por SEMANA
    // =========================
    let weekRAF = null;
    function scheduleWeekRefresh(){
      if(weekRAF) cancelAnimationFrame(weekRAF);
      weekRAF = requestAnimationFrame(() => {
        weekRAF = null;
        if(document.getElementById('workcars').classList.contains('active') && workTab === 'gains'){
          renderProfitabilityWeek();
        }
      });
    }

    function getWeekPaymentLive(vehicleId, weekStartISO){
      const input = document.querySelector(`.pay-input[data-vid="${vehicleId}"][data-week="${weekStartISO}"]`);
      if(input) return safeNumber(input.value);
      return safeNumber(getPayment(vehicleId, weekStartISO));
    }

    function renderProfitabilityWeek(){
      const grid = document.getElementById('profitWeekGrid');
      if(!grid) return;

      const workCars = getWorkVehicles();
      const weekKey = selectedWeekStartISO;

      if(!weekKey){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>Selecciona una semana para ver la rentabilidad visual.</p></div>`;
        return;
      }

      if(workCars.length === 0){
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><p>No hay autos marcados como <strong>Trabajo</strong>.</p></div>`;
        return;
      }

      let totalIn = 0;
      let totalOut = 0;

      const perCar = workCars.map(v => {
        const entrada = getWeekPaymentLive(v.id, weekKey);
        const m = getMaintenanceInWeek(v.id, weekKey);
        const salida = m.total;
        const neto = entrada - salida;
        totalIn += entrada;
        totalOut += salida;
        return { v, entrada, salida, neto };
      });

      const totalNet = totalIn - totalOut;

      const cards = [];

      cards.push(`
        <div class="profit-card">
          <div class="pie-wrap">
            <canvas id="week_pie_total"></canvas>
            <div class="pie-label">Total</div>
          </div>
          <div class="profit-meta">
            <div class="profit-title">Total (semana)</div>
            <div class="kv">
              <span><i class="dot-mini dot-in"></i>Entrada: ${money(totalIn)}</span>
              <span><i class="dot-mini dot-out"></i>Salida: ${money(totalOut)}</span>
              <span class="${totalNet < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(totalNet)}</span>
            </div>
          </div>
        </div>
      `);

      perCar.forEach(({v, entrada, salida, neto}, idx) => {
        const title = v.name || 'Veh√≠culo';
        const sub = `${escapeHtml(v.year || '‚Äî')} ‚Ä¢ ${escapeHtml(v.color || '‚Äî')}${v.plates ? ` ‚Ä¢ ${escapeHtml(v.plates)}` : ''}`;

        cards.push(`
          <div class="profit-card">
            <div class="pie-wrap">
              <canvas id="week_pie_${idx}"></canvas>
              <div class="pie-label">${escapeHtml(title)}</div>
            </div>
            <div class="profit-meta">
              <div class="profit-title">${escapeHtml(title)}</div>
              <div class="profit-sub">${sub}</div>
              <div class="kv">
                <span><i class="dot-mini dot-in"></i>Entrada: ${money(entrada)}</span>
                <span><i class="dot-mini dot-out"></i>Salida: ${money(salida)}</span>
                <span class="${neto < 0 ? 'net-neg' : ''}"><i class="dot-mini dot-net"></i>Neto: ${money(neto)}</span>
              </div>
            </div>
          </div>
        `);
      });

      grid.innerHTML = cards.join('');

      const cTotal = document.getElementById('week_pie_total');
      if(cTotal) drawPie(cTotal, totalIn, totalOut);

      perCar.forEach(({entrada, salida}, idx) => {
        const c = document.getElementById(`week_pie_${idx}`);
        if(c) drawPie(c, entrada, salida);
      });
    }

    // =========================
    // Alertas
    // =========================
    function showAlert(type, message){
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      const section = document.querySelector('.section.active');
      if(section) section.insertBefore(alertDiv, section.firstChild);

      setTimeout(()=> alertDiv.remove(), 3000);
    }

    // =========================
    // Init / Migraciones
    // =========================
    function migrateVehiclesCategoryIfMissing(){
      let changed = false;
      vehicles = (vehicles || []).map(v => {
        if(!v.category){
          changed = true;
          return { ...v, category:'Particular' };
        }
        return v;
      });
      if(changed) localStorage.setItem('vehicles', JSON.stringify(vehicles));
    }

    // ‚úÖ NUEVO: migraci√≥n para registros viejos (completed / completedDate)
    function migrateVerificationCompletedFields(){
      let changed = false;

      Object.keys(verifications || {}).forEach(vid => {
        const arr = verifications[vid];
        if(!Array.isArray(arr)) return;

        arr.forEach(r => {
          if(!r) return;
          if(typeof r.completed !== 'boolean'){ r.completed = false; changed = true; }
          if(typeof r.completedDate !== 'string'){ r.completedDate = ''; changed = true; }
        });
      });

      if(changed){
        localStorage.setItem('verifications', JSON.stringify(verifications));
      }
    }

    // ‚úÖ NUEVO: migraci√≥n para registros viejos de mantenimientos (completed/plannedDate)
    function migrateMaintenanceCompletedFields(){
      let changed = false;

      Object.keys(maintenances || {}).forEach(vid => {
        const arr = maintenances[vid];
        if(!Array.isArray(arr)) return;

        arr.forEach(r => {
          if(!r) return;

          // normalizar "completed"
          if(typeof r.completed !== 'boolean'){
            const v = r.completed;
            r.completed = (v === true || v === 1 || (typeof v === 'string' && v.toLowerCase() === 'true'));
            changed = true;
          }

          // si est√° completado y no tiene plannedDate, dejamos plannedDate vac√≠o (no afecta)
          if(r.completed === true && typeof r.plannedDate !== 'string'){
            // puede ser null, lo dejamos como null para indicar "no hab√≠a programaci√≥n"
            if(r.plannedDate !== null){
              r.plannedDate = null;
              changed = true;
            }
          }

          // si NO est√° completado y no tiene plannedDate, asumimos que la fecha es la programada
          if(r.completed === false && (!r.plannedDate || typeof r.plannedDate !== 'string')){
            if(r.date){
              r.plannedDate = r.date;
              changed = true;
            }
          }

          // normalizar date/plannedDate a ISO si vienen en DD/MM/YYYY
          if(r.date){
            const n1 = normalizeISODateString(r.date);
            if(n1 && n1 !== r.date){ r.date = n1; changed = true; }
          }
          if(r.plannedDate){
            const n2 = normalizeISODateString(r.plannedDate);
            if(n2 && n2 !== r.plannedDate){ r.plannedDate = n2; changed = true; }
          }
        });
      });

      if(changed){
        localStorage.setItem('maintenances', JSON.stringify(maintenances));
      }
    }


    // ‚úÖ NUEVO: limpieza de workPayments hu√©rfanos (evita "ganancias fantasmas" por ids antiguos)
    function cleanupWorkPaymentsOrphans(){
      const validIds = new Set((vehicles || []).map(v => String(v.id)));
      let changed = false;

      Object.keys(workPayments || {}).forEach(vid => {
        if(!validIds.has(String(vid))){
          delete workPayments[vid];
          changed = true;
        }
      });

      if(changed){
        localStorage.setItem('workPayments', JSON.stringify(workPayments));
      }
    }

    migrateVehiclesCategoryIfMissing();
    migrateVerificationCompletedFields();
    migrateMaintenanceCompletedFields();
    cleanupWorkPaymentsOrphans();
    cleanupOrphanData();
    setupCarPhotoUploader();
    setupEditCarPhotoUploader();

    renderVehicles();
    renderDashboard();
    checkVerificationAlerts();

    // ‚úÖ FIX: "hoy" en local, sin toISOString (evita -1 d√≠a)
    const today = ymd(new Date());
    const vDate = document.getElementById('verificationDate');
    const mDate = document.getElementById('maintenanceDate');
    if(vDate) vDate.value = today;
    if(mDate) mDate.value = today;

    const monthInput = document.getElementById('gainsMonth');
    if(monthInput){
      const now = new Date();
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      selectedMonthISO = monthInput.value;
      const weeks = computeWeeksForMonth(selectedMonthISO);
      selectedWeekStartISO = weeks.length ? weeks[0].startISO : '';
    }

    // Inicializar paletas de color de Veh√≠culos
    try{ initVehicleColorPalettes(); }catch(e){}

  </script>
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>


<script>
/* DASHBOARD_SALDO_DESDE_2026 */
(function(){
  function parseDateSafe(v){
    if(!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  function calcularSaldoDesde2026(){
    try{
      const inicio = new Date("2026-01-01T00:00:00");
      const tx = JSON.parse(localStorage.getItem("walletTx") || "[]"); // fuente real de Billetera
      let saldo = 0;

      for(const t of tx){
        const fecha = parseDateSafe(t.date || t.fecha || t.createdAt || t.timestamp);
        if(!fecha || fecha < inicio) continue;

        const tipo = String(t.type || t.tipo || "").toLowerCase(); // 'in' | 'out'
        const monto = Number(t.amount ?? t.monto ?? 0) || 0;

        if(tipo === "in") saldo += monto;
        else if(tipo === "out") saldo -= monto;
      }

      const el = document.getElementById("dashboardSaldo2026") || document.getElementById("dashboard");
      if(el){
        el.textContent = saldo.toLocaleString("es-MX",{style:"currency",currency:"MXN"});
      }
    }catch(e){
      console.error("Saldo dashboard error:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", calcularSaldoDesde2026);
  window.addEventListener("storage", (ev)=>{
    if(ev.key === "walletTx") calcularSaldoDesde2026();
  });
  document.addEventListener("walletUpdated", calcularSaldoDesde2026);
})();
</script>

</body>
</html>

